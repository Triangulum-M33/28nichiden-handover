%% Generated by Sphinx.
\def\sphinxdocclass{jsbook}
\documentclass[letterpaper,10pt,dvipdfmx]{sphinxmanual}
\ifdefined\pdfpxdimen
   \let\sphinxpxdimen\pdfpxdimen\else\newdimen\sphinxpxdimen
\fi \sphinxpxdimen=49336sp\relax

\usepackage[margin=1in,marginparwidth=0.5in,dvipdfm]{geometry}


\usepackage{cmap}
\usepackage[T1]{fontenc}
\usepackage{amsmath,amssymb,amstext}

\usepackage{times}

\usepackage{longtable}
\usepackage{sphinx}

\usepackage{multirow}
\usepackage{eqparbox}

% Include hyperref last.
\usepackage{hyperref}
% Fix anchor placement for figures with captions.
\usepackage{hypcap}% it must be loaded after hyperref.
% Set up styles of URL: it should be placed after hyperref.
\urlstyle{same}
\renewcommand{\contentsname}{目次:}

\renewcommand{\figurename}{図}
\renewcommand{\tablename}{TABLE}
\renewcommand{\literalblockname}{LIST}

\def\pageautorefname{ページ}

\setcounter{tocdepth}{1}



\title{Nichiden Documentation}
\date{3月 25, 2017}
\release{0.1}
\author{Kenichi Ito}
\newcommand{\sphinxlogo}{}
\renewcommand{\releasename}{リリース}
\makeindex

\begin{document}

\maketitle
\sphinxtableofcontents
\phantomsection\label{\detokenize{index::doc}}



\chapter{東京大学地文研究会天文部 日電引き継ぎ}
\label{\detokenize{main::doc}}\label{\detokenize{main:id1}}\begin{itemize}
\item {} 
更新: 2017/03/04 Kenichi Ito(nichiden\_27)

\end{itemize}

日電の引き継ぎ文書です。ソースは全て公開しますので、ご自由に修正・追記してください。
\begin{figure}[htbp]
\centering
\capstart

\noindent\sphinxincludegraphics{{88x31}.png}
\caption{Creative Commons Attribution-ShareAlike 3.0 Unported License}\label{\detokenize{main:id8}}\end{figure}


\section{冒頭部の情報について}
\label{\detokenize{main:id2}}
各資料の冒頭部分には、「書いた人」「更新日時」「実行に必要な知識・技能」「タスクの重さ
or 難易度」「タスクの必須度 or
情報の必須度」といった項目が示されています。


\section{実行に必要な知識・技能}
\label{\detokenize{main:id3}}
資料で解説しているタスクや知識を実践するのに必要な知識などです。
自分が理解できそうな資料を探したり、作業をするために何を身につけるべきか判断したりする際に参考にしてください。


\section{タスクの重さ}
\label{\detokenize{main:id4}}
タスク関連の記事に付いています。
\begin{itemize}
\item {} 
1: 数時間で可能

\item {} 
2: 数日かかる

\item {} 
3: 数週間

\item {} 
4: 一月はかかる

\item {} 
5: 準備だけで数ヶ月

\end{itemize}

の5段階です。作業計画を立てる際などにご覧ください。

ただし、各代の方針によって、個々のタスクの重さは変動することに注意しましょう。


\section{難易度}
\label{\detokenize{main:id5}}
技術情報などをまとめた記事に付いています。
\begin{itemize}
\item {} 
1: 常識の範囲

\item {} 
2: 少しやれば可能

\item {} 
3: 練習・勉強が必要

\item {} 
4: 分野に慣れてればできる

\item {} 
5: 得意分野ならどうぞ

\end{itemize}

学んでおきたい分野の大枠を掴むのに利用してください。


\section{タスクの必須度}
\label{\detokenize{main:id6}}
タスク関連の記事に付いています。
\begin{itemize}
\item {} 
1: よほど暇なら

\item {} 
2: たまにやるべき

\item {} 
3: 年による

\item {} 
4: 毎年やるべき

\item {} 
5: しないとプラネ終了

\end{itemize}

今年の日電で何をやるか決める手助けになるかもしれません。


\section{情報の必須度}
\label{\detokenize{main:id7}}
技術情報などをまとめた記事に付いています。
\begin{itemize}
\item {} 
1: 趣味レベル

\item {} 
2: 知ってると楽

\item {} 
3: 必要な場合がある

\item {} 
4: 担当者には必須

\item {} 
5: 全員必須

\end{itemize}


\chapter{プロジェクト マネジメント}
\label{\detokenize{management::doc}}\label{\detokenize{management:id1}}\begin{itemize}
\item {} 
書いた人: Kenichi Ito(nichiden\_27)

\item {} 
更新日時: 2017/02/18

\item {} 
実行に必要な知識・技能: 特になし

\item {} 
タスクの重さ: 3/数週間

\item {} 
タスクの必須度: 4/毎年やるべき

\end{itemize}


\section{概要}
\label{\detokenize{management:id2}}
日電長向けの内容です。日電の仕事をどう進めていくかなどを書きます。


\section{チーム編成}
\label{\detokenize{management:id3}}

\subsection{連絡手段を決める}
\label{\detokenize{management:id4}}
27ではSlackを使用した。日電は作業内容が多岐にわたるため、一つのチャットグループでは話題が混乱してしまう。
LINEでも多数のグループを立てることで対応はできるが、管理が困難になるので最初からチームチャットを導入しておくことをお勧めする。

以下は27Slackの最終的なチャンネル構成である。

\begin{sphinxVerbatim}[commandchars=\\\{\}]
\PYG{c+c1}{\PYGZsh{}acrab ... 星座絵アプリ}
\PYG{c+c1}{\PYGZsh{}dome ... ドームコンソール}
\PYG{c+c1}{\PYGZsh{}general ... 総合}
\PYG{c+c1}{\PYGZsh{}ginga ... ぎんとう}
\PYG{c+c1}{\PYGZsh{}haisen ... 配線}
\PYG{c+c1}{\PYGZsh{}hojyotou ... 補助投}
\PYG{c+c1}{\PYGZsh{}ittou ... いっとう}
\PYG{c+c1}{\PYGZsh{}log ... 活動記録}
\PYG{c+c1}{\PYGZsh{}nissyu\PYGZhy{}idohen ... 日周緯度変}
\PYG{c+c1}{\PYGZsh{}notifications ... 通知を流す用}
\PYG{c+c1}{\PYGZsh{}parts ... 部品管理}
\PYG{c+c1}{\PYGZsh{}piscium ... 星座絵無線機}
\PYG{c+c1}{\PYGZsh{}random ... 雑談}
\PYG{c+c1}{\PYGZsh{}seizae ... 星座絵}
\end{sphinxVerbatim}

Slackの特徴の一つに、他のWebサービスとの豊富な連携がある。
27では、ToDoリストを共有できるTrelloやGitHubを使用した。通知がSlackで一覧できるので、進捗の共有が簡単になる。

余裕があれば、進捗を煽るBotなどを作成しても面白いかもしれない。


\subsection{目標を設定する}
\label{\detokenize{management:id5}}
日電のやることは毎年そう変わらないが、できれば先年までと違うことに挑戦するとよい。
ただし、新しい製品や機能には不具合や故障が付き物
であり、早期に目標を設定して動き始めることが重要だ。

前年度までに壊れてしまったものや、部員・観客へのインタビューで不満が多く寄せられた部分などが、新たな目標の候補となるだろう。


\subsection{担当を決める}
\label{\detokenize{management:id6}}
日電の仕事の特質は、\sphinxstylestrong{種類が多く、それぞれの作業は個人作業になりやすい}
ことである。
また人数も限られているので、各自の責任感を高める意味でも早期に担当を振っておくべきだろう。
これには、日電員が作業に向けて勉強するにあたり、個々の課題を明確にするという利点もある。


\subsection{スケジュールを決める}
\label{\detokenize{management:id7}}
進捗は必ず遅れるものだが、だからと言ってスケジュールを切らずに闇雲に進めるのは大変危険である。
最低限、どの期間に何をするかの大枠は示しておきたい。27日電での例は以下の通り。
\begin{itemize}
\item {} 
準備期間 〜8/1(Sセメ試験)

\item {} 
試作期間 8/2〜9/25(夏休み終了)

\item {} 
製作期間 9/26〜10/31

\item {} 
動作試験 11/1〜11/24(駒場祭前日)

\end{itemize}

もちろん、実際の作業に入った後の進捗の把握や再検討は、日電長が随時やっておく必要がある。


\section{作業が始まったら}
\label{\detokenize{management:id8}}

\subsection{夜間}
\label{\detokenize{management:id9}}
日電は個人プレーが多いので夜間への参加は必須ではないが、他の投影機は随時日電のサポートを必要とするので最低一人は出ておくのが望ましい。

また、作業で得られた進捗は、\sphinxstylestrong{箇条書きなどにまとめて日電全員に報告}
するとよい。
作業に参加していないメンバーが現状を把握できる上、日電長自身も進捗を目に見える形で確認できる。


\subsection{卒検・リハ}
\label{\detokenize{management:id10}}
卒検やリハでは、ドームを膨らませて投影機を配置し、点灯させる。
この間の配線は日電が全て行うので、大変仕事が多くかつ責任が重い。
この二日間だけは \sphinxstylestrong{日電メンバーを全員揃える} のが重要だ。
前々から日程は判明しているはずなので、各自の予定を確認しておこう。


\chapter{日周緯度変(日周緯度変換機構)}
\label{\detokenize{nissyu-idohen/kikou::doc}}\label{\detokenize{nissyu-idohen/kikou:id1}}\begin{itemize}
\item {} 
書いた人: Kenichi Ito(nichiden\_27)

\item {} 
更新日時: 2017/03/03

\item {} 
実行に必要な知識・技能: 歯車機構

\item {} 
タスクの重さ: 5/準備だけで数ヶ月

\item {} 
タスクの必須度: 2/たまにやるべき

\item {} 
元資料

\item {} 
\sphinxcode{saitama.pdf} by 荒田 実樹(nichiden\_23)

\end{itemize}


\section{概要}
\label{\detokenize{nissyu-idohen/kikou:id2}}
日電の正式名称「日周緯度変・電源パート」から分かる通り、日電の本来の任務は日周緯度変装置を動作させることです。この記事では、日周緯度変装置自体に関しての情報をまとめます。


\section{構成}
\label{\detokenize{nissyu-idohen/kikou:id3}}
日周緯度変の役割は、プラネタリウムにおいて日周運動を再現する、あるいは(仮想的な)観測地の緯度を変更することである。なお、天文部の現在のプラネタリウムには歳差軸はない。

日周緯度変は大きく
\begin{itemize}
\item {} 
日周ギヤボックス

\item {} 
緯度変ギヤボックス

\end{itemize}

の2つに分かれ、それぞれに対応するステッピングモーターが搭載されている。

このステッピングモーターは一個数万円するものだが、本番中に劣化するので数年おきに買い換えられている。高価な割に\sphinxstylestrong{ケーブルが切れやすい}
ので、取り扱う際は十分な注意を要する。

ギヤボックスはどちらも\sphinxstylestrong{10年以上前に製作された}
ものである。製作年度に関して確かと言える情報は見つかっていないが、緯度は1994年の05主投、日周は2000年前後で製作されたようだ。

これほどの機構を再現できる技術が失われたため、かなりの長期間作り変えられていない。ただし、いつかは必ず壊れてしまうものであり、\sphinxstylestrong{なるべく早期に予備を製作すべき}
だろう。日周緯度変の製作に成功すれば、天文部の歴史に名が残ることは間違いない。

特に緯度変に関しては、軸が摩耗していたり、ギアの噛み合わせが悪かったりして、
緯度を動かし続けるとある角度でかごしい全体が「揺れる」ことがある。この点は早急に改善が必要である。

ギヤボックス周辺の可動部分には\sphinxstylestrong{定期的にグリスを塗るか、潤滑油を差しておく}
ことが望ましい。ただし2017年現在、機構部分の保守作業の大部分は、\sphinxstylestrong{かごしいの作業の過程で行われている。}
ごきぶりやしいたけとの接続も彼らの方がより把握しているはずなので、任せておいて問題はないだろう。


\section{歯車機構と減速比}
\label{\detokenize{nissyu-idohen/kikou:id4}}
日周緯度変を自在に操るには各ギヤ比を知っておく事が必要である。

もちろん実物を見れば調べられるのだが、それなりに面倒だったので同じ手間を繰り返さないよう図に各ギヤの歯の数を載せておく。また、「正の向き(時計回り)」にモーターを回した時に各ギヤがどちら向きに回るかも載せておく。
\begin{figure}[htbp]
\centering
\capstart

\noindent\sphinxincludegraphics{{nissyuuidohen_gear}.png}
\caption{日周緯度変のギヤ構成}\label{\detokenize{nissyu-idohen/kikou:id6}}\end{figure}

図に書いてあるギヤの歯の数からギヤ比を計算すると、
\begin{equation*}
\begin{split}\begin{aligned}
\frac{1}{80}\times\frac{25}{80}\times\frac{18}{64}=\frac{9}{8192}
&&\text{緯度変} \\
\frac{1}{50}\times\frac{20}{100}=\frac{1}{250}
&&\text{日周}\end{aligned}\end{split}
\end{equation*}
となる。なお、これらのギヤの歯の数は動かしながら手で数えたので、もしかすると数え間違いがあるかもしれない。あまり過信しないよう。

つまり、各軸をある角速度で回したい場合、緯度変の場合は\sphinxcode{8192/9}を、日周の場合は\sphinxcode{250}をそれぞれ掛ければモーターが出力すべき角速度が求まる。日周緯度変関連のソースコードで8192や250といった定数が登場するのは、この減速比の変換をするためである。


\section{モーターの角速度}
\label{\detokenize{nissyu-idohen/kikou:id5}}
ステッピングモーターは速度を自由に設定できるが、もちろん上限はある。緯度変更モジュール単体で試したところ、緯度モーターの最高角速度は\(3500 deg/s\)程度であった。

この速度をかごしいの速度に換算すると \(3500/(8192/9)=3.84 deg/s\)
となる。1度動かすのに0.26秒、南北の反転に46.8秒ほどという計算だ。

ただし、この\(3500 deg/s\)という速度は速度を徐々に上げていった場合の最高速度であり、停止した状態から回転させる場合は\(1800 deg/s\)程度が限度だと思われる。この場合かごしいの速度は\(1800/(8192/9)=1.98 deg/s\)となり、1度動かすのに0.5秒、南北反転には1分半かかることになる。

また、実際にかごしいを載せた場合や、主投影機を全て設置した場合など、回すものの重量によってさらに実際の速度は低下するので注意すること。


\chapter{日周緯度変(さいたま)}
\label{\detokenize{nissyu-idohen/saitama::doc}}\label{\detokenize{nissyu-idohen/saitama:id1}}\begin{itemize}
\item {} 
書いた人: Kenichi Ito(nichiden\_27)

\item {} 
更新日時: 2017/02/26

\item {} 
実行に必要な知識・技能: AVRマイコン、電子回路

\item {} 
タスクの重さ: 3/数週間

\item {} 
タスクの必須度: 3/年による

\item {} 
元資料

\item {} 
\sphinxcode{日周・緯度変資料.pdf} by 岩滝宗一郎(nichiden\_22)

\item {} 
\sphinxcode{saitama.pdf} by 荒田 実樹(nichiden\_23)

\end{itemize}


\section{概要}
\label{\detokenize{nissyu-idohen/saitama:id2}}
　　　　　　　　　　　　　　　　＼　\textbar{}　／
　　　　　　　　　　　　　　　　　／￣＼　　 ／￣￣￣￣￣￣￣￣￣
　　　　　　　　　　　　　　　-（ ﾟ ∀ ﾟ ）＜　さいたまさいたま！
　　　　　　　　　　　　　　　　　＼＿／　　 ＼＿＿＿＿＿＿＿＿＿
　　　　　　　　　　　　　　　　／　\textbar{}　＼
　　　　　　　　　　　　　　　　　　　 ∩ ∧　∧　　／￣￣￣￣￣￣￣￣￣￣
￣￣￣￣￣￣￣￣＼∩ ∧　∧　＼（ ﾟ∀ﾟ）＜　さいたまさいたまさいたま！
さいたま～～～！ 　 ＞（ ﾟ∀ﾟ ）/ ｜　　　　/　＼＿＿＿＿＿＿＿＿＿＿
＿＿＿＿＿＿＿＿／ ｜　　　 〈　｜　　　｜
/　／＼\_」　/　／＼」 　　　　　　　　　　　　　 ￣　　　　 / ／

日周緯度変コントローラ「さいたま」の使い方や仕組みなどを説明します。壊れて部品交換が必要になった・新しいさいたまを作りたい際に参照してください。


\section{沿革}
\label{\detokenize{nissyu-idohen/saitama:id3}}
日周緯度変のステッピングモーターを回すには、モータドライバという回路が必要になる。駒場祭プラネではモータドライバと制御基板を内蔵した専用コントローラーを使っており、2002年の\href{http://twitter.com/fujita\_d\_h/status/254087988882046976}{13日周以降}今日に至るまで\sphinxstylestrong{「さいたま」}
と呼ばれている。

「さいたま」や他の回路に使用するマイコンは長らくPICであったが、22日電で\sphinxstylestrong{AVR}
が採用され、23日電、24日電でもこれを踏襲した。PIC時代はほとんどのプログラムがアセンブラで書かれていたが、AVRを使うようになってからはC言語が使われるようになった。

さいたまはたびたび作り変えられてきたが、現在使用しているのは22が製作した\sphinxstylestrong{さいたま6號}
である。23は、さいたまをPCから制御するための装置「Ikebukuro」を導入した(Ikebukuroの資料参照)。24では基板を作り直し、その際マイコンを\sphinxstylestrong{ATmega}
に変更したようだ。


\section{使い方}
\label{\detokenize{nissyu-idohen/saitama:id4}}\begin{figure}[htbp]
\centering
\capstart

\noindent\sphinxincludegraphics{{saitama_connection}.jpg}
\caption{さいたま6號と電源装置を接続している様子}\label{\detokenize{nissyu-idohen/saitama:id9}}\end{figure}

背面に日周・緯度用に二つのコネクタがあるので、専用ケーブル※を使ってそれぞれのモータに繋ぐ。次に、モータの電力を確保するため、電源装置から\sphinxstylestrong{24V}
を右面のDCジャックから供給しよう。

※コネクタはELコネクタ(日本圧着)6極、ケーブルはVCTF0.5sq 5芯
\begin{figure}[htbp]
\centering
\capstart

\noindent\sphinxincludegraphics{{saitama_buttons}.png}
\caption{さいたま6號のボタン配置図}\label{\detokenize{nissyu-idohen/saitama:id10}}\end{figure}

コントローラ前面には6つのスイッチがある。現在では外部制御でPCから動かす方がはるかに便利だが、PCが使えない緊急時や急いでいるときはこのスイッチを使えばよい。

ラベルを参照すれば大体の意味は分かることだろう。回転のON/OFFと方向はそれぞれの軸で独立しているが、回転速度は2軸で変えることはできない。\sphinxcode{外部制御ON/OFF}スイッチは、PCから操作したい場合にONにする。これがONになっているときは、さいたま側のスイッチに反応しなくなるので気をつけよう。


\section{電装}
\label{\detokenize{nissyu-idohen/saitama:id5}}
ケースの両側に付いているねじを全て外すと、さいたまの中身を確認できる。
\begin{figure}[htbp]
\centering
\capstart

\noindent\sphinxincludegraphics{{saitama_internal}.jpg}
\caption{さいたま6號の内部}\label{\detokenize{nissyu-idohen/saitama:id11}}\end{figure}
\begin{itemize}
\item {} 
メイン基板

\item {} 
\sphinxstylestrong{画像は23引き継ぎのものだが、この翌年に作り変えられているので注意}

\item {} 
マイコンがスイッチの状態を読取り、モータードライバにCW・CCWパルスを送信する

\item {} 
基板に付いていたスイッチはあまり重要でなかったため、基板作り変えの際取り除かれた模様

\item {} 
2×3のピンヘッダは、AVRマイコンにプログラムを書き込むためのもの

\item {} 
モータードライバ基板

\item {} 
CW・CCWパルスに応じてステッピングモータに電流を流す

\item {} 
既製品。割と高価だが、部室に未使用の買い置きがある

\item {} 
スイッチ基板

\item {} 
トグルスイッチが配置されている

\item {} 
普通に使っている場合一番壊れやすい部分なのでたまに異常がないか見てあげよう

\end{itemize}


\section{プログラム}
\label{\detokenize{nissyu-idohen/saitama:id6}}
23代が\sphinxcode{nissyuido}ディレクトリ以下に使用したソースコードを残している。\sphinxcode{WinAVR}環境があれば\sphinxcode{default}ディレクトリに移動して\sphinxcode{make}コマンドを打てばビルドされるとのことだ。

ただし、前述の通り\sphinxstylestrong{24代でマイコンをATmega328Pに変更}
しており、以前のコードを使用できるかは定かでない。作り変えをする際は、24代の方に問い合わせてみることも検討されたい。

以下のプログラム解説は、23荒田氏の作成されたドキュメントと同内容である。必要なら氏のPDFや、コード中のコメントなども併せて確認すると良いだろう。


\subsection{main.c}
\label{\detokenize{nissyu-idohen/saitama:main-c}}\begin{figure}[htbp]
\centering
\capstart

\noindent\sphinxincludegraphics{{saitama_program_flow}.png}
\caption{プログラムの流れ\textgreater{}}\label{\detokenize{nissyu-idohen/saitama:id12}}\end{figure}

プログラムの起点となる \sphinxcode{main} 関数が入っている。
プログラムの大まかな流れは図を参照。

プログラムは初期化(\sphinxcode{main.c} の
\sphinxcode{init}関数)の後、メインループ(無限ループ)に入る。ただ、初期化の時にタイマ割り込みを設定しているため、100マイクロ秒ごとに現在メインループで実行されている内容に関係なく「タイマ割り込み」の内容が実行される。

メインループの処理内容は \sphinxcode{main.c} を、「タイマ割り込み」の処理内容は
\sphinxcode{motordrive.c} を参照されたい。

外部制御コマンドのフォーマットはここで処理している。


\subsection{motordrive.c}
\label{\detokenize{nissyu-idohen/saitama:motordrive-c}}
ここが最も重要な部分である。
ステッピングモーターのドライブ回路に定期的にパルスを送り、指定した速度でモーターを回す。

モーターを角速度\(Speed\)(コード中では\sphinxcode{m-\textgreater{}current\_speed} \([deg/s]\))で回すにはどうすればよいか考えてみよう。一回のパルスでモーターが回転する角度はモーターとドライブ回路によって決まっており、\(\mathrm{MotorStep}=0.72 \mathrm{deg}\)(コード中では\sphinxcode{MOTOR\_STEP} \([10^{-2}deg]\))である。

AVRのタイマ機能により、\sphinxcode{motordrive}関数は\(\mathrm{ControlPeriod}=100 \mu\mathrm{s}\)
(コード中では\sphinxcode{CONTROL\_PERIOD} \([\mu\mathrm{s}]\))間隔で呼ばれる。
前回パルスを送ってからの経過時間を\(n\cdot\mathrm{ControlPeriod}\)とする(前回パルスを送ってから\(n\)回目の\sphinxcode{motordrive}の呼び出し;
\(n\)はコード中では\sphinxcode{m-\textgreater{}count})。

このとき、簡単な考察により、\(n\cdot\mathrm{ControlPeriod}\cdot\mathrm{Speed}\ge\mathrm{MotorStep}\)の時に次のパルスを送ればよいことが分かる。

実際には、速度指定モード・角度指定モードがあったり、速度を徐々に変化させる処理を行っているので、もう少し複雑なプログラムになっている。

「速度を徐々に変化させる処理」であるが、今のところ、現在の速度と目標速度が一致しなければ一定の加速度を加えるという、比較的単純な制御になっている。
時間と速度をグラフで表すと図のようになる。赤線が指定した速度、青線が実際の速度である。このように速度を徐々に変化させるようにプログラムの改修を行ったので、もはや\sphinxstylestrong{「一旦回転を停止してから回転方向を変更する」必要はない。}
\begin{figure}[htbp]
\centering
\capstart

\noindent\sphinxincludegraphics{{saitama_program_speed}.png}
\caption{速度変化}\label{\detokenize{nissyu-idohen/saitama:id13}}\end{figure}

角度指定モードの、速度を下げ始めるタイミングについて。

プログラムが実行されている時点を時刻\(t_0\)とし、時刻\(t_1\)にモーターが停止するとする。
モーターの\(t_0\)における角速度を\(\omega_0\)とする。単位時間当たりのモーターの角速度の変化を
\(\alpha\)とする。現在のプログラムでは、\sphinxcode{motordrive}が呼ばれるたびに速度を\(1 \mathrm{deg/s}\)ずつ増減するので、
\begin{equation*}
\begin{split}\alpha=\pm\frac{1 \mathrm{deg/s}}{\mathrm{ControlPeriod}}\end{split}
\end{equation*}
である。モーターの時刻\(t\)における角度(位置)を\(\theta(t)\)とする。

時刻\(t\)におけるモーターの角速度と角度はそれぞれ
\begin{equation*}
\begin{split}\begin{aligned}
\omega(t)&=\omega_0+\alpha(t-t_0) \\
\theta(t)&=\theta(t_0)+\omega_0(t-t_0)+\frac{1}{2}\alpha(t-t_0)^2\end{aligned}\end{split}
\end{equation*}
となる。
時刻\(t_1\)にモーターが停止、すなわち\(\omega(t_1)=0\)より、
\begin{equation*}
\begin{split}t_1-t_0=-\frac{\omega_0}{\alpha}\end{split}
\end{equation*}
である。これを\(\theta(t_1)\)に代入すると、
\begin{equation*}
\begin{split}\begin{aligned}
\theta(t_1)&=\theta(t_0)-\frac{\omega_0^2}{\alpha}
+\frac{1}{2}\alpha\left(-\frac{\omega_0}{\alpha}\right)^2 \\
%&=\theta(t_0)+\left(-\frac{1}{\alpha}+\frac{1}{2\alpha}\right)\omega_0^2 \\
&=\theta(t_0)-\frac{1}{2\alpha}\omega_0^2\end{aligned}\end{split}
\end{equation*}
を得る。

求めたい量は、現在角がどういう値になったら速度を下げ始めるか、その角度である。
つまり、\(\theta(t_1)-\theta(t_0)\)の値である:
\begin{equation*}
\begin{split}\begin{aligned}
\theta(t_1)-\theta(t_0)&=-\frac{1}{2\alpha}\omega_0^2 \\
&=\frac{1}{2\left(\frac{1 \mathrm{deg/s}}{\mathrm{ControlPeriod}}\right)}\omega_0^2 \\
&=\frac{\mathrm{ControlPeriod}}{2(1 \mathrm{deg/s})}\omega_0^2\end{aligned}\end{split}
\end{equation*}
ステップ数に換算するために両辺を\(\mathrm{MotorStep}\)で割ると、
\begin{equation*}
\begin{split}\frac{\theta(t_1)-\theta(t_0)}{\mathrm{MotorStep}}
=\frac{\mathrm{ControlPeriod}}{2(1 \mathrm{deg/s})\mathrm{MotorStep}}\omega_0^2\end{split}
\end{equation*}
を得る。

なお、コード中では\(\frac{\mathrm{MotorStep}}{\mathrm{ControlPeriod}}\)に\sphinxcode{MOTOR\_MAX\_SPEED}という名前を与えている。


\subsection{uart.c}
\label{\detokenize{nissyu-idohen/saitama:uart-c}}
外部とシリアル通信するための関数が記述されている。通信データのバッファリングを行っているが、この仕組みが正常に動いているかは検討の余地がある。


\subsection{timer.c}
\label{\detokenize{nissyu-idohen/saitama:timer-c}}
\sphinxcode{motordrive}関数を\(100\mu s\)間隔で呼び出すための設定を行う。
ぶっちゃけ、\sphinxcode{motordrive}関数をそのままタイマ割り込みハンドラにし
ても良い気がする。


\subsection{コンパイルするには}
\label{\detokenize{nissyu-idohen/saitama:id7}}
ソースコードを編集したら、書き込む前にコンパイルする必要がある。\sphinxcode{default}ディレクトリ以下に\sphinxcode{Makefile}が入っているので、\sphinxcode{Makefile}の意味が分かる人は利用すると良いだろう。

Makefileの意味が分からない人は、Atmel
Studioだか何だか知らないが、適当にプロジェクトを作ってファイルを放り込んでコンパイルすればよろしい。その際、
\begin{itemize}
\item {} 
マイコンの種類は ATmega328P

\item {} 
クロック周波数は 16MHz:
プリプロセッサの設定をいじって、\sphinxcode{F\_CPU=16000000UL}がpredefinedになるようにする。(コンパイラオプションとして\sphinxcode{-DF\_CPU=16000000UL}が渡されればOK)

\item {} 
言語規格はC99+GNU拡張(コンパイラオプションとして\sphinxcode{-std=gnu99}が渡されればOK)

\end{itemize}

となるように注意する。


\section{今後の展望}
\label{\detokenize{nissyu-idohen/saitama:id8}}
もしもさいたまを作り替えるようなら、もう少し強力なマイコンを搭載すること、センサー(後述)対応にすること、\sphinxstylestrong{通信経路}
についてもっとしっかり考えること(\sphinxcode{RS-485}にするのか、全部\sphinxcode{RS-232}とUSBシリアル通信で統一するのか)が望ましい。

23代で相対角度指定が実装されたが(現在使われていない)、\sphinxstylestrong{絶対角度指定}
があると良いだろう。つまり、投影される星空を見ながら日周緯度変を操作するのではなく、「緯度は何度、日周は何月何日何時」という形で指定できるようにする。

絶対角度指定のためには、角度センサーを設置して現在位置を取得するか、一ヶ所にフォトインタラプタなどを設置して初期位置を判別できるようにして、後はステッピングモーターのステップ数で現在位置を把握する、などの方法が考えられる。

いずれにせよ、さいたまを作り直す際に日周緯度変に設置したセンサーを接続することを考慮しておくとよいだろう。

PC側のソフトウエアだが、PCで操作する以上何らかのメリットが欲しい。
速度を柔軟に調節できるようにはなったが、操作性にはまだまだ改善の余地がある。
リアルタイムで操作するには、マウスよりもキーボード、欲を言えばタッチパネルでの操作の方がいい。いろいろ工夫してみると良いだろう。

もう一つの方向性として、操作の記録・再生が考えられる。
ボタン一つで一本のソフトをまるまる上映できると楽だろう。ただし、ソフトウエアを実装する手間、操作を記録しておく手間に見合うメリットがあるかよく考える必要がある。


\chapter{日周緯度変(Ikebukuro)}
\label{\detokenize{nissyu-idohen/ikebukuro:ikebukuro}}\label{\detokenize{nissyu-idohen/ikebukuro::doc}}\begin{itemize}
\item {} 
書いた人: Kenichi Ito(nichiden\_27)

\item {} 
更新日時: 2017/02/26

\item {} 
実行に必要な知識・技能: 電子回路

\item {} 
タスクの重さ: 2/数日かかる

\item {} 
タスクの必須度: 3/年による

\item {} 
元資料

\item {} 
\sphinxcode{日周・緯度変資料.pdf} by 岩滝宗一郎(nichiden\_22)

\item {} 
\sphinxcode{saitama.pdf} by 荒田 実樹(nichiden\_23)

\end{itemize}


\section{概要}
\label{\detokenize{nissyu-idohen/ikebukuro:id1}}\begin{figure}[htbp]
\centering
\capstart

\noindent\sphinxincludegraphics{{ikebukuro}.jpg}
\caption{池袋}\label{\detokenize{nissyu-idohen/ikebukuro:id12}}\end{figure}

さいたま6號には、外部機器(PCなど)を接続して制御することが可能です。これをさいたまの「\sphinxstylestrong{外部制御}」と呼んでいます。

埼玉6號の外部制御端子は\sphinxcode{RS-485/Mini-DIN6}という規格・形状ですが、残念ながらこのままではPCに直接挿して外部制御することはできません。そこで、\sphinxcode{RS-485/Mini-DIN6}と\sphinxcode{USB}の変換を行うために製作されたのが、\sphinxstylestrong{変換モジュール{}`{}`Ikebukuro{}`{}`}
(埼玉と繋がっているかららしい...)です。

実際に日周緯度変を動かす際に関わりの多い部分なので、使い方や構造などを解説します。


\section{沿革}
\label{\detokenize{nissyu-idohen/ikebukuro:id2}}
外部制御は、埼玉6號を製作した22代の時点で既に仕様に盛り込まれていた。ただし使用はされておらず、テストもされていない状態だった。続く23代で\sphinxcode{Ikebukuro}が導入され、\sphinxstylestrong{PCを使用しての日周緯度変制御を初めて行った}。

その後の24〜27代では日周緯度変を操作するアプリの開発を行なっており、通信には\sphinxcode{Ikebukuro}が使われ続けている。


\section{使い方}
\label{\detokenize{nissyu-idohen/ikebukuro:id3}}
さいたま6號側面に通信用の端子(\sphinxcode{Mini-DIN6})があるので、ケーブルで\sphinxcode{Ikebukuro}の同じ端子に接続する。次に、\sphinxcode{Ikebukuro}のUSB端子(miniB)とPCのUSB端子をUSBケーブルで接続すれば準備完了である。

さいたま6號の外部制御スイッチをONにすれば、PCからの信号を待ち受ける状態になる。あとは日周緯度変用のアプリなどを起動してシリアルポートに接続すれば良い。


\section{電装}
\label{\detokenize{nissyu-idohen/ikebukuro:id4}}

\subsection{通信方式}
\label{\detokenize{nissyu-idohen/ikebukuro:id5}}
埼玉6號の外部制御端子は、電気的には\sphinxcode{RS-485}という規格に従っている。
\sphinxcode{RS-485}では、3本の線(A,B,GND)で半二重通信(双方向の通信ができるが、同時に両方向の通信は不可)ができる。ノイズに強く、長距離にも耐えられるらしい。

埼玉6號の側部にあるMini-DIN6コネクタのピンとの対応は、図のようになっている。
\begin{figure}[htbp]
\centering
\capstart

\noindent\sphinxincludegraphics{{ikebukuro-rs485}.png}
\caption{外部制御端子の配線}\label{\detokenize{nissyu-idohen/ikebukuro:id13}}\end{figure}


\subsection{内部基板}
\label{\detokenize{nissyu-idohen/ikebukuro:id6}}
\sphinxcode{Ikebukuro}の中身は単なる変換モジュールであり、\sphinxcode{RS-485}と\sphinxcode{UART}の変換を行うIC(\sphinxcode{LTC485})と、USBとUARTの変換を行うモジュール(\sphinxcode{AE-UM232R})が載っているだけである。

\sphinxcode{AE-UM232R}に搭載されているUSB-UART変換チップ(FTDI社の\sphinxcode{FT232R}という、定番チップ)の関係で、利用するにはPC側にドライバが必要な場合がある。\href{http://www.ftdichip.com/Drivers/VCP.htm}{FTDI社のWebページ}から入手できるので、必要なら使用するPCにインストールしておこう。

また、このチップは初期状態から設定が書き換えられており、\sphinxcode{InvertRTS=1}となっている。この設計はFTDI社謹製の\sphinxcode{FT\_PROG}(Windows用)というツールで設定できる。

\sphinxcode{RS-485}は半二重なので、通信方向の切り替えが必要である。これは、シリアルポートのRTSピンを使用して行っている。

\sphinxcode{Ikebukuro}の基板の配線を図に載せる。なお、図には反映していないが、RTSの状態確認用にLEDを実装している。
\begin{figure}[htbp]
\centering
\capstart

\noindent\sphinxincludegraphics{{ikebukuro-circuit}.png}
\caption{Ikebukuro基板の配線}\label{\detokenize{nissyu-idohen/ikebukuro:id14}}\end{figure}

\sphinxcode{AE-UM232R}はICソケットに差さっているので、容易に\sphinxcode{Ikebukuro}から取り外すことができる。他の回路のテストでUSBシリアル変換モジュールを使いたい時は、\sphinxcode{Ikebukuro}から\sphinxcode{AE-UM232R}を取り外して使うと良いだろう(実際、23代で惑星投影機の基板のテストに利用した。最終的にはXBeeで通信するのだが、デバッグ時は「信頼と安定の」FT232Rを利用しようというわけだ)。


\section{プロトコルとコマンド}
\label{\detokenize{nissyu-idohen/ikebukuro:id7}}
外部制御モードではPCからさいたま6號に指令(コマンド)を送る。ここでは、コマンドを表す文字列のフォーマットを述べる。

このフォーマットを変更したいと思ったら、さいたま側のプログラムの\sphinxcode{main.c}とPC側のプログラムをいじればよい。


\subsection{各コマンドに共通するフォーマット}
\label{\detokenize{nissyu-idohen/ikebukuro:id8}}
\noindent\begin{tabulary}{\linewidth}{|L|L|L|L|L|L|L|}
\hline
\sphinxstylethead{\relax 
位置
\unskip}\relax &\sphinxstylethead{\relax 
0
\unskip}\relax &\sphinxstylethead{\relax 
1
\unskip}\relax &\sphinxstylethead{\relax 
2
\unskip}\relax &\sphinxstylethead{\relax 
3
\unskip}\relax &\sphinxstylethead{\relax 
4
\unskip}\relax &\sphinxstylethead{\relax 
...
\unskip}\relax \\
\hline
内容
&
\sphinxcode{\$}
&
\sphinxcode{W}
&
\sphinxstyleemphasis{addr}
&
\sphinxstyleemphasis{len}
&
\sphinxstyleemphasis{cmd}
&
...
\\
\hline\end{tabulary}



\bigskip\hrule{}\bigskip

\begin{itemize}
\item {} 
\sphinxstyleemphasis{addr}: 機器のアドレス (16進1桁; ‘\sphinxcode{0}’〜‘\sphinxcode{9}’,
‘\sphinxcode{A}’〜‘\sphinxcode{F}’)

\item {} 
メイン基板上のディップスイッチで設定した値と一致させる

\item {} 
現在は\sphinxcode{0}が使われている

\item {} 
複数の機器を繋いだ時用のアドレスだが、使うことはないだろう

\item {} 
\sphinxstyleemphasis{len}: 以降のバイト数 (16進1桁; ‘\sphinxcode{0}’〜‘\sphinxcode{9}’,
‘\sphinxcode{A}’〜‘\sphinxcode{F}’)

\item {} 
\sphinxstyleemphasis{cmd}: コマンドの種類

\end{itemize}


\subsection{速度指定コマンド}
\label{\detokenize{nissyu-idohen/ikebukuro:id9}}
\noindent\begin{tabulary}{\linewidth}{|L|L|L|L|L|L|L|L|}
\hline
\sphinxstylethead{\relax 
位置
\unskip}\relax &\sphinxstylethead{\relax 
...
\unskip}\relax &\sphinxstylethead{\relax 
3
\unskip}\relax &\sphinxstylethead{\relax 
4
\unskip}\relax &\sphinxstylethead{\relax 
5
\unskip}\relax &\sphinxstylethead{\relax 
6
\unskip}\relax &\sphinxstylethead{\relax 
7..10
\unskip}\relax &\sphinxstylethead{\relax 
...
\unskip}\relax \\
\hline
内容
&
...
&
\sphinxcode{7}
&
\sphinxcode{V}
&
\sphinxstyleemphasis{motor}
&
\sphinxstyleemphasis{dir}
&
\sphinxstyleemphasis{speed}
&
...
\\
\hline\end{tabulary}



\bigskip\hrule{}\bigskip

\begin{itemize}
\item {} 
\sphinxstyleemphasis{len}: 以降のバイト数 = `\sphinxcode{7}` (7 byte)

\item {} 
\sphinxstyleemphasis{cmd}: コマンドの種類 = `\sphinxcode{V}`

\item {} 
\sphinxstyleemphasis{motor}: モーター (日周:‘\sphinxcode{D}’, 緯度:‘\sphinxcode{L}’)

\item {} 
\sphinxstyleemphasis{dir}: 回転方向 (時計回り:‘\sphinxcode{+}’, 反時計回り‘\sphinxcode{-}’)

\item {} 
\sphinxstyleemphasis{speed}: 回転速度{[}deg/s{]} (16進4桁; ‘\sphinxcode{0}’〜‘\sphinxcode{9}’,
‘\sphinxcode{A}’〜‘\sphinxcode{F}’)

\end{itemize}


\subsection{角度指定コマンド}
\label{\detokenize{nissyu-idohen/ikebukuro:id10}}
\noindent\begin{tabulary}{\linewidth}{|L|L|L|L|L|L|L|L|}
\hline
\sphinxstylethead{\relax 
位置
\unskip}\relax &\sphinxstylethead{\relax 
...
\unskip}\relax &\sphinxstylethead{\relax 
3
\unskip}\relax &\sphinxstylethead{\relax 
4
\unskip}\relax &\sphinxstylethead{\relax 
5
\unskip}\relax &\sphinxstylethead{\relax 
6
\unskip}\relax &\sphinxstylethead{\relax 
7...12
\unskip}\relax &\sphinxstylethead{\relax 
13...16
\unskip}\relax \\
\hline
内容
&
...
&
\sphinxcode{D}
&
\sphinxcode{P}
&
\sphinxstyleemphasis{motor}
&
\sphinxstyleemphasis{dir}
&
\sphinxstyleemphasis{angle}
&
\sphinxstyleemphasis{speed}
\\
\hline\end{tabulary}



\bigskip\hrule{}\bigskip

\begin{itemize}
\item {} 
\sphinxstyleemphasis{len}: 以降のバイト数 = `\sphinxcode{D}` (13 byte)

\item {} 
\sphinxstyleemphasis{cmd}: コマンドの種類 = `\sphinxcode{P}`

\item {} 
\sphinxstyleemphasis{motor} モーター (日周:‘\sphinxcode{D}’, 緯度:‘\sphinxcode{L}’)

\item {} 
\sphinxstyleemphasis{dir} 回転方向 (時計回り:‘\sphinxcode{+}’, 反時計回り‘\sphinxcode{-}’)

\item {} 
\sphinxstyleemphasis{angle} 回転角度{[}\sphinxcode{\$10\textasciicircum{}\{-2\}\$}deg{]} (16進6桁;
‘\sphinxcode{0}’〜‘\sphinxcode{9}’, ‘\sphinxcode{A}〜‘\sphinxcode{F}’)

\item {} 
\sphinxstyleemphasis{speed} 回転速度{[}deg/s{]} (16進4桁; ‘\sphinxcode{0}’〜‘\sphinxcode{9}’,
‘\sphinxcode{A}’〜‘\sphinxcode{F}’)

\end{itemize}


\subsection{コマンド実例集}
\label{\detokenize{nissyu-idohen/ikebukuro:id11}}
以上がさいたま外部制御コマンドの仕様だが、これだけでは少々分かりにくいはずなのでいくつか実例を挙げておく。
\begin{itemize}
\item {} 
緯度モーターを3000deg/sで時計回りに回す -\textgreater{} \sphinxcode{\$W07VL+0BB8}

\item {} 
日周モーターを1800deg/sで時計回りに90000deg回す -\textgreater{}
\sphinxcode{\$W0DPD+8954400708}

\end{itemize}


\subsection{PC側のプログラム}
\label{\detokenize{nissyu-idohen/ikebukuro:pc}}
PC側からは、Ikebukuroが仮想COMポートに見えるので、そのCOMポートに対して上に述べたコマンドを書き込めば良い。この辺りの具体的な話は外部制御アプリの資料に譲る。


\chapter{日周緯度変(外部制御アプリ)}
\label{\detokenize{nissyu-idohen/pc-software::doc}}\label{\detokenize{nissyu-idohen/pc-software:id1}}\begin{itemize}
\item {} 
書いた人: Kenichi Ito(nichiden\_27)

\item {} 
更新日時: 2017/03/04

\item {} 
実行に必要な知識・技能: シリアル通信、C\#

\item {} 
タスクの重さ: 3/数週間

\item {} 
タスクの必須度: 4/毎年やるべき

\end{itemize}


\section{概要}
\label{\detokenize{nissyu-idohen/pc-software:id2}}
日周緯度変の外部制御には、大きな可能性があります。PCを使える以上かなり複雑な操作も自動化できるためです。

ただし、本番で日周緯度変を動かすのは人間である部員たち。
それも、プログラムの挙動を知っている日電員だけが操作するとは限りません(26・27と、かごしいにも日周緯度変操作を手伝って貰っています)。

誰にでも使いやすい日周緯度変外部制御アプリを作るために注意すべきことを書きます。


\section{沿革}
\label{\detokenize{nissyu-idohen/pc-software:id3}}
\sphinxstylestrong{過去に開発されたアプリケーションが多数にのぼるため、}外部制御アプリの歴史\sphinxstylestrong{に分離する。}


\section{Ogoseの特徴と使い方}
\label{\detokenize{nissyu-idohen/pc-software:ogose}}
\sphinxcode{Ogose}は、27代日電で作成した、2017/03/01現在最新の外部制御アプリである。

特徴は沿革の方に文章で書いたので、ここでは簡単に箇条書きするにとどめる。
\begin{figure}[htbp]
\centering
\capstart

\noindent\sphinxincludegraphics{{ogose}.png}
\caption{Ogoseの画面}\label{\detokenize{nissyu-idohen/pc-software:id12}}\end{figure}
\begin{itemize}
\item {} 
各軸4段階で速度を指定

\item {} 
回転中の速度変更が可能

\item {} 
回転の開始/停止はトグルボタン(押すたびにON/OFFが切り替わる)

\item {} 
フルスクリーン切り替えボタン

\item {} 
誤操作防止用の「公演モード」

\item {} 
キーボードでも操作可能

\item {} 
フリーソフトを使ってゲームコントローラに操作を割り当て可能

\end{itemize}


\subsection{基本操作}
\label{\detokenize{nissyu-idohen/pc-software:id4}}
起動したら、まずは最上部からシリアルポートを選んで\sphinxstylestrong{接続ボタン}
を押す。
さいたまを\sphinxcode{Ikebukuro}を介して繋いだだけの状態ならポートは一つしか出ないことがほとんどだが、複数出たとしても一つずつ試してモーターが動くかどうかで判断すればよい。

未接続のままコマンドを送る操作をした場合は、エラーメッセージとともに送信するコマンドが表示される。
接続していないことに気づけるようにする一方、わざと未接続にすることでコマンド送信のデバッグも可能だ。

実際に日周緯度変を動かすときは、左側と上側にある\sphinxstylestrong{速度切り替えボタン}
から速度を選び、動かしたい方向のボタンをクリックする。
起動後に一度も速度を選んでいないときは、各軸とも「速い」速度が選択される。

回転開始ボタンは押すと「停止」に表示が切り替わり、再度押すと回転が停止する。
反対方向のボタンは「停止」するまでグレーアウトしてクリックに反応しない。これは、ボタンの表示がおかしくなるのを防ぐためである。

\sphinxstylestrong{フルスクリーンボタン} にチェックするとフルスクリーンになる。
画面全体が黒背景になるので、本番中はフルスクリーンが望ましい。
\sphinxstylestrong{公演モード}
ボタンは、ONにすると警告が表示され日周を進めることしかできなくなる。

モーターの回転はキーボード操作でもできる。
\begin{itemize}
\item {} 
\sphinxcode{W}: 緯度+

\item {} 
\sphinxcode{A}: 日周戻す

\item {} 
\sphinxcode{S}: 緯度-

\item {} 
\sphinxcode{D}: 日周進める

\end{itemize}

と対応している。PCゲーマーには馴染みのある配置かと思う。

\sphinxcode{Ogose}のコードの解説は、たいへん長いので別記事とする。

-\textgreater{} Ogoseの実装解説


\section{通信プログラム}
\label{\detokenize{nissyu-idohen/pc-software:id5}}

\subsection{シリアル通信の基本}
\label{\detokenize{nissyu-idohen/pc-software:id6}}
Ikebukuroの記事にある通り、パソコン側からは\sphinxcode{Ikebukuro}はシリアルポートとして見える。
よって、シリアルポートにアクセスするプログラムを書けばよい。

ポート名は、Windowsであれば\sphinxcode{COM1}や\sphinxcode{COM4}のように、「'\sphinxcode{COM}`+数字」の形式である。
Mac OS
XやLinuxのようなUNIX環境であれば、\sphinxcode{/dev/tty.usbserial-A5017ABT}である。

シリアルポートの設定は、さいたま6號側のプログラム中に記述してある設定と一致させなければならない。
現時点での設定は、
\begin{itemize}
\item {} 
baud rate: 2400

\item {} 
parity: none

\item {} 
char bits: 8

\item {} 
stopbit: 1

\end{itemize}

である。baud
rateはこの値である必然性はないので、変えても良い(さいたま6號のプログラムも一緒に変更すること！)。

通信経路の途中で\sphinxcode{RS485}を使っている関係上、シリアルポートには読み取りと書き込みのいずれか一方しかできない。

\sphinxcode{RS485}の通信方向の切り替えには、シリアルポートのRTS端子を使う。
RTSが\sphinxcode{HIGH}になるとパソコン側から日周緯度変側への通信ができ、\sphinxcode{LOW}になると逆方向の通信ができる。
コマンドを送信する直前にRTSを\sphinxcode{HIGH}にし、終了したら\sphinxcode{LOW}に戻すといいだろう。


\subsection{.Netでのシリアル通信}
\label{\detokenize{nissyu-idohen/pc-software:net}}
\sphinxcode{.Net Framework}を使う場合は、\sphinxcode{System.IO.Ports}名前空間以下にある\sphinxcode{SerialPort}クラスを利用すると便利である。
Mac OS
XやLinuxでは\sphinxcode{.Net}のオープンソース実装である\sphinxcode{Mono}を利用できるが、\sphinxcode{Mono}においても同様である。

以下ではC\#のコード例を示す。

まず、ソースコードの冒頭に以下の文を書いておくと便利であろう:

通信を開始する前に、まずポートを開く：

この後、\sphinxcode{port.IsOpen}により、ポートを開くのに成功したか確認しておこう。

実際に通信するには\sphinxcode{SerialPort.Write}メソッドを使う。プログラムを終了する際には、\sphinxcode{port.Close()}によりポートを閉じておく。


\subsection{他の言語でのシリアル通信}
\label{\detokenize{nissyu-idohen/pc-software:id7}}
日電では23からC\#で外部制御アプリを開発してきたが、他の各種の言語でもシリアル通信を扱えるので記しておく。
\begin{itemize}
\item {} 
C, Lua: \href{https://github.com/ynezz/librs232/}{librs232}

\item {} 
Lua: LuaSys

\item {} 
Python: \href{http://pyserial.sourceforge.net/}{pySerial}

\item {} 
Ruby: \href{http://ruby-serialport.rubyforge.org/}{ruby-serialport}

\item {} 
Java: Java Communications API / RXTX(Windows)

\item {} 
JavaScript(Node.js):
\href{https://www.npmjs.com/package/serialport}{serialport}

\end{itemize}

それぞれの使い方やインストール方法についてはググって欲しい。


\subsection{仮想シリアルポート}
\label{\detokenize{nissyu-idohen/pc-software:id8}}
開発中、きちんとコマンド文字列が送れているか確認したくなることがあるだろう。
\sphinxstylestrong{仮想シリアルポート}
は、シリアルポートとして振る舞い、自分自身にデータを送信するループバックテストを可能にするソフトウェアだ。

Windows用だが、\href{https://sourceforge.net/projects/com0com/}{com0com}を紹介する。
\begin{figure}[htbp]
\centering
\capstart

\noindent\sphinxincludegraphics{{com0com}.png}
\caption{com0comの設定画面}\label{\detokenize{nissyu-idohen/pc-software:id13}}\end{figure}

セットアップすると、互いに繋がった二つのCOMポートを用意してくれる。
番号は、他と被らないよう大きめにしておけば大丈夫だろう。

あとは、一方に作ったアプリから接続し、他方に\sphinxcode{Tera Term}などのターミナルソフトで接続すれば、送っている内容が見えるようになる。


\section{今後の展望}
\label{\detokenize{nissyu-idohen/pc-software:id9}}

\subsection{GUIフレームワーク}
\label{\detokenize{nissyu-idohen/pc-software:gui}}
日周緯度変をある程度誰でも動かせるようにするには、GUIは欠かせない。
歴代日電では、GUI開発にWindows FormアプリケーションやWPFを用いてきた。
もちろん他にもGUIのフレームワークは山ほどあるが、時間も限られている以上、定番で枯れた技術を使っておくのが無難ではなかろうか。

一つの可能性としては、最近イケイケのWebアプリがある。
ChromeとJavaScriptをベースにデスクトップアプリを実現する\sphinxcode{Electron}など、ここ最近急速にシェアを伸ばしている技術もある。
もしあなたがそういった技術を得意としているなら、乗り換える価値はあるかもしれない。


\subsection{入力機器}
\label{\detokenize{nissyu-idohen/pc-software:id10}}
本番でアプリの操作性にはまだまだ改善の余地がある。
暗い画面ですばやく操作をするには、マウスよりもキーボードがいいし、タッチパネルやゲームコントローラーといった馴染みのある操作系も役に立つだろう。

ゲームコントローラーは、27プラネではフリーソフトでキー操作と無理やり関連付けしたが、\sphinxcode{DirectInput}を使えば単体でも利用できる。
入力機器として完成されているし、操作に慣れている人も多いので、案外自前のボタン配置に凝るよりコスパがいいかもしれない。
\begin{figure}[htbp]
\centering
\capstart

\noindent\sphinxincludegraphics{{honban-nichiden}.jpg}
\caption{27本番の日周緯度変スタッフ席の様子}\label{\detokenize{nissyu-idohen/pc-software:id14}}\end{figure}


\subsection{機能追加}
\label{\detokenize{nissyu-idohen/pc-software:id11}}
27の本番中、気になったことがある。
折角フルスクリーンモードで画面が光らないようにしたのに、画面右端に指示を書いた「メモ帳」が並べられていたのだ。
黒背景で指示やタイミングをメモしておけるよう、アプリの\sphinxstylestrong{画面内にメモ欄}
を設けても良いかもしれない。

また、別の方向性として、\sphinxstylestrong{操作の記録・再生} が考えられる。
23や25で行ってきたことを発展させ、ボタン一つで一本のソフトをまるまる上映できるようになれば楽だろう。

ただし、当然ソフトの指示は毎年変わるので、開発の負担は増加する。
ライブ解説ではタイミングを人力で判断せねばならず、想定外の事態も起こりうる以上、全自動化への道は平坦ではない。
コストに見合うメリットが得られるような仕組みを、ぜひ考案してほしい。


\chapter{日周緯度変(外部制御アプリの歴史)}
\label{\detokenize{nissyu-idohen/pc-software-history::doc}}\label{\detokenize{nissyu-idohen/pc-software-history:id1}}\begin{itemize}
\item {} 
書いた人: Kenichi Ito(nichiden\_27)

\item {} 
更新日時: 2017/03/04

\item {} 
実行に必要な知識・技能: 特になし

\item {} 
難易度: 2/少しやれば可能

\item {} 
情報の必須度: 2/知ってると楽

\item {} 
元資料

\item {} 
\sphinxcode{引き継ぎと技術的補足：日周緯度変外部制御ユーザインタフェース.docx}
by 紺野雄介(nichiden\_23)

\item {} 
\sphinxcode{ふじさわreadme.docx} by 池下 氏(nichiden\_24)

\item {} 
\sphinxcode{25の日周・緯度変について.docx} by 伊藤太陽(nichiden\_25)

\end{itemize}


\section{概要}
\label{\detokenize{nissyu-idohen/pc-software-history:id2}}
日周緯度変(外部制御アプリ)から歴代外部制御アプリケーションの紹介を分離した記事です。

現在は実装されていない機能があったりと、それぞれに特徴があるので、把握しておくと今後の改善に繋がるかもしれません。


\section{Tokyo Terminal(2012)}
\label{\detokenize{nissyu-idohen/pc-software-history:tokyo-terminal-2012}}\begin{figure}[htbp]
\centering
\capstart

\noindent\sphinxincludegraphics{{tokyoterminal}.png}
\caption{Tokyo Terminalの画面}\label{\detokenize{nissyu-idohen/pc-software-history:id3}}\end{figure}

23代荒田氏が制作した。外部制御は23代で初使用されたが、\sphinxcode{Tokyo Terminal}はそのテスト用に書かれたものである。

氏の環境がMac
OSだったため、Macでしか動作しない。23代の作業データの\sphinxcode{日周緯度変外部制御/Saitama6Brain/}以下にソースファイルやアプリ本体があるが、最新のMac
OSでは対応していない旨が表示され起動しなかった。

これ以降の外部制御アプリは全てWindows向けに開発されたものだ。Mac向けに開発する必要に迫られることがもしあれば、\sphinxcode{Tokyo Terminal}のコードが参考になるかもしれない(Mac開発の経験があれば一から書いた方が早い可能性も大いにあるが...)。


\section{NisshuidohenController2(2012)}
\label{\detokenize{nissyu-idohen/pc-software-history:nisshuidohencontroller2-2012}}\begin{figure}[htbp]
\centering
\capstart

\noindent\sphinxincludegraphics{{nisshuidohencontroller2}.png}
\caption{NisshuidohenController2の画面}\label{\detokenize{nissyu-idohen/pc-software-history:id4}}\end{figure}

23代紺野氏の作。\sphinxcode{Tokyo Terminal}がMac専用だったため、Windows版として開発された。開発言語はC\#で、Windows
Formアプリケーション(\sphinxcode{System.Windows.Forms}名前空間を使用)である。

\sphinxcode{Tokyo Terminal}と共通の機能が多いが、大きな違いは\sphinxstylestrong{操作の記録・再生ができる}
ことである。「速度指定」か「角度指定」かを選択して「記録」ボタンを押すと右のスペースに送るコマンドが表示され、同時に\sphinxcode{Instruction.txt}というファイルにも保存される。

あらかじめ必要なコマンドを記録しておいて面倒な操作なしに再実行できる画期的な機能である...と言いたいところだが、\sphinxstylestrong{表示されるのはコマンドだけ}(数値は16進数)なので、肝心の再生部分が手軽に利用できるとは言い難い。

「高速」「低速」のボタンで出る角速度は以下の数値に固定されている。なお、上半分で入力する角速度はモーターのもの、以下の角速度はギアによる減速後のかごしいのものなので注意。
- 日周高速ボタン: 4 deg/s - 日周低速ボタン: 1 deg/s - 緯度高速ボタン: 1
deg/s - 緯度低速ボタン: 0.5 deg/s

この数値は後発の\sphinxcode{Fujisawa}、\sphinxcode{Chichibu}でも同じものが使われている。

当時の日周緯度変は相応のスキルのある日電員が操作しており、自分たちで使うための最小限の機能を盛り込んだという印象だ。実際、本番中に使用したのは「高速」などのボタンだけだったという。

将来これを使うことはなさそうだが、速度・角度・方向に対応するコマンドを表示してくれるので、デバッグ用の計算機にはなるかもしれない。


\section{Fujisawa(2013)}
\label{\detokenize{nissyu-idohen/pc-software-history:fujisawa-2013}}\begin{figure}[htbp]
\centering
\capstart

\noindent\sphinxincludegraphics{{fujisawa}.png}
\caption{Fujisawaの画面}\label{\detokenize{nissyu-idohen/pc-software-history:id5}}\end{figure}

24池下氏によるもの。引き続きC\#によるWindowsアプリだが、UIのフレームワークに\sphinxcode{Windows Presentation Foundation(WPF)}を使用している。

WPFの詳細についてはググって欲しいが、デザインとコードを分けて書くことができるというのが大きな利点である。つまり、内部の動作を崩さずに見た目だけをいじり倒せるのだ。その甲斐あってか、23のUIに比べデザイン面が大きく改善した。コマンド文字列を生成するコードは\sphinxcode{fujisawa/NisshuidohenController.cs}でクラスにまとめて定義されている。

日周緯度変にPCを使うとき、一番問題になるのは画面が光ることだ。PCは画面も大きいし、そのために星がかき消されてしまいかねない。\sphinxcode{Fujisawa}は、\sphinxstylestrong{黒基調の画面}
にすることでPCの光害を抑制している。

使い方は見れば分かると思うが、「びゅーん」が高速回転、「のろのろ」が低速回転だ。また、本番で画面を暗くしているとマウス操作が大変なので、日周はキーボードでも操作できる。\sphinxcode{C}:
高速逆転、\sphinxcode{V}: 低速逆転、\sphinxcode{B}: 停止、\sphinxcode{N}:
低速順回転、\sphinxcode{M}: 高速順回転 である。

総じて24日電の雰囲気がよく出ており大変分かりやすいものの、回転方向が少し把握しにくい。なお、アプリ名称は往時の天文部の「備品などに駅名をつける」習慣に則ったもので、「ふじさわ」は制作者の地元であるらしい。


\section{Chichibu(2014)}
\label{\detokenize{nissyu-idohen/pc-software-history:chichibu-2014}}\begin{figure}[htbp]
\centering
\capstart

\noindent\sphinxincludegraphics{{chichibu}.png}
\caption{Chichibuの画面}\label{\detokenize{nissyu-idohen/pc-software-history:id6}}\end{figure}

25伊藤氏が開発したアプリ。他にない特色として、25ソフト専用のモードが用意され、ボタンを押すだけでシナリオで要求された動きを実現できることがある。

また、23の\sphinxcode{NisshuidohenController2}と24の\sphinxcode{Fujisawa}の画面もそのまま移植され、それぞれの機能が利用できる。本番でも、ライブ解説時には\sphinxcode{Fujisawa}を使っていたようだ。
\begin{figure}[htbp]
\centering
\capstart

\noindent\sphinxincludegraphics{{chichibu_2}.png}
\caption{Chichibuに移植されたNisshuidohenController2}\label{\detokenize{nissyu-idohen/pc-software-history:id7}}\end{figure}

フルスクリーン状態で起動することで、以前より更に画面の光漏れを抑えている。ただし、ソフト内に終了ボタンがないうえタイトルバーも見えないので、プログラムを終了させる際は\sphinxcode{Alt}+\sphinxcode{F4}を押すなどショートカットキーを使うしかない。


\section{Ogose(2016)}
\label{\detokenize{nissyu-idohen/pc-software-history:ogose-2016}}\begin{figure}[htbp]
\centering
\capstart

\noindent\sphinxincludegraphics{{ogose}.png}
\caption{Ogoseの画面}\label{\detokenize{nissyu-idohen/pc-software-history:id8}}\end{figure}

27日電の伊東が開発した。これまでのUIの問題点を洗い出した上で、改善すべく様々な変更を加えている。デザイン部分(\sphinxcode{MainWindow.xaml})は一から作り直したが、コマンド文字列生成は\sphinxcode{NisshuidohenController.cs}を継続使用した。

指定できる速度が各軸4段階に増えたことで、多彩な演出が可能となった。また、速度指定のボタンを回転スタート/ストップボタンとは別に用意したため、回転を止めずとも速度を変更できる。

ウィンドウモードとフルスクリーンモードをボタンで切り替えられる機能も実装した。また、フルスクリーンボタンの横にある「公演モード」ボタンは、使用できる機能を「日周進める」に限定し誤操作を防止する機能である。キーボード操作などにより意図しない状態になるバグが存在するので注意。

思いがけないことに、ボタンを十字に配置したことで、ゲームコントローラーのボタンと同様の配置となった。本番ではゲームコントローラーを実際に使用し、慣れていない人でも操作ができるという恩恵があった。

実装についてなど、詳細は外部制御アプリの記事に示すこととする。


\chapter{日周緯度変(Ogoseの実装解説)}
\label{\detokenize{nissyu-idohen/pc-software-code:ogose}}\label{\detokenize{nissyu-idohen/pc-software-code::doc}}\begin{itemize}
\item {} 
書いた人: Kenichi Ito(nichiden\_27)

\item {} 
更新日時: 2017/03/06

\item {} 
実行に必要な知識・技能: Windows GUI開発、C\#、WPF、Visual Studioの操作

\item {} 
難易度: 3/練習・勉強が必要

\item {} 
情報の必須度: 3/必要な場合がある

\end{itemize}


\section{概要}
\label{\detokenize{nissyu-idohen/pc-software-code:id1}}
日周緯度変(外部制御アプリ)から\sphinxcode{Ogose}の実装解説を分離した記事です。

\sphinxcode{Ogose}のソースコードを読む、あるいは書き換える際に参考にしてください。


\section{ファイル構成}
\label{\detokenize{nissyu-idohen/pc-software-code:id2}}
\sphinxcode{Ogose}のソースファイル等は、\sphinxcode{Ogose}フォルダ内に入っている。以下にファイル・ディレクトリ構成の抜粋を示す。

\begin{sphinxVerbatim}[commandchars=\\\{\}]
Ogose
├-- Ogose
\textbar{}   ├-- App.config
\textbar{}   ├-- App.xaml
\textbar{}   ├-- App.xaml.cs
\textbar{}   ├-- MainWindow.xaml
\textbar{}   ├-- MainWindow.xaml.cs
\textbar{}   ├-- NisshuidohenController.cs
\textbar{}   ├-- Ogose.csproj
\textbar{}   ├-- Properties
\textbar{}   \textbar{}   └-- (省略)
\textbar{}   ├-- bin
\textbar{}   \textbar{}   ├-- Debug
\textbar{}   \textbar{}   \textbar{}   ├-- Ogose.exe
\textbar{}   \textbar{}   \textbar{}   └-- (省略)
\textbar{}   \textbar{}   └-- Release
\textbar{}   \textbar{}       ├-- Ogose.exe
\textbar{}   \textbar{}       └-- (省略)
\textbar{}   ├-- main\PYGZus{}projector\PYGZus{}27\PYGZus{}w.png
\textbar{}   └-- obj
\textbar{}       └-- (省略)
└-- Ogose.sln
\end{sphinxVerbatim}

一見複雑で身構えてしまうかもしれない。
ただ、\sphinxcode{Visual Studio(以下VS)}でプロジェクトを作成すると自動で生成されるファイルがほとんどで、実際に開発者が触るべきファイルは多くない。

\sphinxcode{Ogose}直下には\sphinxcode{Ogose.sln}がある。これは「ソリューション(開発プロジェクトをまとめたもの)」の状態を管理している。
slnファイルをダブルクリックするか、VS内の読み込みメニューで選択してあげれば\sphinxcode{Ogose}の各ファイルを閲覧できる。

\sphinxcode{Ogose}の下に更に\sphinxcode{Ogose}ディレクトリがあり、この中にソースコードなどが収められている。
このうち、開発で実際に触ったのは\sphinxcode{App.xaml} \sphinxcode{MainWindow.xaml}
\sphinxcode{MainWindow.xaml.cs} \sphinxcode{NisshuidohenController.cs}の四つのみである。

\sphinxcode{Ogose/Ogose/bin/}以下には、ビルドで生成された\sphinxcode{.exe}ファイルが格納される。
\sphinxcode{Debug}と\sphinxcode{Release}は適当に使い分ければいい。exeの他にも様々なファイルが吐き出されるが、基本的には\sphinxcode{Ogose.exe}単体で動作する。

以下、ソースコードを簡単に解説する。WPF開発の基本的な知識全てに触れるとは限らないので、よく理解できない部分はググるなどして補完してもらいたい。


\section{App.xaml}
\label{\detokenize{nissyu-idohen/pc-software-code:app-xaml}}
\sphinxcode{App.xaml}や\sphinxcode{App.xaml.cs}の内容は、GUIのみならずアプリケーション全体に適用される。
何も書かなくても問題ないが、\sphinxcode{Ogose}ではコントロールの外見に関する記述をこちらに分離した。{\hyperref[\detokenize{nissyu-idohen/pc-software-code:mainwindow-xaml}]{\emph{MainWindow.xaml}}}が長くなりすぎないようにするのが目的である。

XAML(ざむる)は、XMLをベースとしたGUIの記述言語である。XMLのタグを用いて階層状に指示を書けるようになっている。
なお、\sphinxcode{\textless{}\textgreater{}}で囲まれた単位は「タグ」とも「要素」とも言うが、GUIの要素と混同する危険があるので、ここでは「タグ」に統一する。

\sphinxcode{\textless{}Application\textgreater{}}タグには色々とおまじないが書いてあるが、気にする必要はない。その下の\sphinxcode{\textless{}Application.Resources\textgreater{}}内からがコードの本番だ。


\subsection{ブラシ}
\label{\detokenize{nissyu-idohen/pc-software-code:id3}}
\sphinxstylestrong{ブラシ}
は、色などのデザインに名前(\sphinxcode{x:Key})をつけて使い回せるようにしたものである。各色の役割が明確になるし、後からの変更も楽なので積極的に利用した。
\sphinxcode{SolidColorBrush}は単色のブラシ、\sphinxcode{LinearGradientBrush}はグラデーションのブラシである。

配色が気に入らなければ、ここの色指定を変えれば良い。
色は名称で指定しても良いし(\href{http://www.atmarkit.co.jp/fdotnet/dotnettips/1071colorname/colorname.html\#colorsample}{色一覧})、Webなどでお馴染みの16進数で更に細かく決めることもできる。
ここでは\sphinxcode{ARGB}というRGBに加えアルファ値(透過度)も指定する方式で書いているので注意。例えば\sphinxcode{\#FF111111}なら、不透明で\{R,G,B\}
=　\{17,17,17\}の色を指す。


\subsection{コントロールテンプレート}
\label{\detokenize{nissyu-idohen/pc-software-code:id4}}
\sphinxstylestrong{コントロールテンプレート}
は、コントロール(ボタンやテキストエリアなど)のテンプレートである。
この中にボタンなどの見た目を書いておくと使い回しが効く。今あるコントロールテンプレートとその用途は以下の通り。
\begin{itemize}
\item {} 
``NormalToggleButton'' ... 日周緯度変回転用のトグルボタン

\item {} 
``ComboBoxToggleButton'' ...
接続するシリアルポートを選択するコンボボックス

\end{itemize}

また、\sphinxcode{\textless{}ControlTemplate.Triggers\textgreater{}}タグ内で「トリガー」を指定できる。
トリガーは、特定のイベントが起きたら動的にコントロールの見た目を変更する機能だ。
マウスでポイントした時やクリックした時に色が変わると、操作の結果がユーザーに視覚的に伝わる。

例として、\sphinxcode{"NormalToggleButton"}のトリガー定義を紹介する。
マウスポインタが乗った時、Checked(ON)状態になった時でそれぞれ''InnerBackground''の色を変更するようになっている。
\sphinxcode{Property="IsEnabled"}は、ボタンが有効(=操作できる)かを示しており、これが\sphinxcode{false}の時は、文字・背景の色をグレー調にしてクリックできないことをアピールする。


\subsection{スタイル}
\label{\detokenize{nissyu-idohen/pc-software-code:id5}}
\sphinxstylestrong{スタイル} には、要素の外観を定義できる。
前項のコントロールテンプレートに比べ機能が制限され、より個別の要素に対して用いる。

スタイルの適用の仕方はいくつかある。\sphinxcode{TargetType}\sphinxstylestrong{に要素の種類を入れると、同じ種類の要素全てに適用される}。
以下は\sphinxcode{Window}の見た目を指定している例。

\sphinxcode{\textless{}Setter\textgreater{}}タグはプロパティを操作するために使う。\sphinxcode{Property}にプロパティの名前、\sphinxcode{Value}に値を入れるだけである。
\sphinxcode{Value}は実際の値でもいいし、ブラシなど他で定義したリソースを与えてもよい。

\sphinxcode{\textless{}Setter\textgreater{}}の中には更に様々な機能を持ったタグを入れられる。\sphinxcode{\textless{}ControlTemplate\textgreater{}}が入っていることもあるし、\sphinxcode{\textless{}Style.Triggers\textgreater{}}タグでトリガーを設定することもできる。
複雑な使い方は筆者もよく把握していないので、頑張ってググって貰いたい。

もう一つのスタイル適用方法は、\sphinxcode{x:Key}\sphinxstylestrong{プロパティ}
を用いることだ。\sphinxcode{\textless{}Style\textgreater{}}タグに\sphinxcode{x:Key="hogefuga"}のように分かりやすい名前をつけておく。

そして、適用したいボタンなどに\sphinxcode{Style="\{StaticResource hogefuga\}"}などと指定すれば該当する\sphinxcode{x:Key}を持つスタイルが適用される。

上の\sphinxcode{App.xaml}のコードでは、\sphinxstylestrong{スタイルの継承}
という機能も活用している。
\sphinxcode{BasedOn}プロパティに基にしたいスタイルの\sphinxcode{x:Key}を指定すると、そのスタイルの中身を引き継いだり、部分的に書き換えたりできる。

例えば、\sphinxcode{"DiurnalMinusButton"}スタイルは\sphinxcode{"DiurnalPlusButton"}スタイルを継承したので、\sphinxcode{FontSize}について再度記述する必要がない。
一方で、ボタンに表示する文字は変更したいので、\sphinxcode{Content}を書き換えている。


\section{MainWindow.xaml}
\label{\detokenize{nissyu-idohen/pc-software-code:mainwindow-xaml}}
メインのウィンドウの構造を記述する。
といっても\sphinxcode{Ogose}には一つしかウィンドウがないので、配置を変えたい場合はこれを編集すればいい。
UIのデザインについてもこの中に書けるが、たいへん長いので{\hyperref[\detokenize{nissyu-idohen/pc-software-code:app-xaml}]{\emph{App.xaml}}}に移した。


\subsection{編集方法について}
\label{\detokenize{nissyu-idohen/pc-software-code:id6}}
ウィンドウの見た目はXAMLのコードだけで自在に操れるが、VSではより便利に、実際の画面をプレビューしながらドラッグ\&ドロップで編集することもできる。
\begin{figure}[htbp]
\centering
\capstart

\noindent\sphinxincludegraphics{{mainwindow-xaml}.png}
\caption{Visual Studioの画面プレビュー編集}\label{\detokenize{nissyu-idohen/pc-software-code:id19}}\end{figure}

GUIでの編集は手軽で初心者にも扱いやすいが、コードが自動生成されるので手で書くよりも読みにくくなりがちだ。
また、数値を細かく決めたい場合はコードを直接編集した方が早い。
図のように画面プレビューとコードは並べて表示できるので、双方の利点を使い分けるとよかろう。


\subsection{グリッド}
\label{\detokenize{nissyu-idohen/pc-software-code:id7}}
WPFのレイアウト要素はいくつかあるが、\sphinxcode{Ogose}では\sphinxcode{\textless{}Grid\textgreater{}}タグを使ってレイアウトしている。
\sphinxstylestrong{グリッド}
は、画面を格子状に分割してその中に要素を配置していくことができる。
いちいち行や列を定義せねばならず面倒だが、サイズを相対的に決められるので、ウィンドウを大きくしたときボタンも拡大されるというメリットがある。

上のコード片は、グリッドを定義している例である。
一意の\sphinxcode{x:Name}を付けて\sphinxcode{\textless{}Grid\textgreater{}}を宣言したら、\sphinxcode{\textless{}Grid.RowDefinitions\textgreater{}}で行を、\sphinxcode{\textless{}Grid.ColumnDefinitions\textgreater{}}で列を定義する。


\subsubsection{グリッドの使い方}
\label{\detokenize{nissyu-idohen/pc-software-code:id8}}
それぞれの中に行・列を欲しいだけ並べれば良いのだが、\sphinxstylestrong{高さや幅の指定}
にポイントがある。
数値のみを書くとピクセル数を表すが、\sphinxcode{数値*}とすると相対サイズを表せるのだ。
例えば、\sphinxcode{Height="1*"}の行と\sphinxcode{Height="2*"}の行だけがある場合、グリッドは1:2の比率で分割される。

また、コード例では使っていないが\sphinxcode{Auto}を指定すると、中に配置した子要素のサイズに合わせてくれる。
ピクセル指定、相対指定、Auto指定は混ぜて書いても問題ない。
画面プレビューで行や列を分割した場合、サイズが単純な数値にならないので適宜コード側で修正するといいだろう。

\sphinxstylestrong{グリッドの中に要素を置く}
時は、画面プレビュー上で設置したい場所に動かすだけで良い。
ただし、グリッドは入れ子にすることもでき(コード例では\sphinxcode{MainGrid}の下に\sphinxcode{HeaderGrid}を入れてある)、意図した階層に置けないことも多々ある。
その場合は、望みの階層に要素の定義をコピペした上で、\sphinxcode{Grid.Row}と\sphinxcode{Grid.Column}プロパティに何行何列目かを指定する。
両プロパティは\sphinxstylestrong{0始まり}
なので要注意。\sphinxcode{Grid.Row="1" Grid.Column="1"}なら2行2列目だ。

要素が横に長く、\sphinxstylestrong{複数の列に渡って配置}
したいーそんな時は、\sphinxcode{Grid.RowSpan}や\sphinxcode{Grid.ColumnSpan}を使おう。
それぞれに指定した数だけ要素が占める場所が下方向・右方向に伸びる。
これは、画面プレビューで操作している時に勝手に追加されていることもあるので、やはりコード側で直してあげよう。


\subsection{UI要素}
\label{\detokenize{nissyu-idohen/pc-software-code:ui}}
個別のUI要素については実際にコードを見ていただく方が早い。
\sphinxcode{Ogose}では\sphinxcode{ComboBox}、\sphinxcode{ToggleButton}、\sphinxcode{RadioButton}、\sphinxcode{CheckBox}などを使い分けている。
それぞれの動作を規定するコードについては、{\hyperref[\detokenize{nissyu-idohen/pc-software-code:mainwindow-xaml-cs}]{\emph{MainWindow.xaml.cs}}}の項で扱う。

少し説明が必要なのは、\sphinxcode{RadioButton}についてだ。 \sphinxstylestrong{ラジオボタン}
というと、

\begin{sphinxVerbatim}[commandchars=\\\{\}]
◎ 選択肢1
◎ 選択肢2
\end{sphinxVerbatim}

のようなデザインが普通だ。

しかし、\sphinxcode{Ogose}では縦に並べたり横に並べたりするので、横の二重丸がなく/普通のボタンと同じ見た目で/全体がクリック可能
である方が都合がよい。
実は、これには複雑なコーディングは必要なく、トグルボタン用のスタイルを適用してやるだけで済む。

これは、\sphinxcode{RadioButton}クラスが\sphinxcode{ToggleButton}クラスを継承しているため、共通のスタイル指定が使えることによる
(参考にした記事:
\href{http://neareal.net/index.php?Programming\%2F.NetFramework\%2FWPF\%2FRadioToggleButton}{RadioButtonなToggleButtonを実現する})。


\section{MainWindow.xaml.cs}
\label{\detokenize{nissyu-idohen/pc-software-code:mainwindow-xaml-cs}}
\sphinxcode{MainWindow.xaml}のコードビハインドである。C\#で書かれている。
日電のWindowsアプリケーションは代々C\#なので、宗教上やむを得ない事情がなければC\#を読み書きできるようになろう。

とはいえ、VSのコード補完(\sphinxcode{IntelliSense})が凄く優秀なので、コードを書いていて苦労することはあまりなさそうだ。
筆者もC\#経験はないが、言語使用についてはfor文を少しググったくらいで不便を感じることは少なかった。

コード中にやたら\sphinxcode{\textless{}summary\textgreater{}\textless{}/summary\textgreater{}}で囲まれたコメントを目にすると思うが、これはVSのドキュメント自動生成機能の推奨XMLタグらしい。
ドキュメントを作るかは別として、面倒でなければこの形式のコメントにして損はなさそうだ。

400行近いコードの全てを解説することはしないので、コードだけでは分かりにくいと思われる項目のみを以下に掲載する。


\subsection{コマンド}
\label{\detokenize{nissyu-idohen/pc-software-code:id9}}
\sphinxstylestrong{コマンド} とは、ユーザの操作を抽象化したものである。
例えば、Wordで編集していてペースト操作をしたいとき、どうするか考えてみよう。
ショートカットキーを知っていれば\sphinxcode{Ctrl(Command)}+\sphinxcode{V}を叩くだろうし、右クリックしてペーストを選ぶ人もいるだろう。
メニューバーからペーストメニューを選択してもペーストできる。
操作はいろいろだが、結果として呼ばれる処理は同一なのだ。
この仕組みがコマンドで、WPFでは\sphinxcode{ICommand}というインターフェースで実現される。

無理にコマンドを使わずともアプリは作れるのだが、\sphinxcode{Ogose}のキーボード操作を実装する際、必要に迫られて導入した。
これまでと違い\sphinxcode{Ogose}の回転/停止ボタンはトグル式で、色やラベルが状態により変化する。
25までClickイベントを用いる方式では上手く行かなくなったのである(キー操作だと、外観を変えるべきボタンの名称を関数内で取得できないため...だった気がする)。

そこで、\sphinxcode{ICommand}を使うようにプログラムを書き直した。
時間がない中でやったので、かなり汚いコードになってしまった。
今後書き換える際はぜひ何とかして欲しい。


\subsubsection{コマンドの使い方}
\label{\detokenize{nissyu-idohen/pc-software-code:id10}}
コマンドは高機能の代わりに難解なので、使い始めるときは\href{http://techoh.net/wpf-make-command-in-5steps/}{この記事}あたりを参考にした。

まず、\sphinxcode{RoutedCommand}クラスを宣言する。絶賛コピペなので意味はよく知らない。
\sphinxcode{diurnalPlus}は日周を進めるという意味だ。

この状態ではまだコマンドとボタン・処理が結びついていない。
CommandBindingという操作でこれらを紐付けする。これもコピペ。

これをボタンの数だけ書き連ねる。
\sphinxcode{new CommandBinding()}に与えている引数は順に、コマンド・実行する関数・実行可能かを与える関数である。
三番目のコマンド実行可否は、コマンドを実行されては困る時のための仕組みだ。

上手い方法が全然思いつかなかったので、\sphinxcode{isEnabled}という連想配列を作っておいて、呼び出し元ボタンの名前をもとに参照するようにした。
呼び出し元は、引数\sphinxcode{sender}に与えられて、\sphinxcode{ToggleButton}など元々のクラスに型変換するとプロパティを見たりできる。

さて、\sphinxcode{private void initCommandBindings()}をプログラム開始時に実行しなければバインディングが適用されない。
\sphinxcode{MainWindow}のコンストラクタ内で呼び出しておく。

考えてみれば大したことはしてないので、コンストラクタの中に直接書いてしまっても良かったかもしれない。

あとはXAML側でコマンドを呼び出せるようにするだけである。
\sphinxcode{\textless{}Window\textgreater{}}タグ内にローカルの名前空間(\sphinxcode{xmlns:local="clr-namespace:Ogose"})がなければ追加しておこう。
各コントロールの\sphinxcode{Command}プロパティにコマンドをコピペする。

これでクリック操作でコマンドが使えるようになる。


\subsubsection{キー操作でコマンドを実行する}
\label{\detokenize{nissyu-idohen/pc-software-code:id11}}
ここまできたら、キー操作でもコマンドが実行されるようにしたい。
XAMLで\sphinxcode{\textless{}KeyBinding\textgreater{}}タグを使えば実現できるのだが、なんとこれではボタンが\sphinxcode{sender}にならない。
色々調べても対処法が見つからないので、結局キー操作イベントから無理やりコマンドを実行させるしかなかった。

\sphinxcode{(コマンド名).Execute()}メソッドの第一引数は\sphinxcode{ExecutedRoutedEventArgs e}の\sphinxcode{Parameter}、第二引数は\sphinxcode{object sender}として渡される。
結局、\sphinxcode{sender}は第二引数に人力で指定した。

\sphinxcode{e.Parameter}というのは、仕様では「コマンドに固有の情報を渡す」とされていて、要は自由に使っていいようだ。
キーボード操作によるものかどうか、コマンドの処理で判定するために''KeyDown''という文字列(勝手に決めた)を渡している。


\subsubsection{コマンドで呼ばれる処理}
\label{\detokenize{nissyu-idohen/pc-software-code:id12}}
最後に、CommandBindingでコマンドと紐付けた関数について書く。
日周を進めるボタンのものは以下のようになっている。

どうしてこのような汚いコードになったのか弁解しておこう。
この関数は、三箇所から呼び出される可能性がある。

まず、対応するボタンがクリックされた場合。
クリックした時点でボタンの\sphinxcode{IsChecked}プロパティが反転するので、falseならモータを停止させ、trueなら動かせば良い。

ところが、キー操作イベントから呼ばれた場合、ボタンの状態は変わらない。
最初のif文で、\sphinxcode{e.Parameter.ToString() == "KeyDown"}であるときだけ、ボタンの\sphinxcode{IsChecked}を反転させることで対応した。

もう一つの可能性は、速度を切り替えたときだ。
日周の速度を管理している\sphinxcode{diurnalRadioButton}がクリックされたとき実行されるコードを見てみよう。

前半は、\sphinxcode{sender}がどの項目かによって速度を変更しているだけなので問題ないだろう。
後半で、「日周進める」か「日周戻す」がCheckedになっていれば、新しい設定をさいたまに送るためコマンドを実行している。

このときボタンの\sphinxcode{IsChecked}プロパティはすでにtrueなので、二重に変更されないよう\sphinxcode{e.Parameter}をnullとしている。
だが、考えてみればさいたまと通信さえすればいいので、\sphinxstylestrong{ボタンなど経由せず直接}\sphinxcode{emitCommand()}\sphinxstylestrong{(さいたまにコマンドを送る関数)を呼べばいいだけである。}

総じて、コマンドを使うことにこだわりすぎて酷いコードになってしまった。
バグの原因になっている可能性もあるので、後任の方は綺麗に書き直してやって頂きたい。


\subsection{シリアル通信}
\label{\detokenize{nissyu-idohen/pc-software-code:id13}}
\sphinxcode{MainWindow.xaml.cs}のうちシリアル通信に関する記述の大部分は、24の\sphinxcode{Fujisawa}から受け継いでいる。
この項では、通信を行うためのコードを読み、必要に応じて解説を加える。


\subsubsection{ポート一覧の取得}
\label{\detokenize{nissyu-idohen/pc-software-code:id14}}
\begin{DUlineblock}{0em}
\item[] \sphinxcode{Window\_Loaded}は、ウィンドウが描画されるタイミングで実行される。
\item[] 処理としては、シリアルポート一覧を取得して\sphinxcode{portComboBox}に候補として追加し、さらに前回の接続先と照合するというものだ。
また、\sphinxcode{SerialPort}クラスのオブジェクト\sphinxcode{serialPort}を宣言し、ボーレートを2400に設定している。
\end{DUlineblock}

foreach文の中で使用している\sphinxcode{SerialPortItem}は自作クラスで、\sphinxcode{ToString()}をオーバーライドしている。
何の為のものかは理解していないので、興味があればソースコードを確認してほしい。


\subsubsection{ポートへの接続}
\label{\detokenize{nissyu-idohen/pc-software-code:id15}}
接続ボタンがクリックされると、\sphinxcode{ConnectButton\_IsCheckedChanged()}が呼ばれる。
その中身はこうだ。

かなり長いが、順番に見ていこう。
最初のif文はポートが選択されているかチェックしているだけだ。
\sphinxcode{bool connecting}はポートを開くのか閉じるのかの分岐に使われている。
後はtry-catch文でポートを開き、エラーが出れば警告を出すのだが、このブロックの上下に変な記述がある。

これはおそらくコメントの言う「シリアルポートの開閉時に誤動作が発生しないよう回避している」部分であろう。
\sphinxcode{MainWindow.xaml}の、\sphinxcode{ConnectButton}に関する部分を見てみよう。

\sphinxcode{Checked}と\sphinxcode{Unchecked}は、いずれもボタンがクリックされた時に発生するイベントだ。
\sphinxcode{ConnectButton.Checked -= ConnectButton\_IsCheckedChanged;}などとしておくことで、ポートへの接続を試行している間ボタンのクリックを無効化しているようだ。
このコードを削除した状態でボタンを連打しても特に問題はなかったので効果のほどは分からないが、あっても害にはならないだろう。


\subsubsection{ポート一覧の更新}
\label{\detokenize{nissyu-idohen/pc-software-code:id16}}
ポート一覧のコンボボックスは、開くたびにシリアルポートを取得し直している。
\sphinxcode{portComboBox\_DropDownOpened()}に処理が書かれているが、\sphinxcode{Window\_Loaded()}と同じようなことをしているだけなので省略する。


\subsubsection{コマンド送信}
\label{\detokenize{nissyu-idohen/pc-software-code:id17}}
\sphinxcode{emitCommand()}は、コマンド文字列を与えて実行すると接続しているポートに送信してくれる。
\sphinxcode{serialPort.IsOpen}がfalseの時は、警告とともにコマンド文字列をMessageBoxに表示する。


\subsection{公演モード(誤操作防止モード)}
\label{\detokenize{nissyu-idohen/pc-software-code:id18}}
\sphinxcode{checkBox2}は公演モードのON/OFFを管理している。
公演モードは、日周を進める以外の機能を制限して誤操作を防ぐ為のものだ。
ただ、これもかなり直前になって放り込んだため無理やりな実装になっている。

他の関数等で公演モードかどうかいちいち判定する必要が出てきたので、\sphinxcode{isPerfMode}というbool値に記録するようにした。
たいへん紛らわしいが、\sphinxcode{diurnalMinusButton}が「日周進める」ボタンである。
実機で運用した際に、かごしいの実際の動きを合わせてラベルだけ交換したため逆になっている。


\section{NisshuidohenController.cs}
\label{\detokenize{nissyu-idohen/pc-software-code:nisshuidohencontroller-cs}}
さいたまに送るコマンド文字列を生成するための\sphinxcode{NisshuidohenController}クラスが実装されている。
27では、24が書いたものをほぼそのまま利用した。
一点のみ、日周・緯度のギヤ比の換算もこちらでやってしまうように変更した。
これで、クラスの外側からはかごしいを回したい角速度(1
deg/sなど)を指定すればいいようになった。

使うだけなら\sphinxcode{RotateDiurnalBySpeed()}や\sphinxcode{RotateLatitudeBySpeed()}をブラックボックスとして利用するだけでいいだろう。
ただし、23や25が使っていた角度指定メソッドは残してあるだけで一切触っていないので、使いたい場合はしっかりデバッグしてほしい。


\chapter{無線制御}
\label{\detokenize{wireless/wireless::doc}}\label{\detokenize{wireless/wireless:id1}}\begin{itemize}
\item {} 
書いた人：Kenichi Ito(nichiden\_27)

\item {} 
更新日時：2017/3/20

\item {} 
実行に必要な知識・技能：電子回路、マイコン

\item {} 
タスクの重さ: 5/準備だけで数ヶ月

\item {} 
タスクの必須度：4/毎年やるべき

\end{itemize}


\section{概要}
\label{\detokenize{wireless/wireless:id2}}
星座絵は、プラネのにとって重要な要素ですが、常に点けたままというわけにはいきません。
解説やソフトの流れに合わせてたくさんの星座絵をリアルタイムでオンオフできる必要があるのです。

ただ、星座絵投影機の本体は、他の主投影機同様日周緯度変装置により回転します。
そのため有線での制御は困難です。
そこで、日電では星座絵の制御に無線を採用してきました。


\section{沿革}
\label{\detokenize{wireless/wireless:id3}}

\subsection{16-21主投}
\label{\detokenize{wireless/wireless:id4}}
データとして共有されている限りの資料では、16日電が\sphinxstylestrong{FM変調方式}
の電波を採用していた。
FMとは周波数変調方式のことで、ある周波数を閾値として0か1かのデジタル信号を表すというわけだ。
ただし、高周波のノイズが紛れ込むと0が1に反転してしまう問題があり、誤り訂正の工夫をしていたようだ。

この頃の情報は不完全で、不明なことも多い。
19日電の資料には、北天側で信号を受信し、南天側のサブ機に有線で信号を送ったとの記述がある。
送信機・受信機にはPICマイコンを使っていたようだ。


\subsection{22主投}
\label{\detokenize{wireless/wireless:id5}}
22では、AM変調の無線モジュールとAVRマイコンを採用した。 英RF
Solutions社の\sphinxcode{AM-RT}/\sphinxcode{AM-HRR}というモジュールを使用していたようだ。

22星座絵は16個あり、16bit(2byte)のデータでオンオフを表現できる。
送信側はトグルスイッチ16個を並べた基板と接続しており、スイッチの状態を読み取って電波信号に換える。

南北の受信機の区別にも工夫があった。
ジャンパピンの位置で、上位・下位それぞれ8bitのどちらを読み取るか切り替えられる。
これにより、送信側からは南北まとめて信号を送り、受信側で南北を区別する仕組みだ。
\begin{figure}[htbp]
\centering
\capstart

\noindent\sphinxincludegraphics{{wireless-22}.jpg}
\caption{22星座絵受信機に貼られていたラベル}\label{\detokenize{wireless/wireless:id17}}\end{figure}

しかし、通信のエラーは排除しきれず、タイムラグも大きいものだった。


\subsection{23主投}
\label{\detokenize{wireless/wireless:id6}}
23日電になり、\sphinxcode{XBee}\sphinxstylestrong{が初めて採用された。}
\sphinxcode{Xbee}は、\sphinxcode{ZigBee}というプロトコルを使用した無線モジュールだ。
買ってきて設定するだけで、手軽に無線通信を使用できる。
ロボットやCanSat(模擬人工衛星)の大会でも多数のチームが採用しており、性能は折り紙つきである。

\sphinxcode{XBee}にはシリアル通信のように扱えるATモードと、\sphinxcode{XBee}自体を制御に使うAPIモードがある。
23で使ったのは前者で、送信側1台をPCに、受信側2台を南北それぞれの受信機回路に接続していた。

23では、これまでのように一方的にコマンドを送るだけでなく、\sphinxstylestrong{受信側の状態をフィードバック}
することでエラー検出・修正を試みた。
しかし、回路の不備で正しい応答が返らず、星座絵の操作はできたもののフィードバックは実現しなかった。

受信機の回路には22同様AVRマイコンが使われていた。
さらに、過電圧保護回路やトランジスタアレイでのポート制御など、以降の星座絵受信機の基本となる設計がこの時期に生み出されたと言える。
\begin{figure}[htbp]
\centering
\capstart

\noindent\sphinxincludegraphics{{wireless-23-circuit}.png}
\caption{23星座絵受信機回路図}\label{\detokenize{wireless/wireless:id18}}\end{figure}


\subsection{24主投}
\label{\detokenize{wireless/wireless:id7}}
24日電では23の設計を受け継ぎ、受信機を作り替えた。

また、PC操作用のソフト\sphinxcode{Constellation Picture Transmitter}が開発された。
黒基調のUIが採用され、「黄道十二星座」「夏の大三角」といった星座グループの一括オンオフにも対応している。
ただ、受信側からのフィードバックで表示を修正する機能はうまく動作しなかった模様である。
\begin{figure}[htbp]
\centering
\capstart

\noindent\sphinxincludegraphics{{constellation-picture-transmitter}.png}
\caption{Constellation Picture Transmitterの画面}\label{\detokenize{wireless/wireless:id19}}\end{figure}


\subsection{25主投}
\label{\detokenize{wireless/wireless:id8}}
25日電はPC側アプリケーションの改良を進め、\sphinxcode{Funabashi}を開発した。
しかし、不具合により本番で動かず、24の\sphinxcode{Constellation Picture Transmitter}に切り替えたという。

\sphinxcode{Fuinabashi}では24と同じように星座一覧から選ぶモードと、ソフトやライブ解説の指示に沿ってボタンが並ぶモードが用意された。
\begin{figure}[htbp]
\centering
\capstart

\noindent\sphinxincludegraphics{{funabashi}.png}
\caption{Funabashiのソフト指示画面}\label{\detokenize{wireless/wireless:id20}}\end{figure}


\subsection{26主投}
\label{\detokenize{wireless/wireless:id9}}
26でも\sphinxcode{Fuinabashi}の開発が続けられ、完成に至った。
一方、リハーサルの頃に予備も含めて受信機の故障が相次ぎ、本番時点で北天用一台しか使えない事態に発展した。

急遽解説で使用する星座を14個まで減らし、公演ごとに配線を繋ぎかえる方針で投影を試みた。
しかし、公演間の準備の手間が増えた上、イレギュラーな南北配線により電源喪失が数回発生してしまった。
このため、星座絵の全点灯は最終日になってようやく達成されたのだった。


\subsection{27主投}
\label{\detokenize{wireless/wireless:id10}}
26までの受信機が全て故障していたことから、再生産が急務となった。
ソフトの要望により、こうとうの無線によるオンオフにも挑戦した。

最終的に、\sphinxcode{XBee}からWi-Fi規格のモジュールに変更し、全主投影機をオンオフする能力を備えた\sphinxcode{Piscium}が新たな受信機として登場した。

また、Wi-Fi採用により送信側はPC単体で済むようになり、操作用Webアプリ\sphinxcode{Acrab}が作られた。
\begin{figure}[htbp]
\centering
\capstart

\noindent\sphinxincludegraphics{{acrab-main}.png}
\caption{Acrabのメイン画面}\label{\detokenize{wireless/wireless:id21}}\end{figure}

星座絵一覧から選ぶ方式は変わっていないが、内部処理が大きく変容している。
クリックでボタンのオンオフを切り替えるのではなく、受信機からの応答によって全ボタンの表示を更新する仕組みだ。
これにより、必ず実際の投影機と\sphinxcode{Acrab}の表示が同期する。
23から続いていた受信機からのフィードバック機能を初めて実用化したと言えるだろう。

また、「公演用」画面においてソフトの指示をファイルから読み込み、進む/戻るボタンで簡単に操作できるようにした。
本番中の負担が大きく軽減され、星座絵のメンバーにも操作を手伝って頂くことができた。
\begin{figure}[htbp]
\centering
\capstart

\noindent\sphinxincludegraphics{{acrab-scenario}.png}
\caption{Acrabの公演用画面}\label{\detokenize{wireless/wireless:id22}}\end{figure}

実装など詳細はPiscium・Acrabの個別記事に掲載する。


\section{無線通信の要件}
\label{\detokenize{wireless/wireless:id11}}
無線通信を実現する技術は、プラネの歴史を見ればわかるように様々である。
しかし、手法によらず達成しておくべき機能がいくつかある。

27の\sphinxcode{Piscium}や\sphinxcode{Acrab}固有の反省点については個別記事内で触れる。


\subsection{どの投影機を制御するか}
\label{\detokenize{wireless/wireless:id12}}
無線制御装置は、元より星座絵を遠隔で点灯させるために始まった。
しかし27では、その対象を全投影機に広げた。

ソフトの「星空が急に現れる」という演出の都合上、こうとうが確実に消える必要があったための措置である。
ところが本番での検証の結果、こうとうはあおとうで確実に搔き消え、しるとうのみの状態でも2等星が見えるか見えないかという状態だった。
こうとうが回路の不安定要素だったこともあり、オンオフは結局不要との結論に至ったのである。

むしろ、本番以上の時間を占める投影機調整で、主投が常時点灯せず、無線から一々操作が必要なのは日電にも各投影機にも大変なストレスであった。
調整時の負担を考えれば、こうとうとぎんとうを無線で操作できる仕様にはデメリットの方が大きいようだ。

一方で、あおとうの全点灯時にもいっとうだけは見えていた。
ドーム内が「昼間」の状態でも一等星の位置が分かるのは日周の位置合わせに便利だったが、昼間に星が見えるのは本来正しくない。

星空を再現するのであれば、\sphinxstylestrong{夕日が沈むのに合わせて一等星を少しずつ点灯させるのがベストだろう。}
一等星を個別に操作※するのは難しいにしても、いっとう全体をオンオフする演出を取り入れる価値はあるだろう。
ソフトや他の投影機と一度話し合っておいてほしい。

※とはいえ、いっとうと電源の間には既に「またたき回路」が挟まっている。またたき機能と無線機能を兼ね備えた新たな回路を作れば一等星を個別に操れるかもしれない。


\subsection{送信側と受信側の同期}
\label{\detokenize{wireless/wireless:id13}}
エアコンの赤外線リモコンを操作していて、障害物などで信号が届かなかった経験があるだろう。
こうした場合、リモコンの表示は「オン」なのに実際はオフ、といった食い違いが起こる。
ここからエアコンを起動するには、ボタンをさらに数回押してやらねばならない。

このように、操作対象と操作画面の状態がずれてしまうと混乱が生じやすい。
特に、数十の星座を番組進行に合わせてタイミングよく切り替えるプラネの現場ではなるべく避けたい事態だ。

これを解決するには、受信機が信号を受け取るたびに送信側に結果を通知する仕組みが有効である。
送信側の結果更新には受信機から受け取ったデータを使えば、\sphinxstylestrong{受信機の状態と画面の表示が必ず同期する。}

この手法にもデメリットはあり、送受信に時間がかかるような環境ではボタンを押してから表示が変化するまでにラグが発生してしまう。
現在使われるような高性能のモジュールではほぼ問題はなさそうだが、遅延が無視できない対策が必要だ。


\subsection{冗長化}
\label{\detokenize{wireless/wireless:id14}}
無線制御装置が本番で突然故障し、予備もないとしよう。
その瞬間から、星座絵は一つも点灯できず、星座絵メンバーの努力が水の泡となる。
このような恐ろしい事態を避けるために、二重・三重の対策が必要だ。

確実かつ思いつきやすいのが、\sphinxstylestrong{予備の受信機} を用意しておくことだ。
23〜25代の星座絵受信機は、ほぼ同じ設計のものが最終的に4台作られた。
これで、急に故障しても丸ごと交換してしまえば復旧できそうだ(故障原因を特定して潰せていればだが)。

全く同じものを作るのが難しくても、\sphinxstylestrong{壊れやすい部品の予備}
を手に届くところに用意しておくだけでもいい。
無線モジュールやマイコンが破損し、買いに行こうにも部品屋はもう閉まっている...といった最悪の事態を回避できる。
また、予備部品は不具合があった際の問題の切り分けにも役立つ。

別の方針として、\sphinxstylestrong{手動スイッチの追加} というのがある。
無線通信が絶たれても、受信機のところまで行って手で操作すれば投影機が点灯するというものだ。
回路が余計に複雑になるので27では見送ったが、検討の余地はありそうだ。


\subsection{電流管理}
\label{\detokenize{wireless/wireless:id15}}
投影機の光源は旧来の電球からLEDにシフトしつつある。
なかでも、強力な光源を必要とする主投影機が昨今相次いで採用しているのが、「パワーLED」だ。
パワーLEDは、一個で1Wや3Wといった大電力を消費する。
それを複数まとめて点灯させると、突入電流はかなりのものになることだろう。

過去の星座絵受信機の故障の原因の多くは、\sphinxstylestrong{想定を超えた過電流による端子の故障}
と考えられる。
27の\sphinxcode{Piscium}で、あえてトランジスタアレイを使わずFETを採用したのも、万一問題が起きても故障が高価な部品にまで及ばないようにするためだ。

すぐに目に見える故障が起きないとしても、大電流が流れる回路であることを意識して、アースの確保や導線の太さの選定などに気をつけてほしい。


\subsection{法令遵守}
\label{\detokenize{wireless/wireless:id16}}
今や、電波は我々の文明にとって欠かせない資源である。
わが国では、その利用について「電波法」で定めている。

無線局は誰でも勝手に設置して良いものではなく、原則として免許を受けねばならない。
ただし、無線LAN機器などはその例外にあたり、「\sphinxstylestrong{技適マーク}」が付いていれば国内で使用してよい。

国内の部品屋などで買える無線モジュールには大概技適マークが付いているので、気にせずに使っても構わない。
しかし、技適マークは日本国内でしか通用しないので、海外の端末やモジュールにはないことも多い。
海外通販で部品を買う場合は、日本の技適を通っているかよく確認するのが望ましい。


\chapter{無線制御(PISCIUM)}
\label{\detokenize{wireless/piscium::doc}}\label{\detokenize{wireless/piscium:piscium}}\begin{itemize}
\item {} 
書いた人：眞木俊弥

\item {} 
更新日時：2017/3/22

\item {} 
実行に必要な知識・技能：電子工作の経験，電子回路について一通りの知識，マイコン（Arduino,
PIC)，インターネットの仕組み

\item {} 
タスクの重さ: 4/一月はかかる

\item {} 
タスクの必須度：5/しないとプラネ終了/とりあえず前の年のものを使えるようにしておくこと，壊れてたら…頑張ってくれ…

\end{itemize}


\section{概要}
\label{\detokenize{wireless/piscium:id1}}
※とりあえず使えるようにするだけだったら，\sphinxstylestrong{概要}と\sphinxstylestrong{使い方}の部分を理解すれば大丈夫です。ブラックボックスになるように設計しました。ただ，故障した…とかいうことになったら，頑張って\sphinxstylestrong{技術仕様}のところを理解するか，いっそのこと全部作り直してください。

プラネタリウムの公演と，外で星をぼんやりみている時の差とは何でしょうか？
それは，ずばり，分かりやすい解説やワクワクするストーリーがあるないかです！
そして，その演出をサポートしてくれるものは何と言っても様々な神話や逸話に彩られた星座でしょう。
ただ，一般の人には満天の星空の中から星座を見つけ出すことは至難の技なので，プラネタリウムでは，「星座絵」を投影します。
そのため，ナレーションに合わせて星座絵を点灯・消灯する必要があります。
ただ，投影機からたくさん線を引き出してしまうと，日周・緯度の変化の際の回転で絡まってしまうため，我々のプラネタリウムでは，無線制御を行っています。

27代では，新たに無線制御装置を作り直しました。
その名も，\sphinxcode{PISCIUM}(Planetarium Integrated Stars and Constellation
Images Utility Module)です！！
（ちなみに，この名前は27日電長伊東氏の発案です。なお，私は長らく\sphinxcode{PISCUIM}だと勘違いしていて，ファイル名とかコメントとかを修正する無駄な手間が生じた記憶があります。）
\sphinxcode{PISCIUM}を使うことで，みなさんよくお世話になっているWi-Fiネットワークを介して，パソコン，スマホ，タブレットなどWi-Fiの接続可能な端末から星座絵などのかごしい内部の投影機を無線で制御できます。


\section{使い方}
\label{\detokenize{wireless/piscium:id2}}
\sphinxcode{PISCIUM}はそのほかのボックス類と同じように，（百均）タッパーを加工したケースに収められています。
かごしいの側面に固定して使うことを想定しています。
また，事前に部室にあるはずの無線Wi-Fiルーターの電源を入れておきましょう。
\begin{figure}[htbp]
\centering

\noindent\sphinxincludegraphics{{router_photo}.jpg}
\end{figure}

使用するには，電源を接続（27代ではパソコン用のATX電源とUSB充電器を使用）し，出力用の側面のDCジャックに星座絵などの投影機を接続してください。
使用している電源は，\href{http://www.kuroutoshikou.com/product/power/atx/krpw-l5-400w\_80\_/}{玄人志向の400Wの電源}です。
\begin{figure}[htbp]
\centering

\noindent\sphinxincludegraphics{{atx-dengen}.jpg}
\end{figure}

ATX電源は，20ピンATXと，6ピンPCI Express用のコネクタを使用しています。
\begin{figure}[htbp]
\centering

\noindent\sphinxincludegraphics{{電源コネクタ説明}.png}
\end{figure}

\sphinxcode{PISCIUM}を上から見たときに，DCジャックが見えていない方を下側面としたときに，
\begin{itemize}
\item {} 
上側面と右側面が星座絵(12V)。全部で16ポート。ポート1からポート16まで。

\item {} 
左側面が，上から，こうとう1(12V)，こうとう2(12V)，いっとう(5V)，ぎんとう(5Vまたは12V，内部のピンヘッダで切り替え可能,現在は12Vに設定してある。ピンヘッダは上と真ん中が接続されているときは12V,
真ん中と下が接続されているときは5Vになる)

\end{itemize}

となっています。 \sphinxincludegraphics{{PISCIUM端子番号}.jpg}

左側面だけは，こうとうやいっとうなど，特殊な投影機を接続するためにそのほかのDCジャックとは異なる仕様になっているので注意してください。
また，こうとうを星座絵の所などに接続すると，電力が大きすぎてよくないので，注意してください。
あと，いっとうだけは5Vなので，接続場所間違えるといっとうボックスが壊れます。

無線Wi-Fiルーターに自動的に接続されるので，ブラウザで特定のURLにアクセスすることで制御が可能になります。
ブラウザでの制御に関しては，伊東氏が開発したWebアプリケーション\sphinxcode{Acrab}があるので，そちらの説明を参照してください。

なるべくブラックボックスになるように設計したので，何とかなるはずです（だと信じたい）。


\subsection{使用上の注意点}
\label{\detokenize{wireless/piscium:id3}}\begin{itemize}
\item {} 
電源がついた状態での各投影機の抜き差しは故障の原因になるのでやめてください。

\item {} 
ATX電源には，大事な自作パソコンを守ってくれる安全装置が付いています。そのため，過電流，過電圧を感知すると自動的に電源が落ちます。PISCIUMの電源設計は甘々なので（すみません…），各投影機のオンオフ時の電圧サージに耐えられず，電源が落ちてしまうことがあります。その場合は，ATX電源の電源を手動で入れ直してください。
\begin{itemize}
\item {} 
ATX電源自体にスイッチがついていますが、かごしいに設置後は手が入らないので、かごしいに繋がる延長コードごと抜き差しするといいでしょう。

\item {} 
Wi-Fiモジュールが再起動した後、設定を送り直すため\sphinxcode{Acrab}のページを再読み込みする必要あり(これは欠陥なので改善されるべき)。

\end{itemize}

\item {} 
かごしいのグラウンドが弱いため，稼働している間に全体が帯電してしまうようです。
27代の公演でも，公演中に火花が飛び散り，空中放電して一瞬ブラックアウトしたことがあります。
\sphinxstylestrong{28の皆さんには，かごしいのアース接続を何とかしてほしいです。}
そうでないと最悪の場合，火花放電により出火します。
かごしい本体とは導通していることは確認しているので，かごしいか，それと導通しているごきぶりをアースしてください。
アースするときは，より線ではなく，単芯の太めの導線を使用し，体育館の柱など地面に突き刺さっている大きい金属に接続してください。
アースしただけで治るのかはよくわかりませんが，アースしてないのはまずいです。

\item {} 
また，グラウンドが弱く，サージに耐えられないので，こうとうの制御は現時点では不可能（電源が落ちてしまう）です。そのため，こうとうは付けっ放しにしておくのですが，最初に点灯するときに，やはり電源が落ちやすいので，何度かトライすることになります…（誰かなんとかしてー）

\item {} 
27代の本番では，こうとうが消えてしまって真っ暗になるリスクを回避するために，こうとうの電源は，\sphinxcode{PISCIUM}を通さず，ATX電源のPCI
Express
6ピンコネクタから直接給電するケーブルを作成し，こうとうを常時点灯かつ\sphinxcode{PISCIUM}の影響を受けないようにしました。

\item {} 
いっとうの制御は可能ですが，いっとうボックスの瞬き回路の起動に時間がかかり，点灯までにタイムラグが生じるので，現時点では行える状況にありません。

\item {} 
また，いっとうボックスの方にノイズが乗り，しばしばいっとうが映らなくなる事案が発生したので，本番は結局5Vの別のACアダプタを用意しました。5Vの電源をATX電源とは別に用意するのは無駄なので，できれば，SATAとかHDDとかのコネクタから5Vを取り出せるようなケーブルを新たに作成してほしいです。

\item {} 
以上のように，星座絵以外の制御は事実上できないような状況になってしまっています。

\end{itemize}


\section{技術仕様}
\label{\detokenize{wireless/piscium:id4}}
27代で作成したファイルは全て\href{https://github.com/macv35/nichiden27}{Githubレポジトリ}においてあります。


\subsection{回路}
\label{\detokenize{wireless/piscium:id5}}
主な部品としては，Wi-Fiの制御を行う\sphinxcode{ESP8266}というSoC(System on
Chip:
マイコン，通信制御回路などが一つのチップの中に収まっているもの）の開発ボード，\sphinxcode{ESP8266}からのシリアル通信を受信して各DCジャックを制御するPICマイコン，DCジャックの電流をスイッチングするFETから構成されています。
\sphinxincludegraphics{{PISCIUM_circuit}.png}

一見複雑そうに見えますが，DCジャックがたくさんあるだけです。
ただ，いかに単純な回路の反復とはいえども，これはんだ付けして作るのは地獄でした。
私はKiCadの配線図のピン番間違えてFETのはんだ付けし直すはめになったのですが，やばかったです。
みなさんも配線図書き終わったらじっくり見直すようにしましょう。無駄な仕事が増えます。


\subsection{ESP8266の開発ボード周りのソフトウェア}
\label{\detokenize{wireless/piscium:esp8266}}
（中華製の安物の）Wi-Fi入りマイコンボードを利用しています。
この\sphinxcode{ESP8266}は，\sphinxcode{Xtensa}というアーキテクチャを採用していますが，有志により，Arduino
IDEで開発できるようになっていて，Wi-Fiサーバーなどの高度なプログラムもライブラリとして整備されていて，我々素人にとっては非常に開発のしやすいモジュールです。
また，今回使用しているボードには，すでに書き込み用の回路も付いているので，USBでパソコンに接続するだけで開発できます。
ただ，USB-シリアル変換素子はArduino純正のものとは違うので，ドライバをインストールする必要があります。
USB-シリアル変換素子の型番は，\sphinxcode{CH340g}です。Githubとか製造元のサイトからドライバ落としてきてインスコしてください。
また，ボードの書き込み設定などは，\href{http://trac.switch-science.com/wiki/esp\_dev\_arduino\_ide}{このサイト}などを参照してください。
``ESP8266 書き込み''とかでググるとわんさか出てくるはずです。

27代が開発したプログラムは，\sphinxcode{ESP8266}上でwebサーバー（のようなもの）を動かし，特定のURIのGETリクエストを受け取ると，シリアル通信でPICマイコンに点灯状況を送信する形になっています。
IPアドレスは，固定IPで，北天が192.168.11.100，南天が192.168.11.101になっています。


\subsubsection{使い方}
\label{\detokenize{wireless/piscium:id6}}
\href{https://github.com/macv35/nichiden27/wiki/Piscium\#usage}{Wikiへのリンク}
\begin{quote}

Send GET request to certain url.
\begin{enumerate}
\item {} 
\sphinxstylestrong{Refresh Confirm}
(example) \url{http://(ip)/refresh\_confirm/status.json}

\item {} 
\sphinxstylestrong{Set Port} Set ON/OFF of each port.
(example) \url{http://(ip)/setPort/status.json?P01=0\&P02=1}

\item {} 
\sphinxstylestrong{Set Constellation Name}
Change names of pin used in communication.
(example)
\textgreater{}http://(ip)/setConstellationName/status.json?p01=And\&p02=Aql...

\item {} 
\sphinxstylestrong{All Set}
Set all port ON.
(example) \url{http://(ip)/allSet/status.json}

\item {} 
\sphinxstylestrong{All Clear}
Set all port OFF.
(example) \url{http://(ip)/allClear/status.json}

\end{enumerate}
\end{quote}

以上の5種類のコマンドが用意されています。
通常の公演時は，\sphinxcode{Acrab}がこの辺のことはやってくれるはずですが，回路関係のデバッグをする際には，手持ちのスマホとかでこれらのURIにアクセスしながらやると楽です。

\sphinxcode{ESP8266}が正しくURIをパーズすると，シリアル通信（UART）でPICマイコンにコマンドが送られます。
``NS''の2文字を送ったあとに，各DCジャック（ポート）20個分の点灯状況を点灯の時''1''，消灯の時''0''として，20文字分送ったあとに，23文字目に''\textbackslash{}n''（改行）をパケットとして送るプロトコルを使用しています。
名付けてNS（Nichiden Seizae）プロトコル…雑です，はい，すみません。
まあ，どうせUARTなんだし，こんな雑なプロトコルでも問題は起きていませんのでご安心を。

また，UARTでPICにパケットが送られるのと同時に，GETリクエストに対して，現在のステータスを表したjsonを返します。

参考までに，ソースコードのリンクをつけておきます。
（汚いのであんまり見ないでー。URIパーザーの部分とかは他のクラスに分けるとかするべきだった。）

\href{https://github.com/macv35/nichiden27/blob/master/PISCIUM/PISCIUMServer/PISCIUMServer.ino}{Arduinoのスケッチ}


\subsection{PICマイコンのソフトウェア}
\label{\detokenize{wireless/piscium:pic}}
\sphinxcode{ESP8266}から送られてきたシリアル通信をデコードして各ポートのFETをオンオフするだけの子なので，大したことはしてないです。
\sphinxcode{ESP8266}は3.3V駆動なのに対して，PICは5Vで駆動しているので，間にシリアルレベル変換素子は入れてあります。
MPLAB
Xのプロジェクトファイルが引き継ぎ資料の\sphinxcode{/pic\_decoder/}ディレクトリに入っています。
もし万が一，PICが壊れたりした場合は，\sphinxcode{PICkit3}を差し込めるピンヘッダを用意しておいたので，PICを交換して書き込み直してください。
書き込み方は，\href{http://ww1.microchip.com/downloads/jp/DeviceDoc/52010A\_JP.pdf}{PICkit3の使い方}をみてください。


\chapter{またたき回路}
\label{\detokenize{twinkle::doc}}\label{\detokenize{twinkle:id1}}\begin{itemize}
\item {} 
書いた人: Kenichi Ito(nichiden\_27)

\item {} 
更新日時: 2017/03/25

\item {} 
実行に必要な知識・技能:

\item {} 
タスクの重さ: 3/数週間

\item {} 
タスクの必須度: 2/たまにやるべき

\end{itemize}


\chapter{配線}
\label{\detokenize{haisen::doc}}\label{\detokenize{haisen:id1}}\begin{itemize}
\item {} 
書いた人: Kenichi Ito(nichiden\_27)

\item {} 
更新日時: 2017/03/10

\item {} 
実行に必要な知識・技能: 特になし

\item {} 
タスクの重さ: 2/数日かかる

\item {} 
タスクの必須度: 5/しないとプラネ終了

\end{itemize}


\section{概要}
\label{\detokenize{haisen:id2}}
配線には、特別な知識や技能は不要です。
ただし、プラネの大部分には電源が欠かせません。
配線のミスはプラネ全体に響きます。特に入念に準備をするようにしてください。


\section{配線を行うタイミング}
\label{\detokenize{haisen:id3}}
配線を実際に行うのは、
\begin{itemize}
\item {} 
卒検

\item {} 
リハーサル

\item {} 
本番前日準備

\end{itemize}

の三回。
卒検・リハと本番では、ドームの展開場所が屋外か屋内かという大きな違いがある。

卒検段階では投影機は一部しか運用されないので、全てを配線する必要はない。
ただし、リハ以降の練習ができる唯一の機会でもあり、大した負担でもないので全て配線してしまってもいいだろう。

リハでは、補助投の設置状態などがほぼ確定している。
補助投の仕様変更などを把握し、本番同様の状態を構築できるのが望ましい。

前日準備はとにかく時間との戦いになる。
配線の遅れが投影機調整の遅れ、公演開始の遅れと連鎖してしまうこともある。
コードをつなぐだけなので、手の空いた補助投の人に協力してもらっても構わない。


\section{配線計画}
\label{\detokenize{haisen:id4}}

\subsection{電力計算}
\label{\detokenize{haisen:id5}}
体育館には、使用できる電力に制限がある。
ブレーカーが落ちないよう、館内で個人的な充電等をしないよう注意されたのを覚えているかもしれない。
実際には滅多に起きないことだが、もし起こしてしまえば即企画停止である。
各投影機が使用する電力を把握し、負担を分散させることは大変重要だ。

各投影機の消費電力は、白熱球やハロゲンランプからLEDへの移行によって減少傾向にある。
ただ、あおとうやソフトなど大電力を要求する投影機があるため、急激に上下することはない。
毎年3000W前後であり、大学側への申請は更に余裕をみて\sphinxstylestrong{3500W}
としてある。

参考までに、27で計算した電力を掲載する。数値は概略である。
投影機仕様に大幅な変更があれば、必要に応じて再計算して欲しい。

\noindent\begin{tabulary}{\linewidth}{|L|L|L|L|L|}
\hline
\sphinxstylethead{\relax 
投影機
\unskip}\relax &\sphinxstylethead{\relax 
種別
\unskip}\relax &\sphinxstylethead{\relax 
使用数
\unskip}\relax &\sphinxstylethead{\relax 
電力{[}W{]}
\unskip}\relax &\sphinxstylethead{\relax 
電圧{[}V{]}
\unskip}\relax \\
\hline
こうとう
&
パワーLED3W
&
32
&
100
&
12
\\
\hline
いっとう
&
LED
&
20
&
2
&
5
\\
\hline
星座絵
&
パワーLED1W
&
28
&
30
&
12
\\
\hline
ぎんとう
&
パワーLED1W
&
4
&
4
&
12
\\
\hline
ドーム
&
ダクト用ファン
&
3
&
200
&
交流100
\\
\hline
ソフト
&
スピーカーなど
&
\textasciitilde{}
&
1000
&
交流100
\\
\hline
日周緯度変
&
モータ
&
2
&
100
&
24
\\
\hline
あおとう
&
白熱球
&
8
&
1000
&
交流100
\\
\hline
あくとう
&
パワーLED1W
&
30
&
40
&
12
\\
\hline
あゆとう
&
白熱球
&
1
&
100
&
交流100
\\
\hline
しるとう
&
パワーLED1W
&
8
&
24
&
12
\\
\hline
りゅうとう
&
?
&
?
&
100
&
?
\\
\hline
\sphinxstylestrong{合計}
&
\textasciitilde{}
&
\textasciitilde{}
&
\sphinxstylestrong{2700}
&
\textasciitilde{}
\\
\hline\end{tabulary}



\subsection{電力配分}
\label{\detokenize{haisen:id6}}
第二体育館の電源系統は一つではなく、4つに分かれている。
一つの系統に負担が集中しすぎると、落ちてしまうというわけだ。
\begin{figure}[htbp]
\centering
\capstart

\noindent\sphinxincludegraphics{{haisen-gym}.jpg}
\caption{体育館配線}\label{\detokenize{haisen:id19}}\end{figure}

この画像は、23代の頃作成されたもので出典不明だが、日電の配電計画はここに書かれた数字を元に決定されてきた。
しかし、配線の根元となる \sphinxstylestrong{コードリールの定格が1500W}
であり、1500Wを目安とするのが安全だろう。

二体の南と東向きの壁面がA系統、西側がB系統、女子更衣室前とトイレ前がそれぞれC系統とD系統となっている。

現在の配分では、用途別に四系統に振り分けている。
\begin{itemize}
\item {} 
A系統: ダクト・かごしい(主投)・スピーカーアンプ

\item {} 
B系統: その他(ドーム外の作業や充電用)

\item {} 
C系統: 補助投

\item {} 
D系統: 日周緯度変・PC・ミキサ

\end{itemize}

ソフト関連は、PCのノイズが影響しないようアンプとそれ以外を分ける慣例となっている。
また、主投と補助投は別電源にするなどリスクを抑える工夫がある。


\subsection{配線図}
\label{\detokenize{haisen:id7}}
電力配分が決まったら、配線図を作成する。
配線図は毎年作成されているものではなく、実際数年で大きくは変わらないので流用してもいい。
ただし、配線の様子を頭に入れるには、実際に図を書いてみるのが有効だろう。

27で更新した配線図を掲載しておく。
配線図はドーム内で作業中に繰り返し参照することになるので、各自の端末にすぐ表示できるようにしておくと良い。
\begin{figure}[htbp]
\centering
\capstart

\noindent\sphinxincludegraphics{{haisen-27}.jpg}
\caption{27配線図}\label{\detokenize{haisen:id20}}\end{figure}


\section{コードの管理}
\label{\detokenize{haisen:id8}}

\subsection{在庫調査}
\label{\detokenize{haisen:id9}}
卒検やリハの前に、人数が集まる機会を狙ってコードの在庫調査をしておきたい。
込み入った作業ではないので、数時間かければ終わる。

部室の機材などがある側に、延長コードが入った大きなケースがある。
大量の金属が入っているのでかなり重いので運ぶときは注意。
27まではダンボールに入っていたが、中身の重さで破れてしまうのでプラスチックのケースに変更した。

山ほどコードがあるように見えるが、プラネがフル稼働するとギリギリの数しかないので必ず全てあるか確認すること。プラネ作業中は他の投影機が持ち出していたりすることも多々ある。

コードには、番号を書いたテープが付いている(番号がないものは予備である)。
適切な長さや口数のものが使えるよう、通し番号で管理されているのだ。27で長さや口数の調査をしたので、結果を掲載する。

\noindent\begin{tabulary}{\linewidth}{|L|L|L|}
\hline
\sphinxstylethead{\relax 
通し番号
\unskip}\relax &\sphinxstylethead{\relax 
用途
\unskip}\relax &\sphinxstylethead{\relax \unskip}\relax \\
\hline
1-8
&
C(to22)あおとう配線
&
1：3m (分岐用) ２-6：5m 7,8：5m(端っこ)
\\
\hline
9-16
&
C(to22)しるとう配線
&
9：3m(分岐用) 10-14：5m 15,16：5m(端っこ)
\\
\hline
17-21
&
C方位とう配線
&
17:3m(3) 18,19:10m(1) 20:5m(1) 21:5m(3)
\\
\hline
22
&
Cあお、しる、方位コントローラ用
&
3m 4口
\\
\hline
23
&
Dプロジェクター用
&
5m 1口
\\
\hline
24
&
A(to32)かごしい用
&
2m 1口
\\
\hline
26-30
&
C補助用
&
30:タップ 26-28:2m(3) 29:2m(1)
\\
\hline
31
&
Dさいたま、PC
&
タップ
\\
\hline
32
&
A分岐アンプかごしい
&
4m(1)
\\
\hline
33
&
A(to32)アンプ
&
2m(3)
\\
\hline
34
&
A(to24)かごしい本体
&
3m(4)
\\
\hline
35-37
&
A ダクト
&
35:4m(1) 36:14m(1) 37:15m(1)
\\
\hline
外1-4
&
外
&
20m,20m,15m,15m
\\
\hline\end{tabulary}


毎年長さを測る必要はなく、直近で調査がなされているなら全部の番号があるかだけ調べれば良さそうだ。

これとは別に、コンセントが四口あるコードリールが部室に5つある。


\subsection{コードの買い増し}
\label{\detokenize{haisen:id10}}
延長コードは既製品で、簡単に切れたりはしないので買い替えのスパンは長い。
また、現状の量で本番に対応できているのでこれ以上増やす必要性はあまりない。
古かったり汚れが気になるものを適宜買い換える程度で大丈夫だろう。

パソコン用の電源タップは壊れると替えが効かず、またスイッチが光るタイプはドームを暗くした時に邪魔なので、光らないものを買ってもいいかもしれない。


\section{ドーム外配線}
\label{\detokenize{haisen:id11}}

\subsection{卒検・リハ}
\label{\detokenize{haisen:id12}}
卒検やリハ時のドーム外配線は、本番にはない屋外作業となる。各投影機が予定通り調整できるよう、確実に配線しておきたい。


\subsubsection{タイムスケジュール}
\label{\detokenize{haisen:id13}}
ドームを膨らませる前に\sphinxstylestrong{ダクトの配線}
だけは完成していなければならないので、機長会議で予定時刻を確認して計画を立てよう。
早朝から開始となるので、前日の夜間に最低限二人は参加しておくのが望ましい。
なお、日電は基本的に配線優先のため\sphinxstylestrong{ドーム作業が全て免除される。}


\subsubsection{トレ体}
\label{\detokenize{haisen:id14}}
当日、電源は\sphinxstylestrong{トレーニング体育館(トレ体)と第一体育館(一体)}
から取っていいことになっている。
トレ体が5:00に開くので、まずはトレ体からドームの場所までコードを引っ張ろう。
入り口から入り、左の廊下に曲がってすぐの場所にコンセントがある。

ここで注意だが、人が通る場所では
\sphinxstylestrong{引っかからないようコードを固定しなければならない。}
養生テープを用意し、一定間隔に貼っておこう。これは卒検やリハに限らず、本番でも必要なことだ(しかし、地面が濡れていて固定が難しいこともあるので臨機応変に)。
\begin{figure}[htbp]
\centering
\capstart

\noindent\sphinxincludegraphics{{haisen-tape}.jpg}
\caption{テープでコードを固定した例}\label{\detokenize{haisen:id21}}\end{figure}


\subsubsection{一体}
\label{\detokenize{haisen:id15}}
ドームが膨らみ終わる頃には一体が開いているので、一体からもコードを引いてこよう。
一体のコンセントは差込みがゆるく抜けてしまうことがあったので、テープで念入りに固定しておくと良い。


\subsubsection{危険箇所}
\label{\detokenize{haisen:id16}}
配線が切れてしまいがちな場所と、対策を列挙する。
\begin{itemize}
\item {} 
コンセント: テープで固定する

\item {} 
ドア(開閉で引っ張られる): ドアの下をくぐらせるか、コードをたるませる

\item {} 
コード同士の接合部: テープを巻いて補強

\end{itemize}


\subsection{本番}
\label{\detokenize{haisen:id17}}
屋内でコードを引っ張るだけなので、卒検やリハよりは楽なはずだ。
かなり床が冷える中二体中を歩き回るので、スリッパの用意があると幸せになれる。

二体のコンセントも、グラグラしているものや壊れているものがある。コンセント周辺は抜けないように念入りに固定し、できれば注意書きもあるとなおよい。

コードの固定は、広大な二体のあらゆる場所で行うのは無理があるためできる範囲で。ただし、C系統(女子更衣室前)から\sphinxstylestrong{入り口を横切る部分}
はお客様が大勢通るので、コードが浮かないようにしておこう。


\section{ドーム内配線}
\label{\detokenize{haisen:id18}}
ドーム内配線は、本番までやることがそう変わらない。
星潰しが終わる頃にコードを搬入し、配線図を見ながらコードを繋げていこう。

ソフトには、どのコンセントを使っていいか伝えておけば音響の配線を進めてくれる。
ドーム外周のあお・しる・方位については、日電で配線してしまっても補助投に任せてもいい。
任せる場合は\sphinxstylestrong{どれがどの投影機の配線かわかるよう、置き方などを工夫}　しよう。

ドーム内は末端の投影機の線が抜けても繋ぎ直せばいいだけだが、\sphinxstylestrong{コードリールの根元}
などは余裕があるときに固定をしておく方が良い。
\sphinxstylestrong{ドームのダクトコンソール}
も、線が抜けるとドームがしぼんで慌てることになるので、テープを巻いておくべきだ。

本番では、ドーム内にお客様が大勢入られるので、対策が必要だ。
ケーブル類はできるだけスタッフ席側を通るべきだが、その上で銀マットなどを敷いて隠すようにする。


\chapter{配線(かごしい内)}
\label{\detokenize{haisen-kagoshii::doc}}\label{\detokenize{haisen-kagoshii:id1}}\begin{itemize}
\item {} 
書いた人: Kenichi Ito(nichiden\_27)

\item {} 
更新日時: 2017/03/25

\item {} 
実行に必要な知識・技能:

\item {} 
タスクの重さ: 1/数時間で可能

\item {} 
タスクの必須度: 4/毎年やるべき

\end{itemize}


\chapter{備品管理}
\label{\detokenize{bihin::doc}}\label{\detokenize{bihin:id1}}\begin{itemize}
\item {} 
書いた人: Kenichi Ito(nichiden\_27)

\item {} 
更新日時: 2017/03/25

\item {} 
実行に必要な知識・技能:

\item {} 
タスクの重さ: 1/数時間で可能

\item {} 
タスクの必須度: 2/たまにやるべき

\end{itemize}


\section{概要}
\label{\detokenize{bihin:id2}}
(執筆中)


\section{日電カゴ}
\label{\detokenize{bihin:id3}}

\section{部室の部品}
\label{\detokenize{bihin:id4}}

\section{部室の工具}
\label{\detokenize{bihin:id5}}

\chapter{主投影機との連携}
\label{\detokenize{syutou::doc}}\label{\detokenize{syutou:id1}}\begin{itemize}
\item {} 
書いた人: Kenichi Ito(nichiden\_27)

\item {} 
更新日時: 2017/03/25

\item {} 
実行に必要な知識・技能:

\item {} 
タスクの重さ: 2/数日かかる

\item {} 
タスクの必須度: 3/年による

\end{itemize}


\section{概要}
\label{\detokenize{syutou:id2}}
駒場祭プラネでは、ほぼ全ての主投が電気に関わる作業をすることになります。
残念ながら、電子回路の知識が不十分なまま主投の作業を進めてしまう例も過去にありました。
主投の回路にミスがあると卒検やリハで上手く動かないのはもちろん、最悪の場合\sphinxstylestrong{日電側の重要機器が壊れる}
こともあり得ます。

忙しくなってから無用な手間をかけずに済むよう、早めに各主投の機長と情報交換を行いましょう。


\section{こうとう}
\label{\detokenize{syutou:id3}}
こうとうのモジュールは年々改良が進んでおり、引き継ぎも十分に行われている。
とりわけ26代で再設計されたユニットは、LEDの放熱も考慮されており、耐久性にも優れている。
3WのパワーLEDを光らせるだけの回路なので、特に頼まれない限り日電が補助する必要はないだろう。

ただし、32個のユニットを全点灯すると、南北合わせて100W近く消費することになる。
こうとうへの電力を供給する回路やケーブルは、\sphinxstylestrong{大電流に耐えられる}
ものにするよう注意されたい。

\sphinxstyleemphasis{主な使用部品}
\begin{itemize}
\item {} 
\href{http://akizukidenshi.com/catalog/g/gI-08956/}{放熱基板付3W白色パワーLED}

\item {} 
\href{http://akizukidenshi.com/catalog/g/gM-04487/}{定電流方式ハイパワーLEDドライバモジュール(3W1個点灯)}

\end{itemize}


\section{いっとう}
\label{\detokenize{syutou:id4}}
いっとうは星の色を再現するため多様な色のLEDを用いる。
引き継ぎ資料が充実しており、LEDの抵抗計算も解説されている。

使用しているLEDの型番などは確認していないが、\href{http://www.led-paradise.com/}{LEDパラダイス}などで直系の大きいLEDを入手しているそうだ。
パワーLEDではないため、電力についてはそれほど気にしなくていいはず。気になるならいっとう側に確認してほしい。

またたき回路の開発は基本的に日電に一任されている。
頃合いを見て、またたき具合や種類の希望がないか機長に聞き取りをしておこう。


\section{ぎんとう}
\label{\detokenize{syutou:id5}}
消滅と復活を繰り返していたが、最近はクオリティが上がっている投影機。
光源は1Wの白色パワーLED。

27代で\sphinxstylestrong{調光機能} が新設された。
投影された天の川が明るすぎ、恒星をかき消してしまう事態を避けるためである。
位置調整の時は明るくするなどの応用もできる。

調光には、あくとう・しるとうと同様「定電流方式ハイパワーLEDドライバモジュール」に載っている\sphinxcode{CL6807}の機能を用いる。
27日電では、PWMを使うべきと思い込んでいたため\href{http://akizukidenshi.com/catalog/g/gK-06244/}{手軽にPWM信号を作れるキット}を使用した。
ドライバモジュール側とキットでGNDを合わせる必要があることから、多少改造して使っている。

ただしその後、\sphinxcode{CL6807}の調光は電位の変化によっても可能であることが分かった(補助投の記事参照)。
抵抗二つと可変抵抗一つで調光できてしまうので、PWMに比べて部品点数やサイズが大幅に減る。

今後のぎんとうでは、電位による調光を使っていくべきだろう。
先方と調整の上、部品買い出しなどのサポートを行って欲しい。

\sphinxstyleemphasis{主な使用部品}
\begin{itemize}
\item {} 
\href{http://akizukidenshi.com/catalog/g/gI-03709/}{放熱基板付1W白色パワーLED}

\item {} 
\href{http://akizukidenshi.com/catalog/g/gM-04488/}{定電流方式ハイパワーLEDドライバモジュール(1W3個点灯)}

\item {} 
\href{http://akizukidenshi.com/catalog/g/gK-06244/}{PWM(スイッチング方式)DCモーター速度可変キット}:
\sphinxstylestrong{今後の使用は非推奨}

\end{itemize}


\section{星座絵}
\label{\detokenize{syutou:id6}}
星座絵は、1W白色パワーLEDを使用している。
過去にLEDを抵抗なしで回路に繋ぐ、極性を間違えるなどの事象があり、\sphinxstylestrong{無線受信機の故障原因を作った可能性もある。}

代によって知識に差があるのは当然なので、日電側からも基本的な知識については確認しておこう。

\sphinxstyleemphasis{主な使用部品}
\begin{itemize}
\item {} 
\href{http://akizukidenshi.com/catalog/g/gI-03709/}{放熱基板付1W白色パワーLED}

\item {} 
\href{http://akizukidenshi.com/catalog/g/gM-04488/}{定電流方式ハイパワーLEDドライバモジュール(1W3個点灯)}

\end{itemize}


\section{ドーム}
\label{\detokenize{syutou:id7}}
ドームを膨らませる際に使う\sphinxstylestrong{ドームコンソール}(ダクトコントローラー)のメンテナンスは日電管轄である。
ドームを直立させるため、3つのダクトそれぞれの風量を調節できるようになっている。
\begin{figure}[htbp]
\centering
\capstart

\noindent\sphinxincludegraphics{{ductcontroller}.jpg}
\caption{ドームコンソールの外観}\label{\detokenize{syutou:id11}}\end{figure}

中には秋月電子の\href{http://akizukidenshi.com/catalog/g/gK-00098/}{トライアック万能調光器キット}が3つ入っている。
交流の波形を変えることで出力パワーを変更するキットである。

破損の可能性があるのは基本的にトライアックなので、万一故障してもトライアックを替えれば復活するかもしれない。
大電流から回路を保護するためヒューズがついているので、切れた場合は部室の予備と交換しよう。

上側のスイッチでFULL/OFF/CONTROLの切り替え、下側のツマミで風量調節をする。
内部を見ればわかるが、FULLは入力・出力を直接繋ぐので、キットが使えなくなったとしても送風を継続できる。
\begin{figure}[htbp]
\centering
\capstart

\noindent\sphinxincludegraphics{{ductcontroller-instruction}.png}
\caption{ドームコンソールの使い方}\label{\detokenize{syutou:id12}}\end{figure}

2016年現在、24のドームコンソールが現役である。 以下は当時使用した部品。
\begin{itemize}
\item {} 
タカチ MB-6 W140 H75 D200 ¥1,092

\item {} 
マル信無線 MSR-6\#7 中点OFFロッカスイッチ ¥158

\item {} 
ロッカスイッチ 秋月AJ8221B ¥100

\item {} 
ベターキャップ WH4015PK ¥115 マルツ

\item {} 
ベターコネクタ

\item {} 
トライアック調光器40A ¥800

\item {} 
ユニバーサル基板 48 mm * 72 mm

\item {} 
ヒューズホルダ（パネル取り付け・ミゼット用） ¥84

\end{itemize}


\section{ソフト}
\label{\detokenize{syutou:id8}}
早いうちに連絡を取っておくべきである。
代ごとのソフトの方針によって、日周緯度変や無線制御などに手を加えるべきか否かが左右されるためだ。


\section{かごしい}
\label{\detokenize{syutou:id9}}
主投を組み立てる際には日電と一体になって動くことが多い。
かごしいは機構部分、日電は回路部分との暗黙の住み分けがある。

かごしい内のAC100Vケーブルの配線はかごしいに引き継がれているが、実際は日電が行うこともあるので資料を見せてもらうと良いだろう。
かごしい内配線については別記事で詳しく扱う。


\section{展示}
\label{\detokenize{syutou:id10}}
展示は、電気を使った模型を製作したこともあるが、基本的には電気と関わりのない唯一の主投と言っていい。
27代では、無線制御システムの解説ポスターを作成し、印刷と展示を依頼した。


\chapter{補助投影機との連携}
\label{\detokenize{hojotou::doc}}\label{\detokenize{hojotou:id1}}\begin{itemize}
\item {} 
書いた人: Kenichi Ito(nichiden\_27)

\item {} 
更新日時: 2017/03/25

\item {} 
実行に必要な知識・技能:

\item {} 
タスクの重さ: 2/数日かかる

\item {} 
タスクの必須度: 3/年による

\end{itemize}


\section{概要}
\label{\detokenize{hojotou:id2}}
(執筆中)


\section{あおとう}
\label{\detokenize{hojotou:id3}}

\section{あくとう}
\label{\detokenize{hojotou:id4}}

\section{あゆとう}
\label{\detokenize{hojotou:id5}}

\section{しるとう}
\label{\detokenize{hojotou:id6}}

\section{りゅうとう}
\label{\detokenize{hojotou:id7}}

\chapter{部品の買い方}
\label{\detokenize{begginers/buy_parts::doc}}\label{\detokenize{begginers/buy_parts:id1}}\begin{itemize}
\item {} 
書いた人: Kenichi Ito(nichiden\_27)

\item {} 
更新日時: 2017/02/17

\item {} 
実行に必要な知識・技能: 秋葉原の土地勘

\item {} 
難易度: 2/少しやれば可能

\item {} 
情報の必須度: 3/必要な場合がある

\end{itemize}


\section{概要}
\label{\detokenize{begginers/buy_parts:id2}}
回路を設計したら、部品を買いましょう。
日電は重要なので予算はある程度優遇されますが、無限ではないのでできれば安く手に入れたいところです。
通販は便利ですが、回数が重なると送料が無視できません。
せっかく東京にいることだし、(2年秋に本郷に通う人は特に)秋葉原に通うことをオススメします。


\section{リアル店舗で買う}
\label{\detokenize{begginers/buy_parts:id3}}

\subsection{全体の注意}
\label{\detokenize{begginers/buy_parts:id4}}\begin{itemize}
\item {} 
ほぼ大体10割くらい秋葉です

\item {} 
自分の経験と勘に絶対の自信がある人以外は、買うものの\sphinxstylestrong{型番を}メモすべし
\begin{itemize}
\item {} 
名称が似ていても仕様が違ったりするので、型番で！！！

\end{itemize}

\item {} 
予備を絶対に買うこと
\begin{itemize}
\item {} 
壊れやすい部品(ICとか)は特に注意

\end{itemize}

\end{itemize}


\subsection{秋葉原電気街へのアクセス}
\label{\detokenize{begginers/buy_parts:id5}}\begin{itemize}
\item {} 
駒場から
\begin{itemize}
\item {} 
山手線に乗り、秋葉原駅で降りる

\item {} 
銀座線に乗り、末広町駅で降りる

\end{itemize}

\item {} 
本郷から
\begin{itemize}
\item {} 
徒歩で
\begin{itemize}
\item {} 
キャンパス内の位置にもよるが、30分足らずで移動できる

\item {} 
湯島や外神田を散策できるので、余裕のある日は是非

\end{itemize}

\item {} 
電車で
\begin{itemize}
\item {} 
根津駅から千代田線で新御茶ノ水駅まで移動

\item {} 
御茶ノ水からは徒歩

\item {} 
電気街は秋葉原駅より西側なので、思いのほか早く着く

\end{itemize}

\item {} 
バスで
\begin{itemize}
\item {} 
正門前や赤門前から\sphinxcode{茶51}系統で万世橋まで

\item {} 
本郷二食前から\sphinxcode{学07}系統で御茶ノ水駅前まで

\item {} 
徒歩が少なくて楽

\end{itemize}

\end{itemize}

\end{itemize}


\subsection{秋月電子通商}
\label{\detokenize{begginers/buy_parts:id6}}
迷ったらここ。大抵のものは揃う上価格も安い。

ただ店内が狭く、平日昼間とか以外はすごく混雑するので注意。
あと初見だと棚の配置が分からない。店内に地図があるはずなのでまずはゲットしよう。

\href{http://akizukidenshi.com/}{ネット通販}もあるので、店員に質問するときは通販のページを見せながらだとスムーズかと。
とにかく部品の種類が凄いので見つからないと思ったら臆せず聞くべし。

ここの1000円のお楽しみ袋は伝説。初心者は勉強のために一回は買ったほうがいいだろう。


\subsection{千石電商}
\label{\detokenize{begginers/buy_parts:id7}}
第二選択肢。秋月より広く三号店まであるものの、値段が全体的に高い。

秋月では揃わないコネクタや工具、切り売りの線材などはここで入手しよう。
会計は各フロアで行わないといけないので注意。


\subsection{西川電子}
\label{\detokenize{begginers/buy_parts:id8}}
総武線の高架近くにある店。「ネジ」と「コネクタ」に強いとされる。
特にネジは一通り揃っているのは秋葉でもここくらいで、ハ◯ズなんかよりずっと安価で手に入るので近くを訪れた際はぜひ寄ろう。
また、二階のヒロセや日圧のコネクタもたいへん充実している。

鈴商亡き今、秋葉の部品屋の「人情」みたいなものを感じられる店の一つかも。
秋月や千石からすると閑散としていて心配だからみんな買いに行こうな。


\subsection{akibaLEDピカリ館}
\label{\detokenize{begginers/buy_parts:akibaled}}
秋月、千石と同じ並びにあるLED専門店(!)。夕方に通ると大変まぶしい。

秋月がパワーLEDの店頭在庫を切らしていた時に助けてもらった。
値段は秋月と同じくらいだったと思う。とにかくLED関連の品揃えが凄いので時間が余ったら寄ると面白いかも。

なお、これを運営している（株）ピースコーポレーションは\href{http://www.led-paradise.com/}{LEDパラダイス}というLED通販サイトも手がけている。


\subsection{マルツ秋葉原本店/2号店}
\label{\detokenize{begginers/buy_parts:id9}}
言わずと知れた通販大手だが店舗も全国に点在している。
秋葉には本店と2号店があり、後者は秋月のはす向かいのブロックにあるので行きやすい。

近くに秋月千石の二強がある以上、ここで買い物する機会は多くないが、実は夜に真価を発揮する。
秋葉の部品屋は19時くらいまでに軒並み閉まってしまうのに、ここは20:00まで開いている。
今すぐに欲しい部品がある場合は駆けこもう。

また2号店の入り口近くには怪しい電源装置が特価で置いてあったりする。


\subsection{鈴商}
\label{\detokenize{begginers/buy_parts:id10}}
今はないお店。千石〜秋月〜マルツの並びにあった老舗だが、\href{http://rocketnews24.com/2015/11/27/671666/}{2015年11月に閉店}。跡地には秋葉原神社という謎の施設が入った。


\subsection{ラジオデパート}
\label{\detokenize{begginers/buy_parts:id11}}
総武線の高架沿い、西川電子と同じ並びにある。

行ったことがないので不明だが、多数の部品屋が入居しており、珍しい部品があるかもしれない。


\section{ネットで買う}
\label{\detokenize{begginers/buy_parts:id12}}

\subsection{全体の注意}
\label{\detokenize{begginers/buy_parts:id13}}\begin{itemize}
\item {} 
まともなサイトは仕様をまとめたデータシートをPDFなどで配布している

\item {} 
必ず確認してから買おう!

\item {} 
データシートなしの部品には手を出さないのが無難

\item {} 
送料・納期を確認すべし

\item {} 
領収書は、納品書+支払いの証拠(振込の明細書など)とするのが基本

\item {} 
電子部品は店の選択肢が少ないのでこうするしかないようです

\end{itemize}


\subsection{秋月電子通商}
\label{\detokenize{begginers/buy_parts:id14}}
送料一律500円。お店に行く時にもここで予習しておくと便利。
そのうち本店での商品位置情報が分かるアプリがリリースされるらしい。


\subsection{千石電商}
\label{\detokenize{begginers/buy_parts:id15}}
これも予習に使える。送料432円。


\subsection{マルツ}
\label{\detokenize{begginers/buy_parts:id16}}
大手だけどここで買ったことがないのであまり分からず。
法人/官公庁向けの販売もしているのでサイト構成はちょっと敷居が高い感じ。

\href{http://www.marutsu.co.jp/pc/static/large\_order/led}{LEDの使い方}をはじめ、初心者\textasciitilde{}脱初心者向けの情報を提供していたりする。
回路を組んでいて迷ったら探してみよう。

ケース加工やプリント基板加工もしており、しっかりとしたものを作りたい場合はお世話になるかも?
大学生協との提携も盛んで、学科や研究室で電子回路を扱う時に関わることになるのかもしれない。


\subsection{スイッチサイエンス}
\label{\detokenize{begginers/buy_parts:id17}}
10000円以上で送料無料。海外向け製品など秋月で扱ってない商品もあるようだ。

電子工作やIoTの\href{https://connpass.com/search/?q=\%E3\%82\%B9\%E3\%82\%A4\%E3\%83\%83\%E3\%83\%81\%E3\%82\%B5\%E3\%82\%A4\%E3\%82\%A8\%E3\%83\%B3\%E3\%82\%B9}{イベント}を運営していたり、ブログに解説記事を載せたりと活動は活発。


\subsection{オリエンタルモータ}
\label{\detokenize{begginers/buy_parts:id18}}
モータ専門の企業。日周・緯度変のモータとモータドライバは代々ここで買っている。

買い替える場合は型番を見て同じものを買えばいいだろう。
ドライバはかなり高額だが、部室に予備があるしそもそも既製品なのであんまり壊れない。


\subsection{maxon}
\label{\detokenize{begginers/buy_parts:maxon}}
同じくモータ製造大手。データシートが詳細で、モータの勉強ができる。
\href{http://academy.maxonjapan.co.jp/}{マクソンアカデミー}という解説記事群もある。


\subsection{ミスミ}
\label{\detokenize{begginers/buy_parts:id19}}
金属系の部品なら買えないものはない、神のような存在。
しかも送料無料(ネジ一本でも)。ただし法人格のアカウントがないと買えない。

日電で本格的に機械部品を扱うことは稀なので、無理に使うことはないかもしれない。


\chapter{マイコンをはじめよう}
\label{\detokenize{begginers/microcontroller::doc}}\label{\detokenize{begginers/microcontroller:id1}}\begin{itemize}
\item {} 
書いた人: Kenichi Ito(nichiden\_27)

\item {} 
更新日時: 2017/03/15

\item {} 
実行に必要な知識・技能: 特になし

\item {} 
難易度: 2/少しやれば可能

\item {} 
情報の必須度: 2/知ってると楽

\end{itemize}


\section{概要}
\label{\detokenize{begginers/microcontroller:id2}}
マイコンとは、小型のコンピュータシステムのことです。
和製英語なので注意。''microcomputer''だとパソコンも含んでしまうので、''microcontroller''と呼べば間違いはないかと。

最近では\sphinxcode{Arduino}や\sphinxcode{mbed}に代表される手軽なマイコンボードが増え、かなりの用途に対応できます。これらについても簡単に解説します。


\section{マイコン比較}
\label{\detokenize{begginers/microcontroller:id3}}
いろんな会社がいろんなシリーズを出している。
よく見るのだとPIC/AVR/H8/ARMなど。
\begin{itemize}
\item {} 
PIC
\begin{itemize}
\item {} 
Microchip Technology Inc.が展開

\item {} 
日本で人気があり、情報も充実している

\item {} 
その昔アセンブラの開発環境のみ無料だった時代があり、先人たちが苦労していた

\item {} 
今ではC原語で書ける\href{http://www.microchip.com/ja/mplab/mplab-x-ide}{MPLAB
X}というIDE(統合開発環境)が無償配布

\item {} 
\href{http://akizukidenshi.com/catalog/c/cpicr/}{秋月電子で山ほど売っている}ので入手性はおそらく日本一

\item {} 
ライタ(書込み機)は\href{http://akizukidenshi.com/catalog/g/gM-03608/}{PICkit3}や\href{http://akizukidenshi.com/catalog/g/gK-02018}{AKI-PIC}など

\end{itemize}

\item {} 
AVR
\begin{itemize}
\item {} 
Atmel Corporationのマイコン
\begin{itemize}
\item {} 
だったが、2016年にMicrochipに買収された

\end{itemize}

\item {} 
Arduinoで゙使われている

\item {} 
主にTinyシリーズ(下位)とMegaシリーズ(上位)に分かれる

\item {} 
\href{http://www.atmel.com/ja/jp/microsite/atmel-studio/default.aspx}{Atmel
Studio}というIDEを無償配布している

\item {} 
ライタはAVRISP mkIIなど(秋月のサイトから消えてる...)
\begin{itemize}
\item {} 
自作もできるらしい

\end{itemize}

\end{itemize}

\item {} 
H8
\begin{itemize}
\item {} 
日立製作所\(\rightarrow\)Renesas Electronics

\item {} 
よく知らないけど高性能らしい

\end{itemize}

\item {} 
ARM
\begin{itemize}
\item {} 
ARM Holdingsによるマイコン

\item {} 
消費電力が少なくスマートフォンでの採用が多い

\item {} 
mbedにも使われている

\end{itemize}

\end{itemize}

プラネ用途であればPICかAVRで十分であろう。

以前は''C言語を使うならAVR''ということで、23-25の代でAVRが多数使われた。
しかしPICもC言語で開発できるようになり、27ではPICを使用していた。
今では、どちらを採用しても支障はないだろう。


\section{マイコンボード比較}
\label{\detokenize{begginers/microcontroller:id4}}
マイコンの多くは、ICチップと見た目が似ている。
ピンに自力で配線をつながなければプログラムを書き込むことすらできない。
これでは、初心者に優しくないのはもちろん、経験のある開発者にとっても手間が多くなってしまう。

最近人気となっているArduinoやmbedは、マイコンを載せた基板に電源や通信用のコネクタをあらかじめ実装しており、思い通りの機能を手軽に試すことが可能だ。
両者は厳密には言語や開発環境などを含めたシステム全体を指すため、マイコンそのものとは違う。
ただ、本記事では簡単のため\sphinxstylestrong{「マイコンボード」} と呼ぶことにする。

なお、Raspberry PiやIntel
Edisonなども見た目が似ているが、これらはOSを動作させることが可能で、よりコンピュータに近い使い方ができる。
本記事ではマイコンとは区別し、詳しくは取り扱わない。


\subsection{Arduino}
\label{\detokenize{begginers/microcontroller:arduino}}
AVRマイコンを使ったマイコンボード。
イタリア発祥のため読み方に悩むが「あるでぃーの」みたいな感じらしい。

世界中で普及しており、日本においても解説記事、ブログ共にたいへん充実している。
シールドと呼ばれる拡張基板が充実しており、通信やインタフェースなどの機能を追加できる。

2015〜2016年にかけて運営会社が内部分裂を起こしていた経緯があり、公式サイトも\href{http://www.arduino.cc}{arduino.cc}と\href{http://www.arduino.org}{arduino.org}の二種類存在する。
混乱は製品ラインナップやIDEにまで及び、微妙に違う二バージョンが混在するという面倒な事態になっていたが、現在は和解、統合している。

公式サイトもどちらを使っても問題ないはず。筆者はarduino.ccしか見たことがないが不便を感じたことはない。


\subsubsection{購入}
\label{\detokenize{begginers/microcontroller:id5}}
\href{http://akizukidenshi.com/catalog/c/carduino1/}{秋月電子}や\href{http://www.sengoku.co.jp/mod/sgk\_cart/search.php?cid=4186}{千石電商}、\href{http://www.marutsu.co.jp/GoodsListNavi.jsp?narrow1Cond=Arduino}{マルツ}といった有名な電子部品屋にはだいたい売っている。
ネットのみだが\href{https://www.switch-science.com/catalog/list/40/}{スイッチサイエンス}でも買えるようだ。

価格は3000〜5000円程度。
安くはないので、一台を様々な用途に使い回すことが多くなるだろう。

ただ、Arduinoの設計は公開されていて、誰でも自前で作って販売することが可能だ。
従って本家との互換機が多数売られており、中には価格面で本家を大幅に下回るものも存在する。

例えば、国内で買うと3000円弱かかるArduino
Nanoの互換機が、中国サイトなどで300円ちょっとで入手できてしまう(送料はかかる)。
信頼性が要求される場合や、初めてArduinoを使うときは避けるべきだが、沢山のArduinoを必要とする場面などでは検討してはいかがだろうか(クレカ情報を守るためpaypal推奨)。

安い互換機は、USBシリアル変換チップに\sphinxcode{CH340G}という中国製品を使っていることが多々ある。
最近のWindowsなら刺せば認識するようだが、Macで初めて使う際はドライバを入れねばならない。\href{http://www.wch.cn/download/CH341SER\_MAC\_ZIP.html}{江苏沁恒股份有限公司のページ}から落としてきてインストールしよう。


\subsubsection{開発環境}
\label{\detokenize{begginers/microcontroller:id6}}
開発にはArduino
IDEをPCにダウンロードする必要がある。2017年現在のバージョンは1.8系で、arduino.cc/arduino.orgのどちらでも同じものが入手できる。このIDEでスケッチと呼ばれるプログラムの作成からビルド、ボードへの書き込みまでを行う。

...はずだったのだが、2016年夏に\href{https://create.arduino.cc/}{Arduino
Create}がリリースされ、mbedのようにブラウザからオンライン開発環境(\sphinxcode{Arduino Web Editor})を使えるようになった。
まだ普及している印象はないが、コミュニティ機能などが充実しているようだ。
使いこなせれば強い味方になるかもしれない。
\begin{figure}[htbp]
\centering
\capstart

\noindent\sphinxincludegraphics{{arduino-web-editor}.png}
\caption{Arduino Web Editorの画面}\label{\detokenize{begginers/microcontroller:id12}}\end{figure}

Arduino IDEの操作手順についてはWeb上に解説が数多くあるので述べない。


\subsubsection{言語}
\label{\detokenize{begginers/microcontroller:id7}}
Arduinoは、ソフトウェアを専門としない層でも気軽に始められるようにとのコンセプトを持つ。
そのためか言語も独自のArduino言語を使用する。

C/C++風なので、経験者なら特に勉強しなくとも違和感なく書けるだろう。
それでいてArduinoで使う頻度の高い機能にはアクセスしやすくなっているので、とにかく初心者に優しい。

\href{https://www.arduino.cc/en/Reference/}{本家のリファレンス}をはじめ資料も充実しており、ググれば大抵の問題は解決できるはずだ。
C++なので自分でクラスを作るのも自由。


\subsection{mbed}
\label{\detokenize{begginers/microcontroller:mbed}}
ARM社とNXP社が提供するマイコンボード。
公式推奨の読み方は「\sphinxstylestrong{エンベッド}」。
ブラウザで\href{https://developer.mbed.org/}{developer.mbed.org}にある開発環境を使うというのが最大の特徴。

自分のマシンにいちいち開発環境を入れるよりも、通信環境さえあればどこからでも使えた方が良いという発想である。
アカウントを共有すればチーム開発ができてしまうなど便利さがある一方、ネット接続前提というのが足かせになってしまうこともある(最近になりオフライン開発が容易になった、後述)。

日本国内にはコアなファンが結構おり、\href{https://mbed.doorkeeper.jp/}{mbed祭り}というユーザイベントが度々開催されるなど盛り上がっている。developer.mbed.org自体がユーザコミュニティ機能を備えており、開発と情報収集・発信が連続しているというのが強みだろう。


\subsubsection{購入}
\label{\detokenize{begginers/microcontroller:id8}}
秋月電子やスイッチサイエンスなどで扱っている。

mbedの中で一番有名なのは\sphinxcode{LPC1768}だ。
コンパクトで高性能だが、価格は6千〜7千円と安くはない。
低電圧版の\sphinxcode{LPC11U24}でも5千円ほどはする。

そのためホイホイと買えなかったmbedだが、\sphinxstylestrong{mbed-enabled}
プラットフォームの登場により状況は変わった。
ハードウェアの設計がオープンソースとなったことで、mbedの開発環境で使用できるボードが数多く生まれたのだ。
その全容は公式の\href{https://developer.mbed.org/platforms/}{platforms}で確認できる。

なかでも、秋月電子などで容易に購入できるものにSTmicroの''\sphinxcode{Nucleo Board}``がある。
搭載するマイコンの種類やフラッシュメモリの容量によって数十種が存在し、そのうち20種弱は\href{http://akizukidenshi.com/catalog/c/cstm32/}{秋月電子}や\href{https://www.switch-science.com/catalog/list/615/}{スイッチサイエンス}などから入手可能だ。
さらに、大部分が1500〜1900円程度と、本家mbedに比べて安価に購入できる。

\sphinxcode{Nucleo Board}にはArduino
UNOとピン配置の互換性があるため、Arduinoのシールドを流用できる場合もある。Arduinoに慣れている人にも触りやすいボードかもしれない。

また、変わったケースとして\href{http://akizukidenshi.com/catalog/g/gI-06071/}{LPC1114FN28}というのもある。
これは、見た目は28ピンのマイコンだが、mbed対応だ。
USBでPCと繋いで他のmbedと同じ感覚で扱えるボードもあり、一個400円(110円の時代もあったらしい...)のマイコンを載せ替えれば使い回せる。
流石にボード型のものと比べて性能に制限はあるが、予算を抑えたい場合や多数のmbedを揃える場合に選択肢になりうる。


\subsubsection{開発環境}
\label{\detokenize{begginers/microcontroller:id9}}
さきに述べた通り、mbedの開発環境はオンラインに存在する。
mbedを買ってアカウントを作成すれば早速使えるようになり、どこからでも保存したコードを閲覧できる。
開発環境自体も自動ヘルプ機能やライブラリのリファレンスを備えており、コードを書いていて特段不自由は感じない。

ビルドが成功すると拡張子\sphinxcode{.bin}のファイルがダウンロードされる。
これをフラッシュメモリとして認識されるmbedのルートディレクトリに配置するだけで書き込み完了だ。
リセットボタンを押せば書き込んだプログラムが動作する。

どうしても、オフラインでコンパイルをしたい場合がある。
従来は、オンラインIDEの機能でプロジェクトを書き出した上で、自前で構築したARM向けの開発環境でビルドしていた。

2016年8月、\sphinxcode{mbed OS 5}がリリースされる。
これは、それまでのいわゆるmbedである\sphinxcode{mbed 2.0}と、IoT向けのOSである\sphinxcode{mbed OS 3}を統合した新たなmbedのソフトウェア基盤だ。
これに伴い、コマンドラインの開発環境\sphinxcode{mbed CLI}が使用可能になった。

\sphinxcode{mbed CLI}は、\sphinxcode{mbed 2.0}のコードをインポートしてビルドすることもできる。
本家ツールだけあってmbedとの親和性や機能性は優れているようなので、オフライン環境が欲しくなった際は使ってみてはいかがだろうか。
詳細は、\href{https://developer.mbed.org/users/MACRUM/notebook/mbed-offline-development/}{mbed
オフラインの開発環境}を確認されたい。


\subsubsection{言語}
\label{\detokenize{begginers/microcontroller:id10}}
C++をベースとしている。
C++を書き慣れている開発者は違和感なく扱える一方、プログラム自体初心者だと意味を理解するのにしばらくかかるかもしれない。

Arduinoより後発のため、\sphinxcode{=}などの演算子をクラスごとにオーバーロードするなど直感的に書くための工夫が進んでいる。
また、オンラインIDE自体にコミュニティ機能・コードの公開機能があり、他ユーザが公開している既存資源を簡単に自分のプロジェクトに取り込める。
mbedのシステムをフル活用すれば、かなり快適に開発を進められそうだ。


\section{結局何を選べばいいのか}
\label{\detokenize{begginers/microcontroller:id11}}
ここまで長々と書いてきたが、一体どのマイコン(ボード)を買いに行けばいいのだろう。

Arduinoやmbedといったマイコンボードの使い勝手は年々進化し続けており、従来のマイコンからは考えられない開発スピードを実現できる。
学生団体レベルの製作物ならば、無理に素のマイコンを使おうとせず、マイコンボードを採用して構わないだろう。

Arduinoとmbedには、双方に様々種類がある。
習得もそれほど大変でないので、それぞれの特徴を知った上で目的に合わせて選ぶのが良いだろう。
特に出力ピン数は、ボードを選ぶ際足りているかよくよく確認すべきである。

高性能のコアが全く必要ない用途や、電流サージの危険があり高価なボードを故障の危険に晒したくない場面では、PICやAVRといったマイコンの技術が生きてくる。
ひとたび動かし方を習得すれば、安くて小回りのきくマイコンは強い味方になってくれることだろう。

そうしたマイコンが実際に使われている機材の修理や、ソフトウェア改修を任されることもある。
幸いにも書き込み機や予備のマイコンがあらかじめ用意されているなら、PICやAVRの開発環境は出費なしで揃えられる。
先達の残したコードを解読していけば、あなたのマイコンの知識も深まるかもしれない。



\renewcommand{\indexname}{索引}
\printindex
\end{document}