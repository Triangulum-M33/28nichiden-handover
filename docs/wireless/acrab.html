

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="ROBOTS" content="NOINDEX,NOFOLLOW,NOARCHIVE">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>無線制御(Acrab) &mdash; Nichiden 0.1 ドキュメント</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="索引"
              href="../genindex.html"/>
        <link rel="search" title="検索" href="../search.html"/>
    <link rel="top" title="Nichiden 0.1 ドキュメント" href="../index.html"/>
        <link rel="next" title="またたき回路" href="../twinkle.html"/>
        <link rel="prev" title="無線制御(PISCIUM)" href="piscium.html"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> Nichiden
          

          
          </a>

          
            
            
              <div class="version">
                0.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <p class="caption"><span class="caption-text">目次:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../main.html">東京大学地文研究会天文部 日電引き継ぎ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../management.html">プロジェクト マネジメント</a></li>
<li class="toctree-l1"><a class="reference internal" href="../nissyu-idohen/kikou.html">日周緯度変(日周緯度変換機構)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../nissyu-idohen/saitama.html">日周緯度変(さいたま)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../nissyu-idohen/ikebukuro.html">日周緯度変(Ikebukuro)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../nissyu-idohen/pc-software.html">日周緯度変(外部制御アプリ)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../nissyu-idohen/pc-software-history.html">日周緯度変(外部制御アプリの歴史)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../nissyu-idohen/pc-software-code.html">日周緯度変(Ogoseの実装解説)</a></li>
<li class="toctree-l1"><a class="reference internal" href="wireless.html">無線制御</a></li>
<li class="toctree-l1"><a class="reference internal" href="piscium.html">無線制御(PISCIUM)</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">無線制御(Acrab)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#id1">概要</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id2">使い方</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id3">下準備</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id4">起動と接続</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id5">公演用画面</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#id6">プログラム</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id7">ファイル構成</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id8">技術要素</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#htmlcss">HTMLとCSS</a></li>
<li class="toctree-l4"><a class="reference internal" href="#jquery">jQuery</a></li>
<li class="toctree-l4"><a class="reference internal" href="#json">JSON</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#acrab-conf-json">acrab_conf.json</a></li>
<li class="toctree-l3"><a class="reference internal" href="#acrab-main-js">acrab_main.js</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id9">読み込み時の処理</a></li>
<li class="toctree-l4"><a class="reference internal" href="#getrequest-address-data">getRequest(address, data)</a></li>
<li class="toctree-l4"><a class="reference internal" href="#checkstatus-stat">checkStatus(stat)</a></li>
<li class="toctree-l4"><a class="reference internal" href="#pinsettingsend">pinSettingSend()</a></li>
<li class="toctree-l4"><a class="reference internal" href="#button">buttonオブジェクト</a></li>
<li class="toctree-l4"><a class="reference internal" href="#each-slice-obj-n">each_slice(obj, n)</a></li>
<li class="toctree-l4"><a class="reference internal" href="#sleep-ms-t">sleep_ms(T)</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#acrab-scenario-js">acrab-scenario.js</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#id10">今後の展望</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id11">既知の問題</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../twinkle.html">またたき回路</a></li>
<li class="toctree-l1"><a class="reference internal" href="../haisen.html">配線</a></li>
<li class="toctree-l1"><a class="reference internal" href="../haisen-kagoshii.html">配線(かごしい内)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bihin.html">備品管理</a></li>
<li class="toctree-l1"><a class="reference internal" href="../syutou.html">主投影機との連携</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hojotou.html">補助投影機との連携</a></li>
<li class="toctree-l1"><a class="reference internal" href="../begginers/buy_parts.html">部品の買い方</a></li>
<li class="toctree-l1"><a class="reference internal" href="../begginers/microcontroller.html">マイコンをはじめよう</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Nichiden</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Nichiden</a> &raquo;</li>
        
      <li>無線制御(Acrab)</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/wireless/acrab.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="acrab">
<h1>無線制御(Acrab)<a class="headerlink" href="#acrab" title="このヘッドラインへのパーマリンク">¶</a></h1>
<ul class="simple">
<li>書いた人: Kenichi Ito(nichiden_27)</li>
<li>更新日時: 2017/04/13</li>
<li>実行に必要な知識・技能: Web制作、JavaScript</li>
<li>タスクの重さ: 3/数週間</li>
<li>タスクの必須度: 4/毎年やるべき</li>
</ul>
<div class="section" id="id1">
<h2>概要<a class="headerlink" href="#id1" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p><code class="docutils literal"><span class="pre">Acrab</span></code>は、27代で開発した投影機無線操作用Webアプリケーションです。
最新のブラウザ(Chrome推奨)があれば、どんな環境でも使うことができます。</p>
<p>名称は、ブラウザで星座絵などを操れることからApplication for
Constellation Remote controlling Assistance on
Browserの頭文字をとりました。 さそり座β星の固有名でもあります。</p>
</div>
<div class="section" id="id2">
<h2>使い方<a class="headerlink" href="#id2" title="このヘッドラインへのパーマリンク">¶</a></h2>
<div class="section" id="id3">
<h3>下準備<a class="headerlink" href="#id3" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>まず、<a class="reference external" href="https://github.com/macv35/nichiden27/tree/master/ACRAB">Acrabの各種ファイル</a>を同じフォルダに配置する。
ファイルの読み込みにAjaxを使っているので、index.htmlをそのまま開いただけ(<a class="reference external" href="file:///">file:///</a>)では機能が使えない。
回避方法は「Ajax
ローカル」などとググれば複数出てくるが、ローカルにWebサーバを立てる方法を解説する。</p>
<p>Windowsでローカルホストを立てるには、<a class="reference external" href="https://www.apachefriends.org/jp/index.html">XAMPP</a>を使うのが簡単だ。
GUIなので、操作も分かりやすいだろう。
MacならApacheが標準で入っているはずなので、<code class="docutils literal"><span class="pre">sudo</span> <span class="pre">apachectl</span> <span class="pre">start</span></code>を打てば<code class="docutils literal"><span class="pre">httpd</span></code>が動き出す。
設定については、ググれば役に立つ情報が得られる。</p>
</div>
<div class="section" id="id4">
<h3>起動と接続<a class="headerlink" href="#id4" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>localhostにアクセスすれば以下のような画面が表示されるはずだ。
もしボタンに日本語が表示されない場合、設定ファイルの読み込みに失敗しているので再読み込みすること。</p>
<div class="figure" id="id12">
<img alt="Acrabのメイン画面" src="../_images/acrab-main.png" />
<p class="caption"><span class="caption-text">Acrabのメイン画面</span></p>
</div>
<p>次に、<code class="docutils literal"><span class="pre">Piscium</span></code>との接続を確認する。
<code class="docutils literal"><span class="pre">Piscium</span></code>の電源が入っていて、Wi-Fiネットワークに接続していれば、画面上の「受信状況」が緑色に変わるはずだ。</p>
<p>もし「接続なし」のままなら、PCと<code class="docutils literal"><span class="pre">Piscium</span></code>が同じLANに接続しているか(PCが別のルーターに接続してしまうミスは結構ある)、受信モジュールのIPアドレスが正しいかなどを確認しよう。
「受信状況」欄右の更新ボタンを押すと、<code class="docutils literal"><span class="pre">Piscium</span></code>へのリクエストが再送される。</p>
<p>無事接続できたら下に並ぶボタンを押して投影機をオンオフさせてみよう。
投影機を繋いでいなくても、コマンド自体は送ることができる。
<code class="docutils literal"><span class="pre">Piscium</span></code>から応答が来なかった場合はボタンの色が変わらないので、不具合に気づける。</p>
</div>
<div class="section" id="id5">
<h3>公演用画面<a class="headerlink" href="#id5" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>ソフトの指示を次へ・前へのボタンで実行できるモード。
画面上に「公演用」ボタンがあり、押すと画面が切り替わる。</p>
<div class="figure" id="id13">
<img alt="Acrabの公演用画面" src="../_images/acrab-scenario.png" />
<p class="caption"><span class="caption-text">Acrabの公演用画面</span></p>
</div>
<p>左上のメニューから番組名を選べるので、選んでから「開始」ボタンを押すと一番初めのコマンドが送信される。
下にタイミングが表示されるので、緑色の次へボタンを押して番組を進行する。
前へボタンでは、直前と逆の指示を送信できる。</p>
<p>「開始」した後は左のボタンが「停止」「再開」に変化するが、これは右上のタイマーが止まるだけで深い意味はない。
「リセット」ボタンを押すと、タイマーと番組の進行状況が最初に戻る。</p>
<p>誤操作防止のため、「リセット」は「停止」状態でないとできない。
また、番組選択メニューは「リセット」しなければ操作できない。</p>
</div>
</div>
<div class="section" id="id6">
<h2>プログラム<a class="headerlink" href="#id6" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p><code class="docutils literal"><span class="pre">Acrab</span></code>はWebの技術を使って通信や画面表示を行っている。
画面の情報はHTML、デザインはCSS、内部処理や画面の書き換えはJavaScript(以下JS)という構成だ。</p>
<div class="section" id="id7">
<h3>ファイル構成<a class="headerlink" href="#id7" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>以下のようなディレクトリ構成になっている。
ファイルを動かす際はリンク切れに注意すること。</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>ACRAB
├── acrab_conf.json
├── img
│   ├── acrab-banner.svg
│   ├── main_01.png
│   ├── main_02.png
│   └── (省略)
├── index.html
├── js
│   ├── acrab_main.js
│   ├── acrab_scenario.js
│   └── jquery-3.1.0.js
├── scenario
│   ├── 0.json
│   ├── 1.json
│   ├── (省略)
│   └── csv
│       └── (省略)
├── style.css
└── testscript.json
</pre></div>
</div>
<p><code class="docutils literal"><span class="pre">index.html</span></code>がAcrabのメインページである。
デザイン関連の記述は<code class="docutils literal"><span class="pre">style.css</span></code>に分離した。
<code class="docutils literal"><span class="pre">acrab_conf.json</span></code>には、各種設定が格納されている。</p>
<p><code class="docutils literal"><span class="pre">img/</span></code>以下にはページで使用した画像、<code class="docutils literal"><span class="pre">js/</span></code>以下にはJavaScriptのコードが入っている。
<code class="docutils literal"><span class="pre">scenario/</span></code>内は、番組の指示書を指定形式で入力したデータ。</p>
</div>
<div class="section" id="id8">
<h3>技術要素<a class="headerlink" href="#id8" title="このヘッドラインへのパーマリンク">¶</a></h3>
<div class="section" id="htmlcss">
<h4>HTMLとCSS<a class="headerlink" href="#htmlcss" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p>最近のWebアプリは、サーバ側でHTMLファイルを動的に生成して送ってくることが多い。
しかし、<code class="docutils literal"><span class="pre">Acrab</span></code>は<strong>静的なHTMLファイルを準備し、クライアント(ブラウザ)側で書き換える</strong>
方式を採っている。
単に開発が楽であること、サーバ側で作業する必要がないこと、多数のユーザに後悔するような規模でないことがその理由である。</p>
<p><code class="docutils literal"><span class="pre">Acrab</span></code>の<strong>ページ構成</strong>
を変えたければ<code class="docutils literal"><span class="pre">index.html</span></code>を、<strong>色やサイズ</strong>
なら<code class="docutils literal"><span class="pre">style.css</span></code>を編集すれば良い。
どちらもググれば分かる程度の機能しか使っていないつもりなので、Webの経験がなくても対応できるだろう。
それぞれの内容についてはここでは触れないが、JS部分と連動する箇所は都度解説する。</p>
</div>
<div class="section" id="jquery">
<h4>jQuery<a class="headerlink" href="#jquery" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p>プログラムにはJSを用いていると書いたが、素のJSだけで書くと記述が長くなってしまう。
そこで、jQueryというライブラリを採用している。
動的なページの書き換えやAjaxによるファイル取得などを簡単に書けるようになり、コードを読みやすくできる。</p>
<p>近頃のWebアプリはサーバ側が急速に発展し、jQueryは不要な存在となりつつあるが、<code class="docutils literal"><span class="pre">Acrab</span></code>はクライアントサイドだけで動作する仕様のためあえて採用した。
数年前の流行りとはいえネット上に解説記事が充実しており、学習が容易であることも採用の理由だ。</p>
<p>jQueryは単一のjsファイルにまとめて配布されるので、最新版をダウンロードして<code class="docutils literal"><span class="pre">js/</span></code>内に入れておけば使えるようになる。
わざわざダウンロードしておくのは、ネットに接続できない本番ドーム内などでもjQueryを取得できるようにするため。</p>
<p>jQueryの機能は解説しないのでググって補完されたい。
<code class="docutils literal"><span class="pre">acrab_main.js</span></code>や<code class="docutils literal"><span class="pre">acrab_scenario.js</span></code>内に頻繁に登場する<code class="docutils literal"><span class="pre">$</span></code>という文字は、jQueryを呼び出すためのものである。
<code class="docutils literal"><span class="pre">$.(メソッド名)</span></code>といった形式で各種メソッドを使用できる。</p>
</div>
<div class="section" id="json">
<h4>JSON<a class="headerlink" href="#json" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p><code class="docutils literal"><span class="pre">Acrab</span></code>では、各種設定を個別ファイルに分離している。
投影する星座の名称を変えたい、指示書を編集したいと言った要求はいつ来てもおかしくない。
こうした変更に迅速に対応できるよう<strong>JSON</strong>形式の設定ファイルを読み込む方式とした。</p>
<p>JSON(JavaScript Object
Notation)は、JavaScriptのオブジェクトの形式でデータを記述するものである。
「JavaScriptのオブジェクト」というのは配列や連想配列を入れ子にした構造を指す。</p>
<div class="highlight-js"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="s2">&quot;hoge&quot;</span><span class="o">:</span> <span class="p">[</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">null</span> <span class="p">],</span>
  <span class="s2">&quot;fuga&quot;</span><span class="o">:</span> <span class="p">{</span>
    <span class="s2">&quot;one&quot;</span><span class="o">:</span> <span class="p">[</span> <span class="kc">true</span><span class="p">,</span> <span class="s2">&quot;tenmon&quot;</span> <span class="p">],</span>
    <span class="s2">&quot;two&quot;</span><span class="o">:</span> <span class="s2">&quot;nichiden&quot;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>上の例のように、項目にラベルを付ける、入れ子にするといったことが比較的シンプルな記述で可能になる。
また、オブジェクトなので<code class="docutils literal"><span class="pre">.</span></code>でラベル名を繋ぐだけでデータを取り出せる(例:
<code class="docutils literal"><span class="pre">fuga.one[1]</span></code>は<code class="docutils literal"><span class="pre">&quot;tenmon&quot;</span></code>)。
文法がJavaScriptからの流用なので親和性がよく、読み込みが簡単なのも嬉しい。</p>
<p>ただ、文法がたいへん厳しくかつ目で眺めてもミスに気づきにくいので、パースエラーが出ないことを確かめてから使うよう心がけたい。
<a class="reference external" href="http://jsonlint.com/">JSONLint</a>など、JSONの文法ミスを検出してくれるサービスが存在する。</p>
</div>
</div>
<div class="section" id="acrab-conf-json">
<h3>acrab_conf.json<a class="headerlink" href="#acrab-conf-json" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p><code class="docutils literal"><span class="pre">Acrab</span></code>の設定ファイルである。 JSONファイルのため構造の概略のみ示す。</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>├── &quot;ip&quot; [Pisciumとの通信用]
│   ├── &quot;N&quot; [北天受信機のIPアドレス]
│   └── &quot;S&quot; [南天受信機のIPアドレス]
├── &quot;port&quot; [出力ポート用]
│   ├── &quot;And&quot; [星座or投影機名の三文字コード]
│   │   ├── &quot;name&quot; [ボタンに表示する名前]
│   │   ├── &quot;box&quot; [北天なら&quot;N&quot;/南天なら&quot;N&quot;/両方なら&quot;NS&quot;]
│   │   └── &quot;pin&quot; [投影機とピン番号の対応]
│   └── (以下同様)
└── &quot;group&quot; [星座や投影機のグループを定義]
    ├── &quot;Set&quot; [全点灯の三文字コード]
    │   └── &quot;name&quot; [ボタンに表示する名前]
    ├── &quot;Cle&quot; [全消灯の三文字コード]
    │   └── &quot;name&quot; [ボタンに表示する名前]
    ├── &quot;Spc&quot; [グループ名の三文字コード]
    │   ├── &quot;name&quot; [ボタンに表示する名前]
    │   └── &quot;value&quot; [配列: グループに属する星座or投影機を列挙]
    └── (以下同様)
</pre></div>
</div>
<p>三文字コードというのは、プログラム中で<strong>星座・投影機・そのグループ</strong>を区別するため一意に割り振った三文字を指す。
星座にはもともと<a class="reference external" href="http://www.nao.ac.jp/new-info/constellation2.html">この形式の略符が用意されている</a>こともあり、文字数を統一して可読性を高めることを目指した。</p>
<p>例えば星座絵のピン番号を入れ替える際には、<code class="docutils literal"><span class="pre">port.(星座名).pin</span></code>を書き換えれば良い。
<code class="docutils literal"><span class="pre">Piscium</span></code>側に設定を反映させるためページをリロードすること。</p>
</div>
<div class="section" id="acrab-main-js">
<h3>acrab_main.js<a class="headerlink" href="#acrab-main-js" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p><code class="docutils literal"><span class="pre">Acrab</span></code>全体に関わるコードや、「メイン」画面で使用するコードを記述した。</p>
<div class="section" id="id9">
<h4>読み込み時の処理<a class="headerlink" href="#id9" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p>ページを読み込んだ後に一度だけ実行したい処理がある。
JSはスクリプト言語なので、main関数のようなものはなくコードの頭から順に読み込まれる。</p>
<p>通常は関数を定義しても呼び出されるまで何も起こらないが、<code class="docutils literal"><span class="pre">(function(){})()</span></code>の形式のものは読み込んだ時点で実行される。
これを<strong>即時関数</strong>といい、初期設定の適用などに使える。</p>
<p>また、コード中に<code class="docutils literal"><span class="pre">$(function(){})</span></code>もあるが、これは即時関数ではない。
$がついたものはjQueryの<strong>readyイベント</strong>といい、<strong>HTMLが全てロードされた時点で実行される</strong>。
ページを書き換えるような処理の場合ページが読み込まれていないと意味がないので、こちらを使うようにしよう。</p>
<p>即時関数・readyイベントで行っている処理は以下の通り。</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">acrab_conf.json</span></code>の取得とパース<ul>
<li><code class="docutils literal"><span class="pre">$.getJSON()</span></code>を使うだけ</li>
</ul>
</li>
<li><code class="docutils literal"><span class="pre">port</span></code>と<code class="docutils literal"><span class="pre">group</span></code>の<code class="docutils literal"><span class="pre">name</span></code>をボタンに表示<ul>
<li><code class="docutils literal"><span class="pre">$.each()</span></code>で配列の全要素にループ処理できる</li>
</ul>
</li>
<li>ピン番号の設定を<code class="docutils literal"><span class="pre">Piscium</span></code>に送信(<code class="docutils literal"><span class="pre">pinSettingSend()</span></code>)</li>
<li>各ボタンにclickイベントを追加<ul>
<li><code class="docutils literal"><span class="pre">.main_button</span></code>というクラスの要素を取得して<code class="docutils literal"><span class="pre">$.each()</span></code></li>
<li>HTMLに手作業で書くのが面倒なので、クラスからボタンの種類を判定して最適な関数を実行する仕組み</li>
</ul>
</li>
<li>更新ボタン、明るさスライダーの処理を追加</li>
<li>タブの切り替え<ul>
<li>各タブの画面はそれぞれ<code class="docutils literal"><span class="pre">.content</span></code>クラスに入っている</li>
<li>一度全てを非表示にした後、押したタブの順番と同じ順番の画面のみ表示する</li>
</ul>
</li>
</ul>
<p>開発の途中に順次追加したのでかなりグチャグチャになっている。
自由に読みやすく変更して構わない。</p>
<p>本番まで気づかなかったため未修正だが、実は<strong>コード先頭の即時関数もreadyイベントにすべき</strong>である。
「<code class="docutils literal"><span class="pre">port</span></code>と<code class="docutils literal"><span class="pre">group</span></code>の<code class="docutils literal"><span class="pre">name</span></code>をボタンに表示」する処理がHTML読み込み後でないとできないからだ。
稀にだが<code class="docutils literal"><span class="pre">acrab_conf.json</span></code>が読み込まれない不具合はこれが原因と思われる。</p>
</div>
<div class="section" id="getrequest-address-data">
<h4>getRequest(address, data)<a class="headerlink" href="#getrequest-address-data" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p><code class="docutils literal"><span class="pre">address</span></code>にURLパラメータとして<code class="docutils literal"><span class="pre">data</span></code>を付けて送信する関数。
jQueryの<code class="docutils literal"><span class="pre">get()</span></code>や<code class="docutils literal"><span class="pre">Deferred</span></code>を使用している。</p>
<div class="highlight-js"><div class="highlight"><pre><span></span><span class="nx">data</span> <span class="o">=</span> <span class="nx">data</span> <span class="o">||</span> <span class="p">{}</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="nx">address</span> <span class="o">+</span> <span class="s1">&#39;: &#39;</span> <span class="o">+</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">data</span><span class="p">));</span>
<span class="kd">var</span> <span class="nx">deferred</span> <span class="o">=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">Deferred</span><span class="p">();</span> <span class="c1">// 非同期通信なので完了時にデータを渡す処理</span>
<span class="nx">$</span><span class="p">.</span><span class="nx">get</span><span class="p">({</span>
  <span class="nx">url</span><span class="o">:</span> <span class="nx">address</span><span class="p">,</span> <span class="nx">dataType</span><span class="o">:</span> <span class="s1">&#39;json&#39;</span><span class="p">,</span> <span class="nx">timeout</span><span class="o">:</span> <span class="mi">1000</span><span class="p">,</span> <span class="nx">data</span><span class="o">:</span> <span class="nx">data</span>
<span class="p">}).</span><span class="nx">done</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="nx">res</span><span class="p">);</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">address</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="nx">ip</span><span class="p">.</span><span class="nx">N</span><span class="p">))</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#wifi-icons #north&#39;</span><span class="p">).</span><span class="nx">text</span><span class="p">(</span><span class="s1">&#39;正常受信中&#39;</span><span class="p">).</span><span class="nx">removeClass</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">);</span>
  <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">address</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="nx">ip</span><span class="p">.</span><span class="nx">S</span><span class="p">))</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#wifi-icons #south&#39;</span><span class="p">).</span><span class="nx">text</span><span class="p">(</span><span class="s1">&#39;正常受信中&#39;</span><span class="p">).</span><span class="nx">removeClass</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">);</span>
  <span class="nx">deferred</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">res</span><span class="p">);</span>
<span class="p">}).</span><span class="nx">fail</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">xhr</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">status</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">statusText</span><span class="p">);</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">address</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="nx">ip</span><span class="p">.</span><span class="nx">N</span><span class="p">))</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#wifi-icons #north&#39;</span><span class="p">).</span><span class="nx">text</span><span class="p">(</span><span class="s1">&#39;接続なし&#39;</span><span class="p">).</span><span class="nx">addClass</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">);</span>
  <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">address</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="nx">ip</span><span class="p">.</span><span class="nx">S</span><span class="p">))</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#wifi-icons #south&#39;</span><span class="p">).</span><span class="nx">text</span><span class="p">(</span><span class="s1">&#39;接続なし&#39;</span><span class="p">).</span><span class="nx">addClass</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">);</span>
  <span class="nx">deferred</span><span class="p">.</span><span class="nx">reject</span><span class="p">;</span>
<span class="p">});</span>
<span class="k">return</span> <span class="nx">deferred</span><span class="p">;</span>
</pre></div>
</div>
<p><code class="docutils literal"><span class="pre">$.get()</span></code>は、指定したURLにGETリクエストを送信する。
<code class="docutils literal"><span class="pre">data</span></code>に連想配列を指定するとURLパラメータに整形してくれる嬉しい機能付きだ。
また、通信が切れている時に固まらないよう、1000msのタイムアウトを設定している。</p>
<p>その後の<code class="docutils literal"><span class="pre">.done()</span></code>や<code class="docutils literal"><span class="pre">.fail()</span></code>にはそれぞれ通信成功時・失敗時の処理を書く。
ここでは通信するたびにブラウザコンソールに結果を出力し、受信状況の欄を更新するようになっている。</p>
<p>さて、<code class="docutils literal"><span class="pre">Piscium</span></code>にコマンドを送ると、<strong>各ポートの状態を0か1で表したjsonデータ</strong>
が返る。
<code class="docutils literal"><span class="pre">dataType:</span> <span class="pre">'json'</span></code>としておけばパースまでやってくれるようだ。
これを関数の戻り値としたいが、これには工夫が必要になる。</p>
<p><code class="docutils literal"><span class="pre">$.get()</span></code>のようなAjax通信は<strong>非同期処理</strong>を採用しており、リクエストを送った後応答を待たずに関数が終了してしまう。
そのため、送られてくるはずのデータを戻り値に入れることができない。</p>
<p>そこで、<code class="docutils literal"><span class="pre">$.Deferred</span></code>を利用する。
ググれば出てくるため詳細は省くが、Deferredオブジェクトを一旦返し<strong>通信が終了してからデータを格納する</strong>ことができる。
また、通信が失敗した場合<code class="docutils literal"><span class="pre">deferred.reject</span></code>すると以上終了させることもできる。</p>
</div>
<div class="section" id="checkstatus-stat">
<h4>checkStatus(stat)<a class="headerlink" href="#checkstatus-stat" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p><code class="docutils literal"><span class="pre">Piscium</span></code>から送られてくるjsonをパースしたオブジェクトから<strong>各星座絵・投影機のオンオフ状況を確認する</strong>。
基本的に<code class="docutils literal"><span class="pre">getRequest()</span></code>で通信した後はこれを呼ぶようにして、表示を常に最新に保つべきである。
<code class="docutils literal"><span class="pre">getRequest()</span></code>は非同期関数なので、以下のコード片のように<code class="docutils literal"><span class="pre">.done()</span></code>を使う。</p>
<div class="highlight-js"><div class="highlight"><pre><span></span><span class="nx">getRequest</span><span class="p">(</span><span class="nx">address</span><span class="p">,</span> <span class="nx">data</span><span class="p">).</span><span class="nx">done</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">res</span><span class="p">){</span><span class="nx">checkStatus</span><span class="p">(</span><span class="nx">res</span><span class="p">)});</span>
</pre></div>
</div>
<p>ボタンはHTML側で以下のように三文字コードのIDが振られている。</p>
<div class="highlight-html"><div class="highlight"><pre><span></span><span class="c">&lt;!-- index.html --&gt;</span>
<span class="p">&lt;</span><span class="nt">button</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;main_button constellation&quot;</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;And&quot;</span><span class="p">&gt;</span>And<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
</pre></div>
</div>
<p>三文字コードは<code class="docutils literal"><span class="pre">port</span></code>や<code class="docutils literal"><span class="pre">group</span></code>に入っているので、<code class="docutils literal"><span class="pre">$.each()</span></code>ループを回して巡回する。
各ボタンに<code class="docutils literal"><span class="pre">on</span></code>クラスを追加すると色などが変わる仕組みだ。</p>
<div class="highlight-js"><div class="highlight"><pre><span></span><span class="nx">$</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">port</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">key</span><span class="p">){</span> <span class="c1">// 星座|投影機ごと</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">stat</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">===</span> <span class="mi">1</span><span class="p">)</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;[id=&#39;</span><span class="o">+</span><span class="nx">key</span><span class="o">+</span><span class="s1">&#39;]&#39;</span><span class="p">).</span><span class="nx">addClass</span><span class="p">(</span><span class="s1">&#39;on&#39;</span><span class="p">);</span>
  <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">stat</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;[id=&#39;</span><span class="o">+</span><span class="nx">key</span><span class="o">+</span><span class="s1">&#39;]&#39;</span><span class="p">).</span><span class="nx">removeClass</span><span class="p">(</span><span class="s1">&#39;on&#39;</span><span class="p">);</span>
<span class="p">});</span>
</pre></div>
</div>
<p><code class="docutils literal"><span class="pre">group</span></code>に関しても基本は変わらないが、こちらは<strong>属している星座絵全てが点灯していなければオンにならない</strong>。
例えば、「夏の大三角」ボタンを押すと「こと/わし/はくちょう」が点灯するが、このうち一つでも消すと「夏の大三角」もオフの表示になる。</p>
<div class="highlight-js"><div class="highlight"><pre><span></span>  <span class="nx">$</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">group</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">key</span><span class="p">){</span> <span class="c1">// 星座グループごと</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">value</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">isOn</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="nx">$</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">value</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span><span class="nx">isOn</span> <span class="o">&amp;=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="o">+</span><span class="k">this</span><span class="p">).</span><span class="nx">hasClass</span><span class="p">(</span><span class="s1">&#39;on&#39;</span><span class="p">);});</span> <span class="c1">// 各星座がオンかどうかのANDをとる</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">isOn</span><span class="p">)</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;[id=&#39;</span><span class="o">+</span><span class="nx">key</span><span class="o">+</span><span class="s1">&#39;]&#39;</span><span class="p">).</span><span class="nx">addClass</span><span class="p">(</span><span class="s1">&#39;on&#39;</span><span class="p">);</span>
    <span class="k">else</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;[id=&#39;</span><span class="o">+</span><span class="nx">key</span><span class="o">+</span><span class="s1">&#39;]&#39;</span><span class="p">).</span><span class="nx">removeClass</span><span class="p">(</span><span class="s1">&#39;on&#39;</span><span class="p">);</span>
  <span class="p">});</span>
  <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="pinsettingsend">
<h4>pinSettingSend()<a class="headerlink" href="#pinsettingsend" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p><code class="docutils literal"><span class="pre">Piscium</span></code>には、<code class="docutils literal"><span class="pre">(ip)/setConstellationName/status.json</span></code>にアクセスすることでピンごとに名前を設定する機能がある。
これで<code class="docutils literal"><span class="pre">(ip)/setPort/status.json?And=0</span></code>のように三文字コードをURLに使えるようになり、ユーザが見てもわかりやすい。</p>
<p><code class="docutils literal"><span class="pre">acrab_conf.json</span></code>が読み込まれた後のタイミングで実行される。
<code class="docutils literal"><span class="pre">port.(三文字コード).pin</span></code>の中身を順に取得して<code class="docutils literal"><span class="pre">getRequest()</span></code>に渡すという流れである。</p>
</div>
<div class="section" id="button">
<h4>buttonオブジェクト<a class="headerlink" href="#button" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p>メイン画面のボタンは、<strong>星座絵/投影機/全点(消)灯/グループ</strong>
の四種類ある。
それぞれに合った処理をするため、<code class="docutils literal"><span class="pre">button</span></code>オブジェクトを作成し必要なメソッドをまとめるようにした。</p>
<div class="section" id="button-constellation-obj">
<h5>星座絵: button.constellation(obj)<a class="headerlink" href="#button-constellation-obj" title="このヘッドラインへのパーマリンク">¶</a></h5>
<p>星座絵は南天か北天に分かれている。
南北は<code class="docutils literal"><span class="pre">port[(三文字コード)].box</span></code>から判定し、受信機のアドレスを<code class="docutils literal"><span class="pre">ip[(NかS)]</span></code>で取得する。</p>
<p>また、ボタンのオンオフ状態と逆の真偽値を<code class="docutils literal"><span class="pre">data</span></code>に入れておく。
後は<code class="docutils literal"><span class="pre">getRequest()</span></code>を呼んで終了する。</p>
<div class="highlight-js"><div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">address</span> <span class="o">=</span> <span class="nx">ip</span><span class="p">[</span><span class="nx">port</span><span class="p">[</span><span class="nx">obj</span><span class="p">.</span><span class="nx">id</span><span class="p">].</span><span class="nx">box</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;setPort/status.json&#39;</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="p">{}</span>
<span class="nx">data</span><span class="p">[</span><span class="nx">obj</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="nx">button</span><span class="p">.</span><span class="nx">stat</span><span class="p">(</span><span class="nx">obj</span><span class="p">);</span>
<span class="nx">getRequest</span><span class="p">(</span><span class="nx">address</span><span class="p">,</span> <span class="nx">data</span><span class="p">).</span><span class="nx">done</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">res</span><span class="p">){</span><span class="nx">checkStatus</span><span class="p">(</span><span class="nx">res</span><span class="p">)});</span>
<span class="k">return</span><span class="p">;</span>
</pre></div>
</div>
</div>
<div class="section" id="button-projector-obj">
<h5>投影機: button.projector(obj)<a class="headerlink" href="#button-projector-obj" title="このヘッドラインへのパーマリンク">¶</a></h5>
<p>星座絵以外の投影機は南北両方に付いているのが普通である。
そのため<strong>受信機の数だけ同じリクエストを送る</strong>必要がある。
<code class="docutils literal"><span class="pre">ip</span></code>の各要素について<code class="docutils literal"><span class="pre">$.each()</span></code>を回すことでこれを実現する。</p>
<div class="highlight-js"><div class="highlight"><pre><span></span><span class="nx">$</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">ip</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
  <span class="kd">var</span> <span class="nx">address</span> <span class="o">=</span> <span class="k">this</span> <span class="o">+</span> <span class="s1">&#39;setPort/status.json&#39;</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="p">{};</span>
  <span class="nx">data</span><span class="p">[</span><span class="nx">obj</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="nx">button</span><span class="p">.</span><span class="nx">stat</span><span class="p">(</span><span class="nx">obj</span><span class="p">);</span>
  <span class="nx">getRequest</span><span class="p">(</span><span class="nx">address</span><span class="p">,</span> <span class="nx">data</span><span class="p">).</span><span class="nx">done</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">res</span><span class="p">){</span><span class="nx">checkStatus</span><span class="p">(</span><span class="nx">res</span><span class="p">)});</span>
<span class="p">});</span>
<span class="k">return</span><span class="p">;</span>
</pre></div>
</div>
</div>
<div class="section" id="button-all-obj">
<h5>全点(消)灯: button.all(obj)<a class="headerlink" href="#button-all-obj" title="このヘッドラインへのパーマリンク">¶</a></h5>
<p><code class="docutils literal"><span class="pre">Piscium</span></code>側の全点灯(allSet)・全消灯(allClear)を使う場合。
コードは<code class="docutils literal"><span class="pre">button.projector(obj)</span></code>と似ているので省略。</p>
<p><code class="docutils literal"><span class="pre">Piscium</span></code>側の負荷の関係で、今のところ全点灯は使うべきでないようだ。</p>
</div>
<div class="section" id="button-group-obj">
<h5>グループ: button.group(obj)<a class="headerlink" href="#button-group-obj" title="このヘッドラインへのパーマリンク">¶</a></h5>
<p>「夏の大三角」「黄道十二星座」と言った星座のグループ。
実はこれが一番面倒である。
理由は<strong>各星座絵が南北にばらけていることがある</strong>ため。</p>
<p>そのため、</p>
<ol class="arabic simple">
<li><code class="docutils literal"><span class="pre">ip</span></code>からIPアドレスを取得してURLを作成</li>
<li><code class="docutils literal"><span class="pre">group[(三文字コード).value]</span></code>で<code class="docutils literal"><span class="pre">$.each()</span></code>を回し、南北判定していずれかの<code class="docutils literal"><span class="pre">data</span></code>に追加</li>
<li><code class="docutils literal"><span class="pre">req</span></code>オブジェクトに南北それぞれのデータを入れ、<code class="docutils literal"><span class="pre">getRequest()</span></code></li>
</ol>
<p>という手順を踏んでいる。</p>
<p>実は、本番前にさらに一段階手順を増やした。
星座絵を10個弱同時に点灯すると電源が不安定化する事象を確認したため、回避のため<strong>少数ずつ分けて点灯する</strong>よう変更したのである。
このため新たに<code class="docutils literal"><span class="pre">each_slice()</span></code>と<code class="docutils literal"><span class="pre">sleep_ms()</span></code>という関数を定義した。
これらの詳細は後述する。</p>
</div>
<div class="section" id="button-stat-obj">
<h5>ボタンの状態を取得する: button.stat(obj)<a class="headerlink" href="#button-stat-obj" title="このヘッドラインへのパーマリンク">¶</a></h5>
<p>ボタンがオンかオフかは、<code class="docutils literal"><span class="pre">on</span></code>クラスを持っているかどうかで分かる。
<code class="docutils literal"><span class="pre">stat()</span></code>にボタンのオブジェクトを渡すと、現在の状態の逆の値を返す。</p>
<div class="highlight-js"><div class="highlight"><pre><span></span><span class="k">return</span> <span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="nx">obj</span><span class="p">).</span><span class="nx">hasClass</span><span class="p">(</span><span class="s1">&#39;on&#39;</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="each-slice-obj-n">
<h4>each_slice(obj, n)<a class="headerlink" href="#each-slice-obj-n" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p>投影機を複数点灯・消灯する際一回あたりの数を抑えるのに使用する。
<code class="docutils literal"><span class="pre">obj</span></code>にオブジェクトを、<code class="docutils literal"><span class="pre">n</span></code>に最大数を指定すると<code class="docutils literal"><span class="pre">obj</span></code>をn要素ごとに切り分けたオブジェクトの配列を返す。</p>
<div class="highlight-js"><div class="highlight"><pre><span></span><span class="nx">each_slice</span><span class="p">({</span><span class="s2">&quot;Ari&quot;</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;Cnc&quot;</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;Gem&quot;</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;Leo&quot;</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;Aqr&quot;</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;Cap&quot;</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;Psc&quot;</span><span class="o">:</span><span class="mi">1</span><span class="p">},</span><span class="mi">3</span><span class="p">)</span>
<span class="o">-&gt;</span> <span class="p">[{</span><span class="s2">&quot;Ari&quot;</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;Cnc&quot;</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;Gem&quot;</span><span class="o">:</span><span class="mi">1</span><span class="p">},{</span><span class="s2">&quot;Leo&quot;</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;Aqr&quot;</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;Cap&quot;</span><span class="o">:</span><span class="mi">1</span><span class="p">},{</span><span class="s2">&quot;Psc&quot;</span><span class="o">:</span><span class="mi">1</span><span class="p">}]</span>
</pre></div>
</div>
<p>ただし、例外として&#8221;St1&#8221;と&#8221;St2&#8221;をキーにもつ場合は1要素のオブジェクトに分ける。
これは、こうとうの負荷があまりに大きいため他の投影機と同時に点灯することを避けるためである。</p>
<p>アルゴリズムとしては、n要素ずつ切ったものをfor文内でオブジェクトに追加していくだけなのでコードは省略する。</p>
</div>
<div class="section" id="sleep-ms-t">
<h4>sleep_ms(T)<a class="headerlink" href="#sleep-ms-t" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p><code class="docutils literal"><span class="pre">getRequest()</span></code>が<code class="docutils literal"><span class="pre">each_slice()</span></code>により複数回に別れる場合に、間隔を十分取るための関数。
これがマイコンならば<code class="docutils literal"><span class="pre">delay()</span></code>のような関数が標準で用意されるところだが、ブラウザにはそんなものはないので作るしかない。
下のコードを見れば分かるように、ひたすら時刻を取得して最初との差が<code class="docutils literal"><span class="pre">T</span></code>を超えたら抜けるという作戦になっている。</p>
<div class="highlight-js"><div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">d</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getTime</span><span class="p">();</span>
<span class="kd">var</span> <span class="nx">dd</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getTime</span><span class="p">();</span>
<span class="k">while</span><span class="p">(</span><span class="nx">dd</span> <span class="o">&lt;</span> <span class="nx">d</span><span class="o">+</span><span class="nx">T</span><span class="p">)</span> <span class="nx">dd</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getTime</span><span class="p">();</span>
</pre></div>
</div>
<p>遅らせる時間だが、100 msとした。
LEDの突入電流が流れる時間は数ms程度なので、十分大きくかつ人間には長すぎない程度と判断している。</p>
</div>
</div>
<div class="section" id="acrab-scenario-js">
<h3>acrab-scenario.js<a class="headerlink" href="#acrab-scenario-js" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>(執筆中)</p>
</div>
</div>
<div class="section" id="id10">
<h2>今後の展望<a class="headerlink" href="#id10" title="このヘッドラインへのパーマリンク">¶</a></h2>
<div class="section" id="id11">
<h3>既知の問題<a class="headerlink" href="#id11" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>(執筆中)</p>
</div>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../twinkle.html" class="btn btn-neutral float-right" title="またたき回路" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="piscium.html" class="btn btn-neutral" title="無線制御(PISCIUM)" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, Kenichi Ito.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'0.1',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>
      <script type="text/javascript" src="../_static/translations.js"></script>
      <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>